\documentclass[tikz]{standalone}
\usetikzlibrary{matrix,quotes}
\input{regression-test}
% For testing non-active &
\tikzset{ampersand replacement=\testunused}

\begin{document}
\START
\showoutput
\BEGINTEST{\pgfmatrix: Hello world!}
\begin{tikzpicture}
  \pgfmatrix{rectangle}{text}{mymatrix}{\pgfusepath{}}{\pgfpointanchor{b}{north}}{}
  {
    \draw (0,0) circle (1cm);  \pgfmatrixnextcell[1cm]
    \node (a) [draw] {Hallo};
    \\
    \node (b) [draw] {Welt};  & \draw (0,0) circle (5mm); \\
  }
\end{tikzpicture}
\ENDTEST

\BEGINTEST{Matrix of numbers and rectangles}
\begin{tikzpicture}[x=3mm,y=3mm,fill=blue!50]
  \def\atorig#1{\node[black] at (0,0) {\tiny #1};}
  \pgfmatrix{rectangle}{center}{mymatrix}
  {\pgfusepath{}}{\pgfpointorigin}{}
  {
    \fill (0,-3) rectangle (1,1);\atorig1
    \pgfmatrixnextcell
    \fill (-1,0) rectangle (1,1);\atorig2
    \pgfmatrixnextcell
    \fill (-1,-2) rectangle (0,0);\atorig3
    \pgfmatrixnextcell
    \fill (-1,-1) rectangle (0,3);\atorig4
    \\
    \fill (-1,0) rectangle (4,1);\atorig5
    \pgfmatrixnextcell
    \fill (0,-1) rectangle (1,1);\atorig6
    \pgfmatrixnextcell
    \fill (0,0) rectangle (1,4);\atorig7
    \pgfmatrixnextcell
    \fill (-1,-1) rectangle (0,0);\atorig8
    \\
  }
\end{tikzpicture}
\ENDTEST

\BEGINTEST{\pgfmatrixnextcell and \pgfmatrixendrow}
\begin{tikzpicture}
  \pgfmatrix{rectangle}{center}{mymatrix}
  {\pgfusepath{}}{\pgfpointorigin}{}
  {
    \node {a}; &                  \node {b}; \pgfmatrixendrow
    \node {c}; \pgfmatrixnextcell \node {d}; \pgfmatrixendrow
  }
\end{tikzpicture}
\ENDTEST

\BEGINTEST{\pgfmatrix: column separation}
\begin{tikzpicture}[every node/.style=draw]
  \pgfsetmatrixcolumnsep{1mm}
  \pgfmatrix{rectangle}{center}{mymatrix}
  {\pgfusepath{}}{\pgfpointorigin}{}
  {
    \node {8}; &[2mm] \node{1}; &[-1mm] \node {6}; \\
    \node {3}; &      \node{5}; &       \node {7}; \\
    \node {4}; &      \node{9}; &       \node {2}; \\
  }
\end{tikzpicture}
\ENDTEST

\BEGINTEST{\pgfmatrix: column separation "between origins"}
\begin{tikzpicture}[every node/.style=draw]
  \pgfsetmatrixcolumnsep{1mm}
  \pgfmatrix{rectangle}{center}{mymatrix}
  {\pgfusepath{}}{\pgfpointorigin}{}
  {
    \node {8}; &[2mm] \node(a){1}; &[1cm,between origins]
    \node(b){6}; \\
    \node {3}; &      \node   {5}; & \node   {7}; \\
    \node {4}; &      \node   {9}; & \node   {2}; \\
  }
  \draw [<->,red,thick,every node/.style=] (a.center) -- (b.center)
    node [above,midway] {11mm};
\end{tikzpicture}
\ENDTEST

\BEGINTEST{\pgfmatrix: column separation "between borders"}
\begin{tikzpicture}
  \begin{scope}[every node/.style=draw]
    \pgfsetmatrixcolumnsep{1cm,between origins}
    \pgfsetmatrixrowsep{.5cm}
    \pgfmatrix{rectangle}{center}{mymatrix}
    {\pgfusepath{}}{\pgfpointorigin}{}
    {
      \node (a) {8}; & \node (d) {100}; \\[.5cm,between borders]
      \node (g) {3}; & \node (b) {5}; &[between borders] \node (c) {70};
      \\
      \node (h) {4}; & \node {9}; & \node (e) {2}; & \node (f) {10}; \\
    }
  \end{scope}

  \path [<->,red,thick]
    (a.center) edge["10mm"] (d.center)
    (e.center) edge["10mm"] (f.center)
    (b.center -| d.east)   edge["10mm"] (c.west)
    (a.south)  edge["10mm"] (g.north)
    (g.center) edge["10mm"] (h.center);
\end{tikzpicture}
\ENDTEST

\BEGINTEST{\pgfmatrix: empty cell}
\begin{tikzpicture}
  \def\pgfmatrixemptycode{\node{empty};}
  \pgfmatrix{rectangle}{center}{mymatrix}
  {\pgfusepath{}}{\pgfpointorigin}{}
  {
    \node {a}; & & \node {b}; \\
    & \node{c}; & \node {d}; & \\
  }
\end{tikzpicture}
\ENDTEST

\BEGINTEST{\pgfmatrix: begin and end codes for cells}
\begin{tikzpicture}
  \def\pgfmatrixbegincode{\node[draw]\bgroup}
  \def\pgfmatrixendcode{\egroup;}
  \pgfmatrix{rectangle}{center}{mymatrix}
  {\pgfusepath{}}{\pgfpointorigin}{}
  {
    a & b & c \\
    d &   & e \\
  }
\end{tikzpicture}
\ENDTEST

\BEGINTEST{tikzmatrix: cell codes}
\begin{tikzpicture}
  [matrix of nodes/.style={
    execute at begin cell=\node\bgroup,
    execute at end cell=\egroup;,%
    execute at empty cell=\node{--};%
  }]
  \matrix [matrix of nodes]
  {
    8 & 1 &   \\
    3 &   & 7 \\
    &   & 2 \\
  };
\end{tikzpicture}
\ENDTEST

\BEGINTEST{tikzmatrix: column separation and long cell}
\begin{tikzpicture}[every node/.style=draw,
  execute at empty cell=\node{long text};]

  \matrix[column sep=1mm, rectangle, draw, name=mymatrix,
    matrix of nodes]
  {
    8 &[2mm] |[name=a]| 1 &[1cm,between origins] |[name=b]| 6 \\
    3 &                 5 &                                   \\
      &                 9 &                                 2 \\
  };
  \draw [<->,red,thick,every node/.style=] (a.center) -- (b.center)
    node [above,midway] {11mm};
\end{tikzpicture}
\ENDTEST

\BEGINTEST{tikzmatrix: nodes in empty cells}
\begin{tikzpicture}
  \matrix[matrix of nodes, nodes in empty cells,
  nodes={draw, anchor=center}]{
    1 & & 3 \\
    & 5 \\
  };
\end{tikzpicture}
\ENDTEST

\BEGINTEST{tikzmatrix: dynamic row and column separation}
\begin{tikzpicture}% bug #503: every odd row/.style={row sep=...}
  \matrix (m) [
        matrix of nodes, nodes={draw},
        every odd column/.style={green, column sep=5pt},
        every odd row/.style={red, row sep=5pt}]
  {
    a & a & a & a \\
    a & a & a & a \\
    a & a & a & a \\
    a & a & a & a \\
  };
\end{tikzpicture}
\ENDTEST

\BEGINTEST{tikzmatrix: matrices on path}
\begin{tikzpicture}[nodes={circle,draw}]
  \draw (0,0) to[bend left]
    node[matrix of nodes, column sep=2cm,
    matrix anchor=m-2-2.north](m) {1 & 2 \\[1ex] 3 & 4 \\} (10,0);
  \draw[->] (m-1-1)
    to[bend left, "a & b \\" {matrix of nodes, name=l}] (m-1-2);
  \draw[->] (l-1-2.south) -- (m.south west);
\end{tikzpicture}
\ENDTEST

\BEGINTEST{tikzmatrix: table in cell}
\begin{tikzpicture}
  \matrix[matrix of nodes]{
    \begin{tabular}[t]{cc}
      a & b \\
      c & d
    \end{tabular}
    & A \\
    B &
    \begin{tabular}[b]{cc}
      1 & 2 \\
      3 & 4
    \end{tabular}
    \\
  };
\end{tikzpicture}
\ENDTEST
\END
\end{document}
