% Copyright 2008 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header$

\usepgfmodule{datavisualization}


\tikzset{/tikz/data visualization/.is family,
  /tikz/data visualization/.unknown/.code={
    \let\tikz@dv@key\pgfkeyscurrentname% 
    \pgfkeys{/tikz/\tikz@dv@key/.try={#1}}%
    \ifpgfkeyssuccess%
    \else%
      \pgfkeys{/errors/unknown key={/tikz/data visualization/\tikz@dv@key}{#1}}%
    \fi%
  },
  /tikz/data visualization/data/.unknown/.code={%
    % Redirect to /pgf/data
    \let\tikz@dv@key\pgfkeyscurrentname% 
    \pgfkeys{/pgf/data/\tikz@dv@key/.try={#1}}%
    \ifpgfkeyssuccess%
    \else%
      \pgfkeys{/errors/unknown key={/pgf/data/\tikz@dv@key}{#1}}%
    \fi%
  }
}

\def\tikzdatavisualizationset{\pgfqkeys{/tikz/data visualization}}


% The main \datavisualization command
%
% This command must, as always, be given inside a tikz picture. It
% will add a data visualization to the picture; use "shift" option and
% friends to place the data visualization somewhere other than at the
% origin.
%
% The \datavisualization gets a set of options as (optional) argument,
% which can be used to setup the data visualization.
%
% Next comes a sequence of block, each introduced with a keyword.
%
% The data blocks.
%   Each such block starts with "data", followed by
%   optional arguments. The optional arguments may either specify an
%   external data source or the data may follow inline.
%
%   The options are executed for the path /pgf/data. The style
%   /tikz/every data is executed for each data, which can be useful to
%   generally set, say, a certain data format.
%
% The before/after survey/visualization blocks.
%   A block starting with "before survey", "after survey", "before
%   visualization" or "after visualization" may contain any code. It
%   will be executed at the time indicated by the block name.
%
% Examples:
%
% \datavisualization[schoolbook plot]
%   data [source=my_data_file.cvs,format=comma separated columns]
% ;
%
%  \datavisualization[schoolbook plot]
%    data [format=key value pairs]
%    {
%      x=0, y=0
%      x=1, y=1
%      x=2, y=4
%      x=3, y=9
%    };
%
%  \datavisualization[schoolbook plot]
%    data [format=function]
%    {
%      var x = [0:3];
%      func y = \value x*\value x;
%    }
%    after visualization
%    {
%      \draw (0,0) -- (3,3);
%    };
%
%  \datavisualization[schoolbook plot,
%                     every data/.style={format=comma separated columns}]
%    data [/data point/label=first experiment,source=file_1]
%    data [/data point/label=second experiment,source=file_2]
%    data [/data point/label=third experiment,source=file_3]
%    data [/data point/label=prediction,format=function]
%      { var x=[0,1]; func y = rand(\value x); }
%    ;

\def\tikz@lib@datavisualization{\pgfutil@ifnextchar[\tikz@lib@datavisualization@opt{\tikz@lib@datavisualization@opt[]}}%}

\def\tikz@lib@datavisualization@opt[#1]{%
  \begingroup%
    % Ok, first, start a new data visualization
    \pgfoonew \tikz@main@dv=new data visualization()%
    % Now setup some options
    \tikzdatavisualizationset{#1}%
    %
    \pgfset{/pgf/data/continue code=\tikz@lib@dv@parse@loop}%
    % Now enter parse loop
    \tikz@lib@dv@parse@loop
}

\def\tikz@lib@dv@parse@loop{%  
  \pgfutil@ifnextchar d\tikz@lib@dv@handle@data{%
    \pgfutil@ifnextchar a\tikz@lib@dv@handle@after{%
      \pgfutil@ifnextchar b\tikz@lib@dv@handle@before{%
        \pgfutil@ifnextchar ;{%
          \tikz@lib@dv@parse@end%
        }{%
          \PackageError{tikz}{Semicolon expected}{}%
          \endgroup%
        }%
      }%
    }%
  }%
}
\def\tikz@lib@dv@parse@end{%
    % Go!
    \tikz@main@dv.survey()%
    \tikz@main@dv.visualize()%
  \endgroup%
}

\def\tikz@lib@dv@handle@data data{\pgfdata}
\def\tikz@lib@dv@handle@before before{\pgfutil@ifnextchar s{\tikz@lib@dv@before@survey}{\tikz@lib@dv@before@visualization}}
\def\tikz@lib@dv@handle@after after{\pgfutil@ifnextchar s{\tikz@lib@dv@after@survey}{\tikz@lib@dv@after@visualization}}

\def\tikz@lib@dv@before@survey survey#1{\tikz@main@dv.before survey({{#1}})\tikz@lib@dv@parse@loop}
\def\tikz@lib@dv@after@survey survey#1{\tikz@main@dv.after survey({{#1}})\tikz@lib@dv@parse@loop}

\def\tikz@lib@dv@before@visualization visualization#1{\tikz@main@dv.before visualization({{#1}})\tikz@lib@dv@parse@loop}
\def\tikz@lib@dv@after@visualization visualization#1{\tikz@main@dv.after visualization({{#1}})\tikz@lib@dv@parse@loop}

\pgfset{/pgf/every data/.style={/tikz/every data/.try,/tikz/data visualization/every data/.try}}




%
% Object setup keys
%

% The following keys are used to create objects. They cannot be
% created "directly" because a certain option might wish to create an
% object, but later options may choose to configure the object when it
% is "too late". Because of this, the "queue object" takes a key name
% and some code and will execute this code exactly once after all
% other options of the \datavisualization command have been
% processed. The value of the macro \obj is then stored in <key>/obj.

\tikzdatavisualizationset{
  request object/.code=\tikz@dv@make@object#1,
}

\def\tikzdvval#1{\pgfkeysvalueof{/tikz/data visualization/#1}}

\def\tikz@dv@make@object{\pgfutil@ifnextchar[\tikz@dv@make@object@opt{\tikz@dv@make@object@opt[before survey]}}%}
\def\tikz@dv@make@object@opt[#1]#2#3#4#5{\tikz@dv@make@object@opt@[{#1}]{#2}{#3}#4{#5}\pgf@stop}%
\def\tikz@dv@make@object@opt@[#1]#2#3#4(#5)#6\pgf@stop{%
  \pgfkeysalso{#2/.initial=}%
  % Queue the object creation:
  \tikz@main@dv.#1(\tikz@lib@dv@possibly@create{#2}{#3}{#4}{#5}{#6})%
}

\def\tikz@lib@dv@possibly@create#1#2#3#4#5{%
  \pgfkeysgetvalue{#1}\tikz@temp%
  \ifx\tikz@temp\pgfutil@empty%
    #2%
    \pgfoonew\tikzdvobj=new #3(#4)%
    \tikzdvobj.default connects()%
    \pgfkeyslet{#1}\tikzdvobj%
    #5%
  \fi%
}%



%
%
% Inspectors
%
%
% An inspector inspects a given attribute. The inspector allows you to
% find things out about an attribute like the minimum and maximum
% values this attribute attains.

\tikzdatavisualizationset{
  request inspector/.style={
    request object={/tikz/data visualization/#1/interval}{}{interval(,)}{},
    request object={/tikz/data visualization/#1/inspector}
                   {\tikzdvval{#1/interval}.get handle(\tikz@dv@handle)}
                   {inspector(#1,\tikz@dv@handle)}{}
  }
}


%
%
% Simple axes
%
%

\tikzdatavisualizationset{%
  request axis/.style={
    request object=[after survey]{/tikz/data visualization/#1/line transformer}{}{line transformer(\tikzdvval{#1/source}/transformed,\tikzdvval{#1/vec})}{},
    request object=[after survey]{/tikz/data visualization/#1/attribute mapper}{}{attribute mapper(%
      \tikzdvval{#1/source},%
      \tikzdvval{#1/source min},%
      \tikzdvval{#1/source max},%
      \tikzdvval{#1/source}/transformed,%
      \tikzdvval{#1/out min},%
      \tikzdvval{#1/out max},%
      \tikzdvval{#1/function})}{},
    #1/source/.initial=#1,
    #1/source min/.initial=0,
    #1/source max/.initial=1,
    #1/out min/.initial=0,
    #1/out max/.initial=1,
    #1/function/.initial=,
    #1/vec/.initial=\pgfpoint{0mm}{1cm}
  }
}


%
%
% Simple plots
%
%

\tikzdatavisualizationset{
  school book plot/.style={
    /utils/exec={\tikz@main@dv.after
      survey({{
          \tikzdvval{x/interval}.get interval()
          \show\pgfdvmax
          \pgfkeyslet{/tikz/data visualization/x/source max}\pgfdvmax
        }})},
    request inspector=x,
    request axis=x,
    request axis=y,
    x/vec=\pgfqpoint{1cm}{0cm},
    y/vec=\pgfqpoint{0cm}{1cm},
    request object=[after survey]{/tikz/data visualization/plot}{}{plot handler visualizer(\pgfplothandlerlineto)}{}
  }
}       

\endinput
