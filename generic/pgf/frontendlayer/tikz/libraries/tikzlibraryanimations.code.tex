% Copyright 2015 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header$

\usepgfmodule{animations}



\def\tikzanimationsset{\pgfqkeys{/tikz/animations}}
\def\tikzanimationsanimatesset{\pgfqkeys{/tikz/animations/animates}}


% 
% The \animate command 
%

\def\tikz@animate#1{%
  \tikz@anim@do{#1}%
  \pgfaliasid{local previous animation}{g@animation}%
  \pgfgaliasid{previous animation}{g@animation}%
}

\def\tikz@anim@do#1{%
  {%
    \pgfkeys{/handlers/animates/.code=\expandafter\expandafter\expandafter\tikz@animates@handler\expandafter\expandafter\expandafter{\pgfkeyscurrentpath}{##1}}%
    \pgfkeys{/handlers/first char syntax=true}%
    \pgfkeyssetvalue{/handlers/first char syntax/the character <}{\tikz@anim@parse@time}%
    \def\tikz@anim@t{0}
    \gdef\tikz@anim@last@t{0}
    \tikzanimationsset{default animates,/tikz/every animate/.try,#1}%
    \tikz@anim@list%
  }%
}

\let\tikz@anim@list\pgfutil@empty


%
% Defines a new tikz animation
% 

\def\tikz@renew@anim#1#2#3{%
  % #1 = the name
  % #2 = the attribute
  % #3 = the whom
  % #4 = the options
  \expandafter\expandafter\expandafter\ifx\csname tikz@anim@conf@attr@#1\endcsname\relax%
    \expandafter\def\expandafter\tikz@anim@list\expandafter{\tikz@anim@list\tikz@anim@process{#1}}
    \expandafter\global\expandafter\let\csname tikz@anim@entries@#1\endcsname\pgfutil@empty%
  \fi%
  \expandafter\def\csname tikz@anim@conf@attr@#1\endcsname{#2}%
  \expandafter\def\csname tikz@anim@conf@whom@#1\endcsname{#3}%
}


\def\tikz@animates@handler#1#2{%
  \edef\tikz@anim@timeline@name{#1}%
  % Save the options
  \expandafter\def\expandafter\tikz@anim@macro@name\expandafter{\csname tikz@anim@opt@#1\endcsname}%
  \expandafter\ifx\tikz@anim@macro@name\relax%
    \expandafter\let\tikz@anim@macro@name\pgfutil@empty%
  \fi%
  \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@temp\expandafter\expandafter\expandafter{\tikz@anim@macro@name,#2}%
  \expandafter\let\tikz@anim@macro@name\tikz@temp%
  % Options saved
  \let\tikz@animates@attribute\pgfutil@empty%
  \let\tikz@animates@whom\pgfutil@empty%
  \def\tikz@animates@parser{simple}%
  {%
    \expandafter\expandafter\expandafter\tikzanimationsanimatesset\expandafter\expandafter\expandafter{\tikz@anim@macro@name}%
    % This will set the type key
    % Other keys are ignored here
    \global\let\tikz@animates@g@parser\tikz@animates@parser%
    \global\let\tikz@animates@g@attribute\tikz@animates@attribute%
    \global\let\tikz@animates@g@whom\tikz@animates@whom%
  }%
  \ifx\tikz@animates@g@parser\pgfutil@empty%
    \tikzerror{.../animates must pick a type}%
  \else%
    \edef\tikz@anim@timeline@name{#1}%
    \edef\tikz@temp{\noexpand\tikz@renew@anim{#1}{\tikz@animates@g@attribute}{\tikz@animates@g@whom}}%
    \tikz@temp%
    \edef\pgf@marshal{\noexpand\pgfkeys{#1/.code=\noexpand\tikz@anim@parser{#1}{\tikz@animates@g@parser}{####1}}}%
    \pgf@marshal%
  \fi%
  \global\let\tikz@animates@g@parser\relax%
  \global\let\tikz@animates@g@attribute\relax%
  \global\let\tikz@animates@g@whom\relax%
}



\tikzanimationsanimatesset{
  @attribute/.code=\def\tikz@animates@attribute{#1},
  @parser/.code=\def\tikz@animates@parser{#1},
  @type node/.initial=,
  @type scope/.initial=,
  @type path/.initial=,
  @type view/.initial=,
  @whom/.code=\expandafter\def\expandafter\tikz@animates@whom\expandafter{\tikz@animates@whom,#1},
  node/.style={@whom=node/{#1}},
  scope/.style={@whom=scope/{#1}},
  path/.style={@whom=path/{#1}},
  name/.forward to=/pgf/animation/name,
  freeze at end/.forward to=/pgf/animation/freeze at end,
  freeze/.style={freeze at end={#1}},
  restart/.forward to=/pgf/animation/restart,
  repeats/.forward to=/pgf/animation/repeats,
  repeats/.default=,
  add/.forward to=/pgf/animation/add,
  replace/.forward to=/pgf/animation/replace,
  speed/.forward to=/pgf/animation/speed,
  begin/.forward to=/pgf/animation/begin,
  end/.forward to=/pgf/animation/end,
  begin on/.forward to=/pgf/animation/begin on,
  end on/.forward to=/pgf/animation/end on,
  next/.style={begin on={end,of=local previous animation,delay=#1}},
  origin/.code=\tikz@anim@parse@origin{#1},
  paced/.forward to=/pgf/animation/paced,
  duration/.forward to=/pgf/animation/paced,
  unpaced/.forward to=/pgf/animation/unpaced,
  %
  visible/.style={@attribute=visible/},
  opacity/.style={@attribute=opacity/},
  fill opacity/.style={@attribute=fill opacity/},
  draw opacity/.style={@attribute=stroke opacity/},
  text opacity/.style={@attribute=fill opacity/{@type node=.text}},
  line width/.style={@attribute=line width/},
  fill/.style={@attribute=fill/{@type node=.background.path}},
  draw/.style={@attribute=stroke/{@type node=.background.path}},
  text/.style={@attribute=fill/{@type node=.text}},
  color/.style={@attribute={fill/{@type node=.background.path},stroke/{@type node=.background.path},fill/{@type node=.text}}},
  view/.style={@attribute=view/{@type scope=.view}},
  shift/.style={@attribute=translate/,@parser=shift,add},
  xshift/.style={@attribute=translate/,@parser=xshift,add},
  yshift/.style={@attribute=translate/,@parser=yshift,add},
  rotate/.style={@attribute=rotate/,add},
  scale/.style={@attribute=scale/,add},
  xskew/.style={@attribute=xskew/,add},
  yskew/.style={@attribute=yskew/,add},
  xslant/.style={@attribute=xskew/, @parser=slant,add},
  yslant/.style={@attribute=yskew/, @parser=slant,add},
  along/.style={@attribute=motion/, add},
  drive/.style={@attribute=motion/, /pgf/animation/rotate along=true, add},
  morph/.style={@attribute=softpath/{@type path=.path, @type node=.background.path}, @parser=path},
  % Along parser
  path/.code=\tikz@anim@along{#1}{\tikz@anim@timeline@name}
}
\let\tikz@anim@default@whom\pgfutil@empty


\tikzanimationsset{
  all/.code args={[#1]}{\tikzanimationsanimatesset{#1}}
}

% Default animates

\tikzanimationsset{
  @default whom/.store in=\tikz@anim@default@whom,
  default animates/.style={
    visible/animates={visible},
    opacity/animates={opacity},
    fill opacity/animates={fill opacity},
    draw opacity/animates={draw opacity},
    text opacity/animates={text opacity},
    line width/animates={line width},
    fill/animates={fill},
    draw/animates={draw},
    text/animates={text},
    view/animates={view},
    shift/animates={shift},
    xshift/animates={xshift},
    yshift/animates={yshift},
    rotate/animates={rotate},
    scale/animates={scale},
    xskew/animates={xskew},
    yskew/animates={yskew},
    xslant/animates={xslant},
    yslant/animates={yslant},
    morph/animates={morph},
    color/animates={color},
    drive/animates={drive},
    along/animates={along},
  }
}

\let\tikz@animates@whom\pgfutil@empty



% Timing keys

\pgfkeys{
  /tikz/animations/timing/.cd,
  t/.code=\pgfparsetime{#1}\let\tikz@anim@t\pgftimeresult\global\let\tikz@anim@last@t\tikz@anim@t,
  t+/.code=\pgfparsetime{#1+\tikz@anim@last@t}\let\tikz@anim@t\pgftimeresult\global\let\tikz@anim@last@t\tikz@anim@t,
  t +/.style={t+={#1}},
  entry control/.forward to=/pgf/animation/entry control,
  exit control/.forward to=/pgf/animation/exit control,
  stay/.forward to=/pgf/animation/stay,
  jump/.forward to=/pgf/animation/jump,
  ease/.style={
    entry control={1-(#1)}{1},
    exit control={#1}{0}
  },
  ease/.default=0.5,
  ease in/.style={
    entry control={1-(#1)}{1},
  },
  ease in/.default=0.5,
  ease out/.style={
    exit control={#1}{0},
  },
  ease out/.default=0.5,
  .unknown/.code={%
    \tikz@anim@time@unknown{\pgfkeyscurrentname}{#1}%
  }
}
\def\tikz@anim@time@unknown#1#2{%
  \ifx\pgfkeyscurrentvalue\pgfkeysnovalue@text%
    % Test, whether #1 "looks like a time"
    \expandafter\tikz@anim@time@test#1\pgf@stop%
  \else%
    \tikzerror{I do not know the timing key '#1' for which you said '#1=#2'}%
  \fi%
}
\def\tikz@anim@time@test#1#2\pgf@stop{%
  \edef\tikz@temp{\meaning#1}
  \ifx\tikz@temp\tikz@anim@plus@text%
    \tikz@anim@time@plusplus#2\pgf@stop%
  \else%
    \expandafter\ifx\csname tikz@anim@test@\tikz@temp\endcsname\relax%
      \tikzerror{I do not know the timing key '#1#2'}%
    \else%
      \pgfparsetime{#1#2}\let\tikz@anim@t\pgftimeresult\global\let\tikz@anim@last@t\tikz@anim@t%
    \fi%
  \fi%
}

\edef\tikz@anim@plus@text{\meaning+}

\def\tikz@anim@time@plusplus{\pgfutil@ifnextchar+{\tikz@anim@time@plusplus@}{\tikz@anim@time@no@plus}}

\def\tikz@anim@time@no@plus#1\pgf@stop{%
  \pgfparsetime{#1}\let\tikz@anim@t\pgftimeresult\global\let\tikz@anim@last@t\tikz@anim@t%
}

\def\tikz@anim@time@plusplus@+#1\pgf@stop{%
  \pgfparsetime{#1+\tikz@anim@last@t}\let\tikz@anim@t\pgftimeresult\global\let\tikz@anim@last@t\tikz@anim@t%
}

\expandafter\let\csname tikz@anim@test@the character 0\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 1\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 2\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 3\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 4\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 5\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 6\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 7\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 8\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 9\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character -\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character .\endcsname\pgfutil@empty

\def\tikz@anim@parse@origin#1{%
  \tikz@scan@one@point\tikz@anim@parse@origin@#1\relax%
}
\def\tikz@anim@parse@origin@#1{\pgfkeys{/pgf/animation/origin={#1}}}



\def\tikz@anim@process#1{%
  \expandafter\let\expandafter\tikz@anim@the@entries\csname tikz@anim@entries@#1\endcsname%
  \expandafter\global\expandafter\let\csname tikz@anim@entries@#1\endcsname\relax%
  \ifx\tikz@anim@the@entries\pgfutil@empty%
  \else%
    % Ok, do something
    {%
      \edef\tikz@whom@list{\csname tikz@anim@conf@whom@#1\endcsname}%
      \edef\tikz@attr@list{\csname tikz@anim@conf@attr@#1\endcsname}%
      \ifx\tikz@whom@list\pgfutil@empty%
        \let\tikz@whom@list\tikz@anim@default@whom%
      \fi%
      \foreach\tikz@animate@whom@type/\tikz@animate@whom@obj in\tikz@whom@list{%
        \ifx\tikz@animate@whom@type\pgfutil@empty\else%
          \foreach\tikz@animate@attr/\tikz@animate@types in\tikz@attr@list{%
            \expandafter\pgfanimateattributecode\expandafter{\tikz@animate@attr}{%
              \expandafter\expandafter\expandafter\tikzanimationsanimatesset\expandafter\expandafter\expandafter{\csname tikz@anim@opt@#1\endcsname}%
              \expandafter\tikzanimationsanimatesset\expandafter{\tikz@animate@types}%
              \tikz@anim@the@entries%
              \expandafter\pgfutil@in@\expandafter.\expandafter{\tikz@animate@whom@obj}%
              \ifpgfutil@in@%
              \else%
                \edef\tikz@animate@whom@obj{\tikz@animate@whom@obj\pgfkeysvalueof{/tikz/animations/animates/@type \tikz@animate@whom@type}}%
              \fi%
              \pgfanimationset{whom=\tikz@animate@whom@obj}%
            }%
          }%
        \fi%
      }%
    }%
  \fi%
}



% The parsers

\def\tikz@anim@parser#1#2#3{%
  \def\tikz@anim@parse@par@one{#1}%
  \def\tikz@anim@parse@par@two{#2}%
  \tikz@anim@parser@scan@start@opt#3<\pgf@stop%
}
\def\tikz@anim@parser@scan@start@opt{%
  \pgfutil@ifnextchar[\tikz@anim@parser@scan@start@with@opt{\tikz@anim@parser@scan@start<>}%
}
\def\tikz@anim@parser@scan@start@with@opt[#1]{%
  \pgfkeys{\tikz@anim@parse@par@one/animates={#1}}%
  \tikz@anim@parser@scan@start<>%
}

\def\tikz@anim@parser@scan@start<{%
  \pgfutil@ifnextchar\pgf@stop{\pgfutil@gobble}{\begingroup\tikz@anim@parser@times}%
}
\def\tikz@anim@parser@scan@another<{%
  \pgfutil@ifnextchar\pgf@stop{\endgroup\pgfutil@gobble}{\tikz@anim@parser@times}%
}

\def\tikz@anim@parser@times#1>{%
  \pgfkeys{/tikz/animations/timing/.cd,#1}%
  \pgfutil@ifnextchar<{\tikz@anim@parser@scan@another}{\tikz@anim@parser@scan@value}
}
  
\def\tikz@anim@parser@scan@value#1<{%
  \pgfkeys@spdef\tikz@anim@value{#1}%
  \expandafter\tikz@anim@parse@one\expandafter{\tikz@anim@value}%
  \endgroup%
  \tikz@anim@parser@scan@start<%
}

\def\tikz@anim@parse@one#1{%
  \def\tikz@temp{#1}%
  \ifx\tikz@temp\pgf@special@current@text%
    \let\tikz@anim@result\pgf@special@current@text%
  \else%
    \csname tikz@anim@\tikz@anim@parse@par@two @parse\endcsname{#1}%
  \fi%
  \expandafter\let\expandafter\tikz@temp\csname tikz@anim@entries@\tikz@anim@parse@par@one\endcsname%
  \edef\tikz@@temp{%
    \def\noexpand\pgf@anim@entry@spline{\pgf@anim@entry@spline}%
    \def\noexpand\pgf@anim@exit@spline{\pgf@anim@exit@spline}%
    \noexpand\pgf@anim@entry{\tikz@anim@t}%
  }%
  \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@@temp\expandafter\expandafter\expandafter{\expandafter\tikz@@temp\expandafter{\tikz@anim@result}}%
  \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@temp\expandafter\expandafter\expandafter{\expandafter\tikz@temp\tikz@@temp}%
  \expandafter\global\expandafter\let\csname tikz@anim@entries@\tikz@anim@parse@par@one\endcsname\tikz@temp%
}


\def\tikz@anim@simple@parse#1{\def\tikz@anim@result{#1}}

\def\tikz@anim@slant@parse#1{\pgfmathsetmacro\tikz@anim@result{atan(#1)}}

\def\tikz@anim@xshift@parse#1{\pgfmathparse{#1}\edef\tikz@anim@result{\noexpand\pgfqpoint{\pgfmathresult pt}{0pt}}}
\def\tikz@anim@yshift@parse#1{\pgfmathparse{#1}\edef\tikz@anim@result{\noexpand\pgfqpoint{0pt}{\pgfmathresult pt}}}

\def\tikz@anim@shift@parse#1{\tikz@scan@one@point\tikz@anim@do@shift#1}
\def\tikz@anim@do@shift#1{\def\tikz@anim@result{#1}}


\def\tikz@anim@view@parse#1{\tikz@anim@view@parse@#1\pgf@stop}%
\def\tikz@anim@view@parse@{%
  \pgfutil@ifnextchar({\tikz@scan@one@point\tikz@anim@view@parse@a}{\tikz@anim@view@node}%
}
\def\tikz@anim@view@parse@a#1{%
  \def\tikz@anim@result{{#1}}%
  \pgfutil@ifnextchar r{\tikz@anim@view@parsed@rec}{\tikz@scan@one@point\tikz@anim@view@parse@b}%
}
\def\tikz@anim@view@parsed@rec rectangle{\tikz@scan@one@point\tikz@anim@view@parse@b}%
\def\tikz@anim@view@parse@b#1{%
  \expandafter\def\expandafter\tikz@anim@result\expandafter{\tikz@anim@result{#1}}%
  \pgfutil@ifnextchar\pgf@stop\pgfutil@gobble{\tikzerror{Wrong view syntax}}%
}
\def\tikz@anim@view@node#1\pgf@stop{%
  \expandafter\ifx\csname pgf@sh@ns@#1\endcsname\relax%
    \tikzerror{Undefined node '#1'}%
  \else%
    % Compute a bounding box for the node:
    {%
      \pgf@process{\pgfpointanchor{#1}{west}}%
      \pgf@xa\pgf@x \pgf@ya\pgf@y
      \pgf@xb\pgf@x \pgf@yb\pgf@y
      \pgf@process{\pgfpointanchor{#1}{north}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%      
      \pgf@process{\pgfpointanchor{#1}{south}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%      
      \pgf@process{\pgfpointanchor{#1}{east}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%
      \xdef\tikz@anim@result{{\noexpand\pgfqpoint{\the\pgf@xa}{\the\pgf@ya}}{\noexpand\pgfqpoint{\the\pgf@xb}{\the\pgf@yb}}}
    }%
  \fi%
}

\def\tikz@anim@path@parse#1{%
  {%
    \setbox0=\hbox{{% protext against side effects
        \pgfinterruptpath%
        \pgf@relevantforpicturesizefalse%
        \expandafter\tikz@scan@next@command#1\pgf@stop%
        \pgfsyssoftpath@getcurrentpath\tikz@anim@result%
        \pgfprocessround{\tikz@anim@result}{\tikz@anim@result}%
        \global\let\tikz@anim@result\tikz@anim@result%
        \endpgfinterruptpath%
      }}%
  }%
}



% The special along parser

\def\tikz@anim@along#1#2{%
  % Parse the path...
  {%
    \setbox0=\hbox{{% protext against side effects
        \pgfinterruptpath%
        \pgf@relevantforpicturesizefalse%
        \tikz@scan@next@command#1\pgf@stop%
        \pgfsyssoftpath@getcurrentpath\tikz@anim@parsed@path%
        \pgfprocessround{\tikz@anim@parsed@path}{\tikz@anim@parsed@path}%
        \global\let\tikz@anim@parsed@path\tikz@anim@parsed@path%
        \endpgfinterruptpath%
      }}%
  }%
  \pgfanimationset{along softpath=\tikz@anim@parsed@path}%
  \expandafter\let\expandafter\tikz@temp\csname tikz@anim@entries@#2\endcsname%
  \expandafter\def\expandafter\tikz@temp\expandafter{\tikz@temp\relax}%
  \expandafter\global\expandafter\let\csname tikz@anim@entries@#2\endcsname\tikz@temp%
}


% Timing parser

\def\tikz@anim@parse@time#1{\begingroup\tikz@anim@parse@time@#1\pgf@stop\endgroup}

\def\tikz@anim@parse@time@<#1>{%
  \pgfkeys{/tikz/animations/timing/.cd,#1}%
  \pgfutil@ifnextchar<\tikz@anim@parse@time@\tikz@anim@parse@time@done%
}

\def\tikz@anim@parse@time@done#1\pgf@stop{%
  \pgfkeys{/tikz/animations/.cd,#1}%
}




\endinput

