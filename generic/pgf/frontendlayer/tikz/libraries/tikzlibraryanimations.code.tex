% Copyright 2015 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header$

\usepgfmodule{animations}



% 
% The \animate command 
%

\def\tikz@animate#1{%
  % First, go over the list and insert "animate=" before all entries
  % surrounded by braces
  {%
    \toks0={}%
    \tikz@anim@add@braces#1,\pgf@stop%
    \expandafter}%
  \expandafter\tikz@anim@do\expandafter{\the\toks0}%
  \pgfaliasid{previous}{g@animation}%
  \pgfgaliasid{previous globally}{g@animation}%
}
\def\tikz@anim@add@braces{%
  \pgfutil@ifnextchar\pgf@stop\pgfutil@gobble{%
    \pgfutil@ifnextchar\bgroup\tikz@anim@add@brace\tikz@anim@advace}}

\def\tikz@anim@advace#1,{%
  \toks0\expandafter{\the\toks0 #1,}%
  \tikz@anim@add@braces%
}
\def\tikz@anim@add@brace#1{%
  \toks0\expandafter{\the\toks0animate={#1},}%
  \pgfutil@ifnextchar,{\tikz@anim@add@braces@ok}{\tikzerror{Comma
      expected in animate options}}%
}
\def\tikz@anim@add@braces@ok,{\tikz@anim@add@braces}


\def\tikz@anim@do#1{%
  {%
    \pgfkeys{/tikz/animations/.cd,/tikz/every animate/.try,#1}%
    \tikz@animate@what%
  }%
}

\let\tikz@animate@whom\pgfutil@empty % A list of to-be-animated scopes
\let\tikz@animate@what\pgfutil@empty % A list of to-be-animated attributes

\pgfkeys{/tikz/animations/.cd,
  whom/.store in=\tikz@animate@whom,
  whom also/.code=\expandafter\def\expandafter\tikz@animate@whom\expandafter{\tikz@animate@whom,#1},
  node/.style={whom=[node]#1},
  node also/.style={whom also=[node]#1},
  scope/.style={whom=[scope]#1},
  scope also/.style={whom also=[scope]#1},
  path/.style={whom=[path]#1},
  path also/.style={whom also=[path]#1},
  name/.forward to=/pgf/animation/name,
  duration/.forward to=/pgf/animation/duration,
  duration/.value required,
  min duration/.forward to=/pgf/animation/min duration,
  max duration/.forward to=/pgf/animation/max duration,
  freeze at end/.forward to=/pgf/animation/freeze at end,
  freeze/.style={freeze at end={#1}},
  restart/.forward to=/pgf/animation/restart,
  repeats/.forward to=/pgf/animation/repeats,
  repeats/.default=,
  add/.forward to=/pgf/animation/add,
  begin/.forward to=/pgf/animation/begin,
  end/.forward to=/pgf/animation/end,
  begin on/.forward to=/pgf/animation/begin on,
  end on/.forward to=/pgf/animation/end on,
  next/.style={begin on={end,of=previous,delay=#1}},
  interpolation/.forward to=/pgf/animation/interpolation,
  key time/.forward to=/pgf/animation/key time,
  key progress/.forward to=/pgf/animation/key progress,
  key spline control/.forward to=/pgf/animation/key spline control,
  animate/.code=\tikz@animate{#1},
  origin/.code=\tikz@anim@parse@origin{#1},
}
\def\tikz@anim@parse@origin#1{%
  \tikz@scan@one@point\tikz@anim@parse@origin@#1\relax%
}
\def\tikz@anim@parse@origin@#1{\pgfkeys{/pgf/animation/origin={#1}}}

\def\tikz@anim@attr#1#2#3{%
  \expandafter\def\expandafter\tikz@animate@what\expandafter{\tikz@animate@what\tikz@animate@now{#1}{#1}{#2}{#3}}%
}
\def\tikz@anim@attr@alt#1#2#3#4{%
  \expandafter\def\expandafter\tikz@animate@what\expandafter{\tikz@animate@what\tikz@animate@now{#1}{#2}{#3}{#4}}%
}

\def\tikz@anim@along#1#2{%
  \expandafter\def\expandafter\tikz@animate@what\expandafter{\tikz@animate@what\tikz@animate@along@now{#1}{#2}}%
}



\def\tikz@anim@default@type#1#2#3{\expandafter\def\csname tikz@default@type@#1@#2\endcsname{#3}}

% For some attributes for some kinds of objects, one normally needs to
% add a specific type to the id. For instance, when you change the
% "text opacity" of a node "foo", you actually wish to change the "fill
% opacity" of "foo.text". The following mappings determine which kinds
% of mappings must be done.
\tikz@anim@default@type{softpath}{path}{.path}
\tikz@anim@default@type{softpath}{node}{.background.path}
\tikz@anim@default@type{fill}{node}{.background.path}
\tikz@anim@default@type{draw}{node}{.background.path}
\tikz@anim@default@type{text}{node}{.text}
\tikz@anim@default@type{text opacity}{node}{.text}
\tikz@anim@default@type{view}{scope}{.view}

\pgfkeys{/tikz/animations/.cd,
  visible/.code=\tikz@anim@attr{visible}{\tikz@anim@simple@parse}{#1},
  visible/.default=true,
  opacity/.code=\tikz@anim@attr{opacity}{\tikz@anim@simple@parse}{#1},
  opacity +/.style={opacity={change by #1}},
  fill opacity/.code=\tikz@anim@attr{fill opacity}{\tikz@anim@simple@parse}{#1},
  fill opacity +/.style={fill opacity={change by #1}},
  draw opacity/.code=\tikz@anim@attr{stroke opacity}{\tikz@anim@simple@parse}{#1},
  draw opacity +/.style={stroke opacity={change by #1}},
  text opacity/.code=\tikz@anim@attr@alt{fill opacity}{text opacity}{\tikz@anim@simple@parse}{#1},
  text opacity +/.style={text opacity={change by #1}},
  line width/.code=\tikz@anim@attr{line width}{\tikz@anim@simple@parse}{#1},
  line width +/.style={line width={change by #1}},
  fill/.code=\tikz@anim@attr{fill}{\tikz@anim@simple@parse}{#1},
  fill +/.style={fill={change by #1}},
  draw/.code=\tikz@anim@attr{draw}{\tikz@anim@simple@parse}{#1},
  draw +/.style={draw={change by #1}},
  text/.code=\tikz@anim@attr@alt{fill}{text}{\tikz@anim@simple@parse}{#1},
  text +/.style={text={change by #1}},
  view/.code=\tikz@anim@attr{view}{\tikz@anim@view@parse}{#1},
  view +/.code={view={change by #1}},
  color/.style={fill={#1},draw={#1},text={#1}},
  color +/.style={fill +={#1}, draw +={#1}, text +={#1}},
  shift/.code=\tikz@anim@attr{translate}{\tikz@anim@shift@parse}{#1},
  shift +/.code={shift={change by #1}},
  rotate/.code=\tikz@anim@attr{rotate}{\tikz@anim@simple@parse}{#1},
  rotate +/.code={rotate={change by #1}},
  scale/.code=\tikz@anim@attr{scale}{\tikz@anim@simple@parse}{#1},
  scale +/.style={scale={change by #1}},
  xskew/.code=\tikz@anim@attr{xskew}{\tikz@anim@simple@parse}{#1},
  xskew +/.style={xskew={change by #1}},
  yskew/.code=\tikz@anim@attr{yskew}{\tikz@anim@simple@parse}{#1},
  yskew +/.style={yskew={change by #1}},
  xslant/.code=\tikz@anim@attr{xskew}{\tikz@anim@simple@parse}{atan(#1)},
  xslant +/.style={xskew={change by #1}},
  yslant/.code=\tikz@anim@attr{yskew}{\tikz@anim@simple@parse}{atan(#1)},
  yslant +/.style={yskew={change by #1}},
  move along/.code=\tikz@anim@along{#1}{},
  drive along/.code=\tikz@anim@along{#1}{rotate along=true},
  morph/.code=\tikz@anim@attr{softpath}{\tikz@anim@path@parse}{#1},
}

% The parsers:
\def\tikz@anim@simple@parse#1{\def\tikz@anim@result{#1}}

\def\tikz@anim@shift@parse#1{\tikz@scan@one@point\tikz@anim@do@shift#1}
\def\tikz@anim@do@shift#1{\def\tikz@anim@result{#1}}


\def\tikz@anim@view@parse#1{\tikz@anim@view@parse@#1\pgf@stop}%
\def\tikz@anim@view@parse@{%
  \pgfutil@ifnextchar({\tikz@scan@one@point\tikz@anim@view@parse@a}{\tikz@anim@view@node}%
}
\def\tikz@anim@view@parse@a#1{%
  \def\tikz@anim@result{{#1}}%
  \pgfutil@ifnextchar r{\tikz@anim@view@parsed@rec}{\tikz@scan@one@point\tikz@anim@view@parse@b}%
}
\def\tikz@anim@view@parsed@rec rectangle{\tikz@scan@one@point\tikz@anim@view@parse@b}%
\def\tikz@anim@view@parse@b#1{%
  \expandafter\def\expandafter\tikz@anim@result\expandafter{\tikz@anim@result{#1}}%
  \pgfutil@ifnextchar\pgf@stop\pgfutil@gobble{\tikzerror{Wrong view syntax}}%
}
\def\tikz@anim@view@node#1\pgf@stop{%
  \expandafter\ifx\csname pgf@sh@ns@#1\endcsname\relax%
    \tikzerror{Undefined node '#1'}%
  \else%
    % Compute a bounding box for the node:
    {%
      \pgf@process{\pgfpointanchor{#1}{west}}%
      \pgf@xa\pgf@x \pgf@ya\pgf@y
      \pgf@xb\pgf@x \pgf@yb\pgf@y
      \pgf@process{\pgfpointanchor{#1}{north}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%      
      \pgf@process{\pgfpointanchor{#1}{south}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%      
      \pgf@process{\pgfpointanchor{#1}{east}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%
      \xdef\tikz@anim@result{{\noexpand\pgfqpoint{\the\pgf@xa}{\the\pgf@ya}}{\noexpand\pgfqpoint{\the\pgf@xb}{\the\pgf@yb}}}
    }%
  \fi%
}

\def\tikz@anim@path@parse#1{%
  {%
    \setbox0=\hbox{{% protext against side effects
        \pgfinterruptpath%
        \pgf@relevantforpicturesizefalse%
        \expandafter\tikz@scan@next@command#1\pgf@stop%
        \pgfsyssoftpath@getcurrentpath\tikz@anim@result%
        \global\let\tikz@anim@result\tikz@anim@result%
        \endpgfinterruptpath%
      }}%
  }%
}


% The main work function:

\def\tikz@animate@now#1#2#3#4{%
  {%
    \let\tikz@anim@now@options\pgfutil@empty%
    \let\tikz@anim@parser#3%
    \c@pgf@counta=0\relax%
    \pgfutil@ifnextchar\foreach\tikz@anim@foreach@parse\tikz@anim@general@parse#4...\pgf@stop%
    \def\tikz@anim@caller{\pgfanimateattribute{#1}}%
    \def\tikz@anim@attribute{#2}%
    \tikz@animate@now@%
  }%
}

\def\tikz@softpathtext{softpath}
\def\tikz@animate@now@{%
  \ifx\tikz@animate@whom\pgfutil@empty%
    \tikzerror{Animations must specify a ``whom''}%
  \else%
    \foreach\tikz@animate@one@whom in\tikz@animate@whom{%
      \ifx\tikz@animate@one@whom\pgfutil@empty\else%
        \expandafter\tikz@anim@decomp@whom\tikz@animate@one@whom\pgf@stop%
        \expandafter\pgfutil@in@\expandafter.\expandafter{\tikz@anim@whom@obj}%
        \let\tikz@temp@type\pgfutil@empty%
        \ifpgfutil@in@%
        \else%
          \expandafter\let\expandafter\tikz@temp@type\csname tikz@default@type@\tikz@anim@attribute @\tikz@anim@whom@kind\endcsname%
          \ifx\tikz@temp@type\relax%
            \let\tikz@temp@type\pgfutil@empty%
          \fi%
        \fi%
        \def\tikz@temp{,whom=\tikz@anim@whom@obj\tikz@temp@type}%
        \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@now@one@options\expandafter\expandafter\expandafter{\expandafter\tikz@anim@now@options\tikz@temp}%
        \expandafter\tikz@anim@caller\expandafter{\tikz@anim@now@one@options}%
      \fi%
    }%
  \fi%
}
\def\tikz@anim@decomp@whom{\pgfutil@ifnextchar[\tikz@anim@decomp@whom@opt{\tikz@anim@decomp@whom@opt[]}}
\def\tikz@anim@decomp@whom@opt[#1]{%
  \def\tikz@anim@whom@kind{#1}%
  \pgfutil@ifnextchar x\tikz@anim@whom@scan\tikz@anim@whom@scan}% get rid of spaces
\def\tikz@anim@whom@scan#1\pgf@stop{%
  \def\tikz@anim@whom@obj{#1}%
}


% The specail along parser

\def\tikz@animate@along@now#1#2{%
  {%
    \def\tikz@anim@now@options{#2,along softpath=}%
    \def\tikz@anim@caller{\pgfanimateattribute{motion}}%
    \def\tikz@anim@attribute{motion}%
    % Parse the path...
    {%
      \setbox0=\hbox{{% protext against side effects
          \pgfinterruptpath%
            \pgf@relevantforpicturesizefalse%
            \pgftransformreset%
            \tikz@scan@next@command#1\pgf@stop%
            \pgfsyssoftpath@getcurrentpath\tikz@anim@parsed@path%
            \global\let\tikz@anim@parsed@path\tikz@anim@parsed@path%
          \endpgfinterruptpath%
        }}%
    }%
    \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@now@options\expandafter\expandafter\expandafter{\expandafter\tikz@anim@now@options\expandafter{\tikz@anim@parsed@path}}%
    \tikz@animate@now@%    
  }
}


% The parser

\def\tikz@anim@foreach@parse\foreach#1in{\pgfutil@ifnextchar\bgroup{\tikz@anim@foreach@parse@group{#1}}{\tikz@anim@foreach@parse@single{#1}}}
\def\tikz@anim@foreach@parse@group#1#2{\pgfutil@ifnextchar x{\tikz@anim@foreach@parse@main{#1}{{#2}}}{\tikz@anim@foreach@parse@main{#1}{{#2}}}}
\def\tikz@anim@foreach@parse@single#1#2{\pgfutil@ifnextchar x{\tikz@anim@foreach@parse@main{#1}{#2}}{\tikz@anim@foreach@parse@main{#1}{#2}}}
\def\tikz@anim@foreach@parse@main#1#2#3...\pgf@stop{%
  {%
    \foreach#1in#2{%
      \tikz@anim@parser{#3}%
      \tikz@anim@add@to@now@options{value}%
      \global\let\tikz@anim@now@options\tikz@anim@now@options%
    }%
  }%    
}

\def\tikz@anim@general@parse{\pgfutil@ifnextchar\pgf@stop\tikz@anim@general@done\tikz@anim@general@next}
\def\tikz@anim@general@next#1...{%
  \advance\c@pgf@counta by1\relax%
  \expandafter\def\csname tikz@anim@vals@\the\c@pgf@counta\endcsname{#1}%
  \tikz@anim@general@parse%
}
\def\tikz@anim@general@done\pgf@stop{%
  \ifnum\c@pgf@counta=1\relax%
    \expandafter\expandafter\expandafter\tikz@anim@handle@one\expandafter\expandafter\expandafter{\csname tikz@anim@vals@1\endcsname}%
  \else%   
    \ifnum\c@pgf@counta=2\relax%
      \expandafter\ifx\csname tikz@anim@vals@1\endcsname\pgfutil@empty%
        \tikz@anim@handle@two@special%
      \else%
        \tikz@anim@handle@many%
      \fi%
    \else%
      \tikz@anim@handle@many%
    \fi%
  \fi%    
}
\def\tikz@anim@handle@many{%
  \c@pgf@countb=0\relax%
  \pgfutil@loop%
  \ifnum\c@pgf@counta>\c@pgf@countb\relax%
    \advance\c@pgf@countb by 1\relax
    \expandafter\expandafter\expandafter\tikz@anim@parser\expandafter\expandafter\expandafter{\csname tikz@anim@vals@\the\c@pgf@countb\endcsname}%
    \tikz@anim@add@to@now@options{value}%
  \pgfutil@repeat%
}
\def\tikz@anim@add@to@now@options#1{%
  \def\tikz@anim@temp{,#1=}%
  \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@now@options\expandafter\expandafter\expandafter{\expandafter\tikz@anim@now@options\tikz@anim@temp}%
  \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@now@options\expandafter\expandafter\expandafter{\expandafter\tikz@anim@now@options\expandafter{\tikz@anim@result}}%
}

\def\tikz@anim@handle@one#1{%
  \pgfutil@in@{\pgf@stop change by}{\pgf@stop#1}%
  \ifpgfutil@in@%
    \tikz@anim@handle@one@by#1\pgf@stop%
  \else%
    \tikz@anim@parser{#1}
    \tikz@anim@add@to@now@options{to}%
  \fi%
}
\def\tikz@anim@handle@one@by change by#1\pgf@stop{%
  \tikz@anim@parser{#1}
  \tikz@anim@add@to@now@options{by}%
}

\def\tikz@anim@handle@two@special{%
  \expandafter\expandafter\expandafter\tikz@anim@parser\expandafter\expandafter\expandafter{\csname tikz@anim@vals@\the\c@pgf@countb\endcsname}%
  \tikz@anim@add@to@now@options{to}%
}


% 
% Handling durations directly 
% 
% Syntax: Whenever an unknown key starts with a digit or a - or . or -.
% followed by a digit, then assume that a time is meant


\pgfkeys{/tikz/animations/.unknown/.code=%
  \let\tikz@anim@key\pgfkeyscurrentname%
  \def\tikz@anim@value{#1}%
  \expandafter\tikz@anim@test@time\tikz@anim@key xxx\pgf@stop%
}

\def\tikz@anim@test@time#1#2\pgf@stop{%
  \def\tikz@anim@temp{#1}%
  \ifx\tikz@anim@temp\tikz@dottext%
    \tikz@anim@test@time@dot#2\pgf@stop%
  \else%
    \tikz@anim@test@digit{#1}%
  \fi%
}
\def\tikz@anim@test@time@dot#1#2\pgf@stop{\tikz@anim@test@digit{#1}}
\def\tikz@dottext{.}
\def\tikz@anim@test@digit#1{%
  \expandafter\ifx\csname tikz@anim@digit@#1\endcsname\relax%
    \def\tikz@anim@prefix{/tikz/animations/}%
    \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@prefix\expandafter\expandafter\expandafter{\expandafter\expandafter\expandafter{\expandafter\tikz@anim@prefix\tikz@anim@key}}%
    \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@prefix\expandafter\expandafter\expandafter{\expandafter\tikz@anim@prefix\expandafter{\tikz@anim@value}}%
    \pgfkeys{/errors/unknown key/.expand once=\tikz@anim@prefix}%
  \else%
    \pgfanimationset{duration/.expand once=\tikz@anim@key}%
  \fi%
}
\expandafter\let\csname tikz@anim@digit@0\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@1\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@2\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@3\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@4\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@5\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@6\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@7\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@8\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@9\endcsname\pgfutil@empty


\endinput
