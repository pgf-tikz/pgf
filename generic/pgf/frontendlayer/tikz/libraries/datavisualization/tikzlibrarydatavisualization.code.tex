% Copyright 2008 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header$

\usepgfmodule{datavisualization}


\tikzset{/tikz/data visualization/.is family,
  /tikz/data visualization/.unknown/.code={
    \let\tikz@dv@key\pgfkeyscurrentname% 
    \pgfkeys{/tikz/\tikz@dv@key/.try={#1}}%
    \ifpgfkeyssuccess%
    \else%
      \pgfkeys{/errors/unknown key={/tikz/data visualization/\tikz@dv@key}{#1}}%
    \fi%
  },
  /tikz/data visualization/data/.unknown/.code={%
    % Redirect to /pgf/data
    \let\tikz@dv@key\pgfkeyscurrentname% 
    \pgfkeys{/pgf/data/\tikz@dv@key/.try={#1}}%
    \ifpgfkeyssuccess%
    \else%
      \pgfkeys{/errors/unknown key={/pgf/data/\tikz@dv@key}{#1}}%
    \fi%
  }
}

\def\tikzdatavisualizationset{\pgfqkeys{/tikz/data visualization}}


% The main \datavisualization command
%
% This command must, as always, be given inside a tikz picture. It
% will add a data visualization to the picture; use "shift" option and
% friends to place the data visualization somewhere other than at the
% origin.
%
% The \datavisualization gets a set of options as (optional) argument,
% which can be used to setup the data visualization.
%
% Next comes a sequence of block, each introduced with a keyword.
%
% The data blocks.
%   Each such block starts with "data", followed by
%   optional arguments. The optional arguments may either specify an
%   external data source or the data may follow inline.
%
%   The options are executed for the path /pgf/data. The style
%   /tikz/every data is executed for each data, which can be useful to
%   generally set, say, a certain data format.
%
% The before/after survey/visualization blocks.
%   A block starting with "before survey", "after survey", "before
%   visualization" or "after visualization" may contain any code. It
%   will be executed at the time indicated by the block name.
%
% Examples:
%
% \datavisualization[schoolbook plot]
%   data [source=my_data_file.cvs,format=comma separated columns]
% ;
%
%  \datavisualization[schoolbook plot]
%    data [format=key value pairs]
%    {
%      x=0, y=0
%      x=1, y=1
%      x=2, y=4
%      x=3, y=9
%    };
%
%  \datavisualization[schoolbook plot]
%    data [format=function]
%    {
%      var x: interval [0:3];
%      func y = \value x*\value x;
%    }
%    after visualization
%    {
%      \draw (0,0) -- (3,3);
%    };
%
%  \datavisualization[schoolbook plot,
%                     every data/.style={format=comma separated columns}]
%    data [/data point/label=first experiment,source=file_1]
%    data [/data point/label=second experiment,source=file_2]
%    data [/data point/label=third experiment,source=file_3]
%    data [/data point/label=prediction,format=function]
%      { var x: interval [0,1]; func y = rand(\value x); }
%    ;

\def\tikz@lib@datavisualization{\pgfutil@ifnextchar[\tikz@lib@datavisualization@opt{\tikz@lib@datavisualization@opt[]}}%}

\def\tikz@lib@datavisualization@opt[#1]{%
  \begingroup%
    % Ok, first, start a new data visualization
    \pgfoonew \tikz@main@dv=new data visualization()%
    % Now setup some options
    \tikzdatavisualizationset{#1}%
    %
    \pgfset{/pgf/data/continue code=\tikz@lib@dv@parse@loop}%
    % Now enter parse loop
    \tikz@lib@dv@parse@loop
}

\def\tikz@lib@dv@parse@loop{%  
  \pgfutil@ifnextchar d\tikz@lib@dv@handle@data{%
    \pgfutil@ifnextchar a\tikz@lib@dv@handle@after{%
      \pgfutil@ifnextchar b\tikz@lib@dv@handle@before{%
        \pgfutil@ifnextchar ;\tikz@lib@dv@parse@end{%
          \pgfutil@ifnextchar \par\tikz@lib@dv@handle@par{%
            \pgfutil@ifnextchar s\tikz@lib@dv@handle@beginscope{%
              \pgfutil@ifnextchar \egroup\tikz@lib@dv@handle@endscope{%
                \PackageError{tikz}{Semicolon expected}{}%
                \endgroup%
              }%
            }%
          }%
        }%
      }%
    }%
  }%
}
\def\tikz@lib@dv@parse@end{%
    % Go!
    \tikz@main@dv.survey()%
    \tikz@main@dv.visualize()%
  \endgroup%
}
\def\tikz@lib@dv@handle@par\par{\tikz@lib@dv@parse@loop}

\def\tikz@lib@dv@handle@beginscope scope{%
  \begingroup%
    \pgfutil@ifnextchar[\tikz@lib@dv@beg@opt{\tikz@lib@dv@beg@opt[]}%}
}
\def\tikz@lib@dv@beg@opt[#1]{%
  \pgfkeys{/pgf/data/.cd,/pgf/every data/.try,#1}%
  \pgfkeysvalueof{/pgf/data visualization/obj}.add data({{\begingroup\pgfkeys{/pgf/data/.cd,/pgf/every data/.try,#1}}})%
  \pgfutil@ifnextchar\bgroup{
    \afterassignment\tikz@lib@dv@parse@loop%
    \let\tikz@dummy=%get rid of \bgroup
  }{%
    \PackageError{pgf}{Opening brace expected}{}%
  }%
}
\def\tikz@lib@dv@handle@endscope{%
    \pgfkeysvalueof{/pgf/data visualization/obj}.add data(\endgroup)%
  \endgroup%
  \afterassignment\tikz@lib@dv@parse@loop%
  \let\tikz@dummy=%get rid of \egroup
}

\def\tikz@lib@dv@handle@data data{\pgfdata}
\def\tikz@lib@dv@handle@before before{\pgfutil@ifnextchar s{\tikz@lib@dv@before@survey}{\tikz@lib@dv@before@visualization}}
\def\tikz@lib@dv@handle@after after{\pgfutil@ifnextchar s{\tikz@lib@dv@after@survey}{\tikz@lib@dv@after@visualization}}

\def\tikz@lib@dv@before@survey survey#1{\tikz@main@dv.before survey({{#1}})\tikz@lib@dv@parse@loop}
\def\tikz@lib@dv@after@survey survey#1{\tikz@main@dv.after survey({{#1}})\tikz@lib@dv@parse@loop}

\def\tikz@lib@dv@before@visualization visualization#1{\tikz@main@dv.before visualization({{#1}})\tikz@lib@dv@parse@loop}
\def\tikz@lib@dv@after@visualization visualization#1{\tikz@main@dv.after visualization({{#1}})\tikz@lib@dv@parse@loop}

\pgfset{/pgf/every data/.style={/tikz/every data/.try,/tikz/data visualization/every data/.try}}






%
% Object setup 
%

% The following key is used to create objects for the rendering
% pipeline. They cannot be created "directly" because when it is known
% that the objects needs to be created, in principle, many keys may
% not yet be known.
%
% The following options are used:
%
% store           = key that will store the object (handle)
% class           = class of the object
% arg1            = argument1 of the constructor
% ...
% arg8            = argument8 of the constructor
% when            = specifies when the object will be created. Defaults to
%                   "before survey", other possible values are "after survey" and
%                   "before/after visualization"
% before creation = code to be executed just before the object is
%                   created
% after creation  = code to be executed just after the object has been created
%
% The following styles may be useful:
%
% arg1 from key        = use the contents of the given key as arg1. Similar
%                        for other args          
% arg1 handle from key = the contents of the given key should contain
%                        an object. Then arg1 will be a handle to this
%                        object. Similar for other args          

\tikzdatavisualizationset{%
  new object/.code={%
    \def\tikz@dv@grabbed@when{before survey}%
    \pgfkeys{/tikz/data visualization/new object/grab/.cd,#1}%
    \pgfkeyslet{\tikz@dv@grabbed@store}\pgfutil@empty%
    \edef\tikz@marshal{\noexpand\tikz@main@dv.\tikz@dv@grabbed@when(\noexpand\tikz@dv@newobject{\tikz@dv@grabbed@store}}%
    \tikz@marshal{#1})%
  },
  new object/grab/store/.store in=\tikz@dv@grabbed@store,
  new object/grab/when/.store in=\tikz@dv@grabbed@when,
  new object/grab/.unknown/.code={},%ignore
}

\def\tikz@dv@newobject#1#2{%
  \pgfkeysgetvalue{#1}\tikz@temp%
  \ifx\tikz@temp\pgfutil@empty%
    \let\tikz@dv@arg@a=\tikz@lib@notused%
    \let\tikz@dv@arg@b=\tikz@lib@notused%
    \let\tikz@dv@arg@c=\tikz@lib@notused%
    \let\tikz@dv@arg@d=\tikz@lib@notused%
    \let\tikz@dv@arg@e=\tikz@lib@notused%
    \let\tikz@dv@arg@f=\tikz@lib@notused%
    \let\tikz@dv@arg@g=\tikz@lib@notused%
    \let\tikz@dv@arg@h=\tikz@lib@notused%
    \let\tikz@dv@new@after=\relax%
    \pgfkeys{/tikz/data visualization/new object/parse/.cd,#2}
    \edef\pgf@marshal{\noexpand\pgfoonew\noexpand\tikzdvobj=new \tikz@dv@new@class(}%
    \tikz@dv@add@arg{}\tikz@dv@arg@a%
    \tikz@dv@add@arg{\expandafter,}\tikz@dv@arg@b%
    \tikz@dv@add@arg{\expandafter,}\tikz@dv@arg@c%
    \tikz@dv@add@arg{\expandafter,}\tikz@dv@arg@d%
    \tikz@dv@add@arg{\expandafter,}\tikz@dv@arg@e%
    \tikz@dv@add@arg{\expandafter,}\tikz@dv@arg@f%
    \tikz@dv@add@arg{\expandafter,}\tikz@dv@arg@g%
    \tikz@dv@add@arg{\expandafter,}\tikz@dv@arg@h%
    \expandafter\def\expandafter\pgf@marshal\expandafter{\pgf@marshal)}%
    \pgf@marshal%
    \tikzdvobj.default connects()%
    \pgfkeyslet{#1}\tikzdvobj%
    \tikz@dv@new@after%
  \fi%
}       
\def\tikz@lib@notused{\tikz@lib@notused}

\def\tikz@dv@add@arg#1#2{%
  \ifx#2\tikz@lib@notused%
  \else%
    \expandafter\expandafter\expandafter\def%
    \expandafter\expandafter\expandafter\pgf@marshal%
    \expandafter\expandafter\expandafter{\expandafter\pgf@marshal#1#2}%
  \fi%
}

\tikzdatavisualizationset{%
  new object/parse/.cd,
  store/.code=,% ignore
  when/.code=,% ignore
  class/.store in=\tikz@dv@new@class,
  before creation/.code=#1,
  after creation/.store in=\tikz@dv@new@after,
  arg1/.store in=\tikz@dv@arg@a,
  arg2/.store in=\tikz@dv@arg@b,
  arg3/.store in=\tikz@dv@arg@c,
  arg4/.store in=\tikz@dv@arg@d,
  arg5/.store in=\tikz@dv@arg@e,
  arg6/.store in=\tikz@dv@arg@f,
  arg7/.store in=\tikz@dv@arg@g,
  arg8/.store in=\tikz@dv@arg@h,
  arg1 from key/.code=\pgfkeysgetvalue{/tikz/data visualization/#1}{\tikz@dv@arg@a},
  arg2 from key/.code=\pgfkeysgetvalue{/tikz/data visualization/#1}{\tikz@dv@arg@b},
  arg3 from key/.code=\pgfkeysgetvalue{/tikz/data visualization/#1}{\tikz@dv@arg@c},
  arg4 from key/.code=\pgfkeysgetvalue{/tikz/data visualization/#1}{\tikz@dv@arg@d},
  arg5 from key/.code=\pgfkeysgetvalue{/tikz/data visualization/#1}{\tikz@dv@arg@e},
  arg6 from key/.code=\pgfkeysgetvalue{/tikz/data visualization/#1}{\tikz@dv@arg@f},
  arg7 from key/.code=\pgfkeysgetvalue{/tikz/data visualization/#1}{\tikz@dv@arg@g},
  arg8 from key/.code=\pgfkeysgetvalue{/tikz/data visualization/#1}{\tikz@dv@arg@h}
  arg1 handle from key/.code=\tikz@dv@handle@from@key{#1}{\tikz@dv@handle@a}{\tikz@dv@arg@a},
  arg2 handle from key/.code=\tikz@dv@handle@from@key{#1}{\tikz@dv@handle@b}{\tikz@dv@arg@b},
  arg3 handle from key/.code=\tikz@dv@handle@from@key{#1}{\tikz@dv@handle@c}{\tikz@dv@arg@c},
  arg4 handle from key/.code=\tikz@dv@handle@from@key{#1}{\tikz@dv@handle@d}{\tikz@dv@arg@d},
  arg5 handle from key/.code=\tikz@dv@handle@from@key{#1}{\tikz@dv@handle@e}{\tikz@dv@arg@e},
  arg6 handle from key/.code=\tikz@dv@handle@from@key{#1}{\tikz@dv@handle@f}{\tikz@dv@arg@f},
  arg7 handle from key/.code=\tikz@dv@handle@from@key{#1}{\tikz@dv@handle@g}{\tikz@dv@arg@g},
  arg8 handle from key/.code=\tikz@dv@handle@from@key{#1}{\tikz@dv@handle@h}{\tikz@dv@arg@h}
}

\def\tikz@dv@handle@from@key#1#2#3{%
  \pgfkeysvalueof{/tikz/data visualization/#1}.get handle(#2)%
  \def#3{#2}%
}






%
%
% Simple axes
%
%

\tikzdatavisualizationset{%
  new axis/.style={
    new object={
      when=before survey,
      store=/tikz/data visualization/#1/source interval,
      class=interval,
      arg1 from key=#1/source/min,%
      arg2 from key=#1/source/max%
    },
    new object={
      when=before survey,
      store=/tikz/data visualization/#1/source range surveyor,
      class=range surveyor,
      arg1 from key=#1/source,%
      arg2 handle from key=#1/source interval%
    },
    new object={
      when=after survey,
      store=/tikz/data visualization/#1/line transformer,
      class=line transformer,
      arg1/.expanded=\pgfkeysvalueof{/tikz/data visualization/#1/source}/mapped,
      arg2=\pgfpointpolar{\pgfkeysvalueof{/tikz/data visualization/#1/angle}}{1pt},
      after creation={\tikzdvobj.set origin(
        \pgfpointpolar{\pgfkeysvalueof{/tikz/data visualization/#1/angle}}{\tikz@lib@dv@min@at})}
    },
    new object={
      when=after survey,
      store=/tikz/data visualization/#1/mapper,
      class=mapper,
      arg1 from key=#1/source,%
      arg2 handle from key=#1/in interval,%
      arg3=\pgfkeysvalueof{/tikz/data visualization/#1/source}/mapped,%
      arg4 handle from key=#1/out interval,%
      arg5 from key=#1/function
    },
    new object={
      when=after survey,
      store=/tikz/data visualization/#1/out interval,
      class=interval,
      arg1/.expanded=0,
      arg2/.expanded=\tikz@lib@dv@scaling,
    },
    new object={
      when=after survey,
      store=/tikz/data visualization/#1/in interval,
      class=interval,
      before creation=\tikz@lib@compute@mapped{#1},
      arg1/.expanded=\tikz@lib@dv@min,
      arg2/.expanded=\tikz@lib@dv@max,
    },
    #1/source/.initial=#1,
    #1/source/min/.initial=,
    #1/source/max/.initial=,
    #1/function/.initial=,
    #1/angle/.initial=0,
    #1/scaling/.initial=,
    #1/scaling default/.initial=0 at 0pt and 1 at 1cm,
    #1/.unknown/.code={%
      \let\tikz@dv@lib@key\pgfkeyscurrentname%
      \edef\tikz@dv@lib@path{\pgfkeyscurrentpath}%
      \pgfkeys{/tikz/data visualization/axis styles/.cd,\tikz@dv@lib@key=##1}%
    }
  }
}
\tikzset{
  /tikz/data visualization/axis styles/.cd,
  ln/.style={
    \tikz@dv@lib@path/function=\pgfmathparse{ln(\pgfvalue)},
    \tikz@dv@lib@path/scaling default=1 at 0pt and 10 at 1cm,
  },
  axis length/.style={\tikz@dv@lib@path/scaling=min at 0pt and max at #1},
  positive axis length/.style={\tikz@dv@lib@path/scaling=0 at 0pt and max at #1},
  unit length/.style={\tikz@dv@lib@path/scaling=0 at 0pt and 1 at #1},
  power unit length/.style={\tikz@dv@lib@path/scaling=1 at 0pt and 10 at #1},
}

% Computes the correct size of the mapped interval
\def\tikz@lib@compute@mapped#1{%
  \pgfkeysvalueof{/tikz/data visualization/#1/source interval}.get min and max()%
  \pgfkeysgetvalue{/tikz/data visualization/#1/scaling}\tikz@temp%
  \ifx\tikz@temp\pgfutil@empty%
    \pgfkeysgetvalue{/tikz/data visualization/#1/scaling default}\tikz@temp%
  \fi%
  \expandafter\tikz@lib@dv@parse@scaling\tikz@temp\pgf@stop%
  % Parse...
}
\def\tikz@lib@dv@parse@scaling#1 at#2and #3 at#4\pgf@stop{%
  \def\tikz@lib@dv@min{#1}%
  \pgfmathparse{#2}
  \let\tikz@lib@dv@min@at\pgfmathresult%
  \def\tikz@lib@dv@max{#3}%
  \pgfmathparse{#4}
  \let\tikz@lib@dv@max@at\pgfmathresult%
  \ifx\tikz@lib@dv@min\pgf@min@text%
    \let\tikz@lib@dv@min\pgfdvmin
  \else
    \pgfmathparse{\tikz@lib@dv@min}
    \let\tikz@lib@dv@min\pgfmathresult
  \fi
  \ifx\tikz@lib@dv@max\pgf@max@text%
    \let\tikz@lib@dv@max\pgfdvmax
  \else
    \pgfmathparse{\tikz@lib@dv@max}
    \let\tikz@lib@dv@max\pgfmathresult
  \fi
  % now, compute distance between min at and max at
  \pgfmathsubtract{\tikz@lib@dv@max@at}{\tikz@lib@dv@min@at}
  \let\tikz@lib@dv@scaling=\pgfmathresult%
}
\def\pgf@min@text{min}
\def\pgf@max@text{max}
\let\tikz@lib@dv@scaling\relax
\let\tikz@lib@dv@min\relax
\let\tikz@lib@dv@max\relax


%
%
% Simple plots
%
%

\tikzdatavisualizationset{
  school book plot/.style={
    new axis=x,
    new axis=y,
    y/angle=90,
    new object={
      when=after survey,
      store=/tikz/data visualization/plot,
      class=plot handler visualizer,
      arg1=\pgfplothandlerlineto
    }
  }
}       

\endinput
