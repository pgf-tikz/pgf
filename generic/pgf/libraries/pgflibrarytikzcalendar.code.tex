% Copyright 2006 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header$


\pgfutil@usemodule{pgfcalendar}


%
% General options (these options affect all calendars typeset unsind \calendar):
%
% Start, end, and code executed for each current date
%

\tikzoption{dates}{\tikz@lib@cal@parse#1\relax}
\def\tikz@lib@cal@parse#1 to #2\relax{%
  \def\tikz@lib@cal@start{#1}
  \def\tikz@lib@cal@end{#2}%
}
\tikzoption{execute at begin current date scope}{\expandafter\def\expandafter\tikz@atbegin@day\expandafter{\tikz@atbegin@day#1}}
\tikzoption{execute at end current date scope}{%
  \def\pgf@temp{#1}%
  \expandafter\expandafter\expandafter\def%
  \expandafter\expandafter\expandafter\tikz@atend@day%
  \expandafter\expandafter\expandafter{\expandafter\pgf@temp\tikz@atend@day}}
\tikzoption{execute before current date scope}{\expandafter\def\expandafter\tikz@before@day\expandafter{\tikz@before@day#1}}
\tikzoption{execute after current date scope}{\expandafter\def\expandafter\tikz@after@day\expandafter{\tikz@after@day#1}}

\let\tikz@atbegin@day=\pgfutil@empty
\let\tikz@atend@day=\pgfutil@empty
\let\tikz@before@day=\pgfutil@empty
\let\tikz@after@day=\pgfutil@empty



% 
% Options affecting some calendars:
%

% General day shift

\tikzoption{day xshift}{\def\tikz@lib@cal@xshift{#1}}
\tikzoption{day yshift}{\def\tikz@lib@cal@yshift{#1}}
\tikzoption{day shift}{\def\tikz@lib@cal@xshift{#1}\def\tikz@lib@cal@yshift{#1}}

\def\tikz@lib@cal@yshift{3ex}
\def\tikz@lib@cal@xshift{3.5ex}

% Templates for typesetting days, month, years

\tikzoption{day code}{\def\tikzdaycode{#1}}
\tikzoption{day text}{\def\tikzdaytext{#1}}
\tikzoption{days}{\tikzstyle{every day}+=[#1]}
\tikzstyle{every day}=[name=\pgfcalendarsuggestedname,anchor=base east]

\tikzoption{month code}{\def\tikzmonthcode{#1}}
\tikzoption{month text}{\def\tikzmonthtext{#1}}
\tikzstyle{every month}=[]

\tikzoption{year code}{\def\tikzyearcode{#1}}
\tikzoption{year text}{\def\tikzyeartext{#1}}
\tikzstyle{every year}=[]

\def\tikzdaycode{\node[every day]{\tikzdaytext};}
\def\tikzmonthcode{\node[every month]{\tikzmonthtext};}
\def\tikzyearcode{\node[every year]{\tikzyeartext};}

\def\tikzdaytext{\%d-}
\def\tikzmonthtext{\%mt}
\def\tikzyeartext{\%y0}


%
% Days on a line
%

\tikzstyle{arrange days downward}=[execute after current date scope={\setlength{\pgf@y}{\tikz@lib@cal@yshift}\pgftransformyshift{-\pgf@y}}]
\tikzstyle{arrange days upward}=[execute after current date scope={\pgftransformyshift\tikz@lib@cal@yshift}]
\tikzstyle{arrange days right}=[execute after current date scope={\pgftransformxshift\tikz@lib@cal@xshift}]

\tikzstyle{months left horizontal}=[%
  execute at end current date scope={\ifdate{day of month=1}{\tikzmonthcode}{}},
  set style={{every month}+=[anchor=base east,xshift=-3.5ex]}
]

\tikzstyle{months left vertical}=[%
  execute at end current date scope={\ifdate{day of month=1}{\tikzmonthcode}{}},
  set style={{every month}+=[anchor=base east,xshift=-4.5ex,yshift=2.25ex,rotate=90]}
]
  
\tikzstyle{months right horizontal}=[%
  execute at end current date scope={\ifdate{day of month=1}{\tikzmonthcode}{}},
  set style={{every month}+=[anchor=base west,xshift=-.25ex]}
]

\tikzstyle{months right vertical}=[%
  execute at end current date scope={\ifdate{day of month=1}{\tikzmonthcode}{}},
  set style={{every month}+=[anchor=base west,xshift=1ex,yshift=2.25ex,rotate=-90]}
]

\tikzstyle{months above horizontal}=[%
  execute at end current date scope={\ifdate{day of month=1}{\tikzmonthcode}{}},
  set style={{every month}+=[anchor=base west,at=(\pgfcalendarsuggestedname.north west),yshift=1ex]}
]
  
\tikzstyle{months below horizontal}=[%
  execute at end current date scope={\ifdate{day of month=1}{\tikzmonthcode}{}},
  set style={{every month}+=[anchor=base west,at=(\pgfcalendarsuggestedname.south west),yshift=-2.5ex]}
]


%\tikzstyle{month end markers}=[execute at end day={
%   \ifdate{day of month=1,equals=\pgfcalendarbeginiso}
%   {\draw [thick,cap=round,black!50] (-3pt,0.9em) -- (-3em,0.9em);}{}
%}]




%
% Week list
%

\tikzstyle{arrange weekwise}=[%
  execute at begin current date scope={%
    \setlength\pgf@x{\tikz@lib@cal@xshift}%
    \pgf@x=\pgfcalendarcurrentweekday\pgf@x%
    \pgftransformxshift{\pgf@x}%
  },
  execute after current date scope={%
    \ifdate{Sunday}{%
      \setlength{\pgf@y}{\tikz@lib@cal@yshift}%
      \pgftransformyshift{-\pgf@y}
    }{}%
  }
]

\tikzoption{month sep}{\def\tikz@lib@cal@month@sep{#1}}
\def\tikz@lib@cal@month@sep{1cm}

\tikzstyle{months above centered}=[%
  execute before current date scope={%
    \ifdate{day of month=1}{%
      \setlength{\pgf@y}{\tikz@lib@cal@month@sep}%
      \pgftransformyshift{-\pgf@y}%
      {%
        \setlength{\pgf@x}{\tikz@lib@cal@xshift}%
        \pgftransformxshift{3\pgf@x}%
        \pgftransformxshift{-1.5ex}%
        \tikzmonthcode%
      }%
      \setlength{\pgf@y}{\tikz@lib@cal@yshift}%
      \pgftransformyshift{-1.25\pgf@y}
    }{}},
  set style={{every month}+=[anchor=base]}
]
  



%
% Code of the actual \calendar command (tikz.code.tex contains \let\calendar=\tikz@lib@cal@calendar):
%

\def\tikz@lib@cal@calendar{%
  \begingroup%
    \let\tikz@lib@cal@ifs=\pgfutil@empty%
    \tikz@expandcount=1000\relax%
    \tikz@setkeys{name=,at={(0,0)}}%
    \let\%=\pgfcalendarshorthand%
    \tikz@lib@cal@scanner%
}

\def\tikz@lib@cal@scanner{%
  \afterassignment\tikz@lib@cal@handle\let\@let@token=%
}

\def\tikz@lib@cal@handle{%
  \let\@next=\tikz@lib@cal@expand%
  \ifx\@let@token;%
    \let\@next=\tikz@lib@cal@stop%
  \else%
    \ifx\@let@token(%)
      \let\@next=\tikz@lib@cal@name%
    \else%
      \ifx\@let@token a%
        \let\@next=\tikz@lib@cal@at%
      \else%
        \ifx\@let@token[%
          \let\@next=\tikz@lib@cal@option%
        \else%
          \ifx\@let@token i%
            \let\@next=\tikz@lib@cal@if%
          \fi%
        \fi%
      \fi%
    \fi%
  \fi%
  \@next%
}
\def\tikz@lib@cal@expand{%
  \advance\tikz@expandcount by -1%
  \ifnum\tikz@expandcount<0\relax%
    \PackageError{tikz}{Giving up on this calendar}{}%
    \let\@next=\tikz@lib@cal@end%
  \else%
    \let\@next=\tikz@lib@cal@@expand
  \fi%
  \@next}

\def\tikz@lib@cal@@expand{\expandafter\tikz@lib@cal@scanner\@let@token}


\def\tikz@lib@cal@name#1){%
  \tikz@setkeys{name=#1}%
  \tikz@lib@cal@scanner%
}
\def\tikz@lib@cal@at t#1(#2){%
  \tikz@setkeys{at={(#2)}}%
  \tikz@lib@cal@scanner%
}
\def\tikz@lib@cal@option#1]{%
  \tikz@setkeys{#1}%
  \tikz@lib@cal@scanner%
}
\def\tikz@lib@cal@if f#1(#2){%
  \pgfutil@ifnextchar[{\tikz@lib@cal@if@opt{#2}}{\tikz@lib@cal@if@code{#2}}}%}

\def\tikz@lib@cal@if@opt#1[#2]{\tikz@lib@cal@if@code{#1}{\tikz@setkeys{#2}}}
\def\tikz@lib@cal@if@code#1#2{%
  \pgfutil@ifnextchar e{\tikz@lib@cal@if@else{#1}{#2}}{\tikz@lib@cal@if@else{#1}{#2}else{}}}

\def\tikz@lib@cal@if@else#1#2else{%
  \pgfutil@ifnextchar[{\tikz@lib@cal@if@else@opt{#1}{#2}}{\tikz@lib@cal@if@else@code{#1}{#2}}}%}
\def\tikz@lib@cal@if@else@opt#1#2[#3]{\tikz@lib@cal@if@else@code{#1}{#2}{\tikz@setkeys{#3}}}
\def\tikz@lib@cal@if@else@code#1#2#3{%
  \expandafter\def\expandafter\tikz@lib@cal@ifs\expandafter{\tikz@lib@cal@ifs\ifdate{#1}{#2}{#3}}%
  \tikz@lib@cal@scanner%
}
\def\tikz@lib@cal@stop{%
    \pgftransformshift{\tikz@node@at}%
    \expandafter\pgfcalendar\expandafter{\tikz@fig@name}{\tikz@lib@cal@start}{\tikz@lib@cal@end}%
    {%
      \tikz@before@day%  
      \scope%
        \tikz@atbegin@day%
        \tikz@lib@cal@ifs%
        \tikzdaycode%
        \tikz@atend@day%
      \endscope%
      \tikz@after@day%  
    }%
  \endgroup%
}




\endinput
