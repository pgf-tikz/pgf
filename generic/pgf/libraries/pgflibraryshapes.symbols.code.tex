% Copyright 2007 by Till Tantau and Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header$

\pgfdeclareshape{forbidden sign}
{
  \inheritsavedanchors[from=circle] % this is nearly a circle
  \inheritanchorborder[from=circle]
  \inheritanchor[from=circle]{north}
  \inheritanchor[from=circle]{north west}
  \inheritanchor[from=circle]{north east}
  \inheritanchor[from=circle]{center}
  \inheritanchor[from=circle]{west}
  \inheritanchor[from=circle]{east}
  \inheritanchor[from=circle]{mid}
  \inheritanchor[from=circle]{mid west}
  \inheritanchor[from=circle]{mid east}
  \inheritanchor[from=circle]{base}
  \inheritanchor[from=circle]{base west}
  \inheritanchor[from=circle]{base east}
  \inheritanchor[from=circle]{south}
  \inheritanchor[from=circle]{south west}
  \inheritanchor[from=circle]{south east}
  \inheritbackgroundpath[from=circle]
  \foregroundpath{
    \centerpoint%
    \pgf@xc=\pgf@x%
    \pgf@yc=\pgf@y%
    \pgfutil@tempdima=\radius%
    \pgfmathsetlength{\pgf@xb}{\pgfkeysvalueof{/pgf/outer xsep}}%  
    \pgfmathsetlength{\pgf@yb}{\pgfkeysvalueof{/pgf/outer ysep}}%  
    \ifdim\pgf@xb<\pgf@yb%
      \advance\pgfutil@tempdima by-\pgf@yb%
    \else%
      \advance\pgfutil@tempdima by-\pgf@xb%
    \fi%
    \pgfpathmoveto{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfqpoint{-0.707107\pgfutil@tempdima}{-0.707107\pgfutil@tempdima}}}
    \pgfpathlineto{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfqpoint{0.707107\pgfutil@tempdima}{0.707107\pgfutil@tempdima}}}
  }
}





% Keys for starburst shape
%
% /pgf/starburst point height : The maximum height of the outer points.
% /pgf/starburst points       : The number of points.
% /pgf/random starburst       : The seed for the random number generator.
%
\pgfkeys{/pgf/random starburst/%
	.code={%
		\ifx\pgfkeysnovalue#1%
			\pgfmathgeneratepseudorandomnumber%
		\else%
			\pgfmathtruncatemacro\pgfmathresult{#1}%
		\fi%
		\pgfkeyslet{/pgf/random starburst}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/random starburst=100}

\pgfkeys{/pgf/starburst point height/.value required}
\pgfkeys{/pgf/starburst point height/.code={%
		\pgfmathparse{#1}%
		\edef\pgfmathresult{\pgfmathresult pt}%
		\pgfkeyslet{/pgf/starburst point height}{\pgfmathresult}%
	}%
}%
\pgfkeys{/pgf/starburst point height=.5cm}

\pgfkeys{/pgf/starburst points/.value required}
\pgfkeys{/pgf/starburst points/.code={%
		\pgfmathtruncatemacro\pgfmathresult{#1}%
		\pgfkeyslet{/pgf/starburst points}{\pgfmathresult}%
	}%	
}%
\pgfkeys{/pgf/starburst points=17}

\pgfdeclareshape{starburst}{%
	\savedmacro\anglestep{%
		\pgfmathdivide@{180}{\pgfkeysvalueof{/pgf/starburst points}}%
		\let\anglestep\pgfmathresult%
	}
	\savedmacro\calculatestarburstpoints{%
		%
		% Get the angle step.
		%
		\pgfmathdivide@{180}{\pgfkeysvalueof{/pgf/starburst points}}%
		\let\anglestep\pgfmathresult%
		%
		% Get the total number of points.
		%
		\pgfmathsetcounter{pgf@counta}{\pgfkeysvalueof{/pgf/starburst points}}%
		\multiply\c@pgf@counta2\relax%
		\edef\totalpoints{\the\c@pgf@counta}%
		\addtosavedmacro{\totalpoints}%
		%
		% Calculate the centerpoint.
		%
		\pgfsavepgf@process\centerpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
			\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
		}%
		%
		% Get the larger of the outer sep.
		%
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/outer xsep}}%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
		\ifdim\pgf@x<\pgf@y%
			\pgf@x\pgf@y%
		\fi%
		\edef\outersep{\the\pgf@x}%
		% 
		% Get the node dimensions.
		% 
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%		
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/inner ysep}}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		%
		%  Calculate the inner radii.
		%
		\ifpgfshapeborderusesincircle%
			\pgfkeysgetvalue{/pgf/shape border rotate}{\rotate}%
			%
			% Use the incircle...
			%
			\ifdim\pgf@y>\pgf@x%
				\pgf@x\pgf@y%
			\fi%
			\pgf@x1.41421\pgf@x%
			\pgf@y\pgf@x%
		\else%
			%
			% Get the rotation (with rounding).
			%
			\pgfkeysgetvalue{/pgf/shape border rotate}{\rotate}%
			\pgfmathmod@{\rotate}{360}%
			\afterassignment\pgfmath@gobbletilpgfmath@%
			\expandafter\c@pgf@counta\pgfmathresult\relax\pgfmath@%
			\advance\c@pgf@counta45\relax%
			\divide\c@pgf@counta90\relax%
			\multiply\c@pgf@counta90\relax%
			\ifnum\c@pgf@counta<0\relax%
				\advance\c@pgf@counta360\relax%
			\fi%
			%
			% Calculate the width and height of the node
			% contents, according to any border rotation.
			%
			\ifnum\c@pgf@counta=90\relax%
				\pgf@xc\pgf@x%
				\pgf@x\pgf@y%
				\pgf@y\pgf@xc%
			\else%
				\ifnum\c@pgf@counta=270\relax%
					\pgf@xc\pgf@x%
					\pgf@x\pgf@y%
					\pgf@y\pgf@xc%
				\fi%
			\fi%
			\edef\rotate{\the\c@pgf@counta}%
			%
			% ...or not.
			%		
			\pgf@x=1.41421\pgf@x%
			\pgf@y=1.41421\pgf@y%
		\fi%
		\addtosavedmacro{\rotate}%
		% 
		% Adjust innerradius for minimum width and height.
		%
		\pgf@xa\pgf@x% 
		\pgfmathsetlength\pgf@xb{+\pgfkeysvalueof{/pgf/starburst point height}}%
		\advance\pgf@xa\pgf@xb%
		\pgfmathsetlength\pgf@xc{+\pgfkeysvalueof{/pgf/minimum width}}%
		\ifdim\pgf@xa<.5\pgf@xc%
			\pgf@x.5\pgf@xc%
			\advance\pgf@x-\pgf@xb%
		\fi%
		\pgf@ya\pgf@y% 
		\pgfmathsetlength\pgf@yb{+\pgfkeysvalueof{/pgf/starburst point height}}%
		\advance\pgf@ya\pgf@yb%
		\pgfmathsetlength\pgf@yc{+\pgfkeysvalueof{/pgf/minimum height}}%
		\ifdim\pgf@ya<.5\pgf@yc%
			\pgf@y.5\pgf@yc%
			\advance\pgf@y-\pgf@yb%
		\fi%	
		\edef\xinnerradius{\the\pgf@x}%
		\edef\yinnerradius{\the\pgf@y}%
		\addtosavedmacro{\xinnerradius}%
		\addtosavedmacro{\yinnerradius}%
		%
		% Calculate a radius outside the starburst.
		%
		\ifdim\pgf@y>\pgf@x%
			\pgf@x\pgf@y%
		\fi%
		\pgfmathaddtolength\pgf@x{+\pgfkeysvalueof{/pgf/starburst point height}}%
		\edef\externalradius{\the\pgf@x}%
		\addtosavedmacro{\externalradius}%
		%
		% Set the seed for the random number generator.
		%
		\pgfmathsetseed{\pgfkeysvalueof{/pgf/random starburst}}%	
		%
		% Now create the points on the shape and also 
		% the miter length and angle for each point.
		%
		\def\angle{90}% Start at the top.
		%
		% At point a, the miter length and angle are calculated for point b = a - 1.
		%
		\c@pgf@counta1\relax%
		\c@pgf@countb0\relax%
		%
		% As 3 consecutive points are required to be defined for miter
		% calculations, it is necessary to go over the first two points
		% again.
		% 
		\c@pgf@countc\totalpoints\relax%
		\advance\c@pgf@countc2\relax%
		\edef\looppoints{\the\c@pgf@countc}%
		\let\secondpoint\pgfutil@empty%
		\let\thirdpoint\pgfutil@empty%
		\pgfmathloop%
			%
			% Cycle the point definitions.
			%
			\let\firstpoint\secondpoint%	
			\let\secondpoint\thirdpoint%	
			\ifnum\pgfmathcounter>\looppoints%
			\else%
				\ifnum\pgfmathcounter>\totalpoints%
					\expandafter\let\expandafter\thirdpoint\csname point@\the\c@pgf@counta @\endcsname%
				\else%
					\ifodd\pgfmathcounter%
						%
						% An outer point.
						%
						\ifnum\pgfkeysvalueof{/pgf/random starburst}=0\relax%
							\pgf@xa\pgfkeysvalueof{/pgf/starburst point height}\relax%
						\else%
							\pgf@x\pgfkeysvalueof{/pgf/starburst point height}\relax%
							\pgf@xa.75\pgf@x%
							\pgf@xb.25\pgf@x%
							\pgfmathrnd%
							\pgf@xa\pgfmathresult\pgf@xa%
							\advance\pgf@xa\pgf@xb%
						\fi%
						\pgf@x\xinnerradius\relax%
						\advance\pgf@x\pgf@xa%
						\pgf@y\yinnerradius\relax%
						\advance\pgf@y\pgf@xa%
						\expandafter\pgfsavepgf@process\csname point@\the\c@pgf@counta @\endcsname{%
							\pgfpointpolar{\angle}{\the\pgf@x and \the\pgf@y}%
							\pgf@xa\pgf@x%
							\pgf@ya\pgf@y%
							\centerpoint%
							\advance\pgf@x\pgf@xa%
							\advance\pgf@y\pgf@ya%
						}%
					\else%
						%
						% An inner point.
						%
						\expandafter\pgfsavepgf@process\csname point@\the\c@pgf@counta @\endcsname{%
							\pgfpointpolar{\angle}{\xinnerradius and \yinnerradius}%
							\pgf@xa\pgf@x%
							\pgf@ya\pgf@y%
							\centerpoint%
							\advance\pgf@x\pgf@xa%
							\advance\pgf@y\pgf@ya%
						}%						
					\fi%
					%
					% Add the points to the saved macro.
					%
					\expandafter\let\expandafter\thirdpoint\csname point@\the\c@pgf@counta @\endcsname%
					\expandafter\addtosavedmacro\expandafter{\csname point@\the\c@pgf@counta @\endcsname}%
				\fi%				
				%
				% It is only possible to do the miter calculations if three points are defined.
				%
				\ifx\firstpoint\pgfutil@empty%
				\else%
					%
					% Calculate the miter length...
					%
					\pgfmathanglebetweenlines{\secondpoint}{\thirdpoint}{\secondpoint}{\firstpoint}%
					\pgfmathdivide@{\pgfmathresult}{2}%
					\let\defaultmiterangle\pgfmathresult%
					\pgfmathcosec@{\pgfmathresult}%
					\pgf@x\outersep\relax%
					\pgf@x\pgfmathresult\pgf@x%
					\edef\miterlength{\the\pgf@x}%
					%
					% ...the miter angle...
					%
					\pgfmathanglebetweenlines{\firstpoint}{\secondpoint}{\firstpoint}{\thirdpoint}%
					\pgfmathadd@{\pgfmathresult}{\defaultmiterangle}%
					\pgfmathsubtract@{180}{\pgfmathresult}%
					\let\angletemp\pgfmathresult%
					\pgfmathanglebetweenpoints{\firstpoint}{\thirdpoint}%
					\pgfmathsubtract@{180}{\pgfmathresult}%
					\pgfmathsubtract@{\angletemp}{\pgfmathresult}%
					\edef\miterangle{\pgfmathresult}%
					%
					% ...and thus the border point.
					%
					\pgfsavepgf@process\borderpoint{%
						\secondpoint%
						\pgf@xa\pgf@x
						\pgf@ya\pgf@y%
						\pgfpointpolar{\miterangle}{\miterlength}%
						\advance\pgf@x\pgf@xa%
						\advance\pgf@y\pgf@ya%
					}%
					%
					% Get the angle from the centerpoint to the *unrotated* border points.
					%
					\pgfmathanglebetweenpoints{\centerpoint}{\borderpoint}%
					\expandafter\edef\csname angletoborderpoint@\the\c@pgf@countb @\endcsname{\pgfmathresult}%
					\expandafter\addtosavedmacro\expandafter{\csname angletoborderpoint@\the\c@pgf@countb @\endcsname}%
					%
					% Rotatee the border points and save.
					%
					\expandafter\pgfsavepgf@process\csname borderpoint@\the\c@pgf@countb @\endcsname{%
						\pgfmathrotatepointaround{\borderpoint}{\centerpoint}{\rotate}%
					}%
					\expandafter\addtosavedmacro\expandafter{\csname borderpoint@\the\c@pgf@countb @\endcsname}%				
					%
					% Now create the anchors.
					%
					\c@pgf@countc\c@pgf@countb%
					\advance\c@pgf@countc1\relax%
					\divide\c@pgf@countc2\relax%
					\ifodd\c@pgf@countb\relax%
						\pgfutil@ifundefined{pgf@anchor@starburst@outer point\space\the\c@pgf@countc}{%
							\expandafter\xdef\csname pgf@anchor@starburst@outer point\space\the\c@pgf@countc\endcsname{%
								\noexpand\calculatestarburstpoints%
								\noexpand\csname borderpoint@\the\c@pgf@countb @\noexpand\endcsname%
							}%
						}{}%
					\else%
						\pgfutil@ifundefined{pgf@anchor@starburst@inner point\space\the\c@pgf@countc}{%
							\expandafter\xdef\csname pgf@anchor@starburst@inner point\space\the\c@pgf@countc\endcsname{%
								\noexpand\calculatestarburstpoints%
								\noexpand\csname borderpoint@\the\c@pgf@countb @\noexpand\endcsname%
							}%
						}{}%
					\fi%
				\fi%
				\pgfmathadd@{\angle}{\anglestep}%
				\pgfmathmod@{\pgfmathresult}{360}%	
				\let\angle\pgfmathresult%
				\advance\c@pgf@counta1\relax%
				\ifnum\c@pgf@counta>\totalpoints%
					\c@pgf@counta1\relax%
				\fi%
				\advance\c@pgf@countb1\relax%
				\ifnum\c@pgf@countb>\totalpoints%
					\c@pgf@countb1\relax%
				\fi%
		\repeatpgfmathloop%
	}
	\savedanchor\centerpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
	}%
	\savedanchor\midpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}%
	\savedanchor\basepoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgf@y0pt\relax%
	}%
	\anchor{center}{\centerpoint}
	\anchor{base}{\basepoint}
	\anchor{mid}{\midpoint}
	\anchor{north}{%
		\calculatestarburstpoints%
		\csname pgf@anchor@starburst@border\endcsname{\pgfqpoint{0pt}{\externalradius}}%
	}
	\anchor{south}{%
		\calculatestarburstpoints%
		\csname pgf@anchor@starburst@border\endcsname{\pgfqpoint{0pt}{-\externalradius}}%
	}
	\anchor{east}{%
		\calculatestarburstpoints%
		\csname pgf@anchor@starburst@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}
	\anchor{west}{%
		\calculatestarburstpoints%
		\csname pgf@anchor@starburst@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}
	\anchor{north west}{%
		\calculatestarburstpoints%
		\csname pgf@anchor@starburst@border\endcsname{\pgfqpoint{-\externalradius}{\externalradius}}%
	}
	\anchor{south west}{%
		\calculatestarburstpoints%
		\csname pgf@anchor@starburst@border\endcsname{\pgfqpoint{-\externalradius}{-\externalradius}}%
	}
	\anchor{north east}{%
		\calculatestarburstpoints%
		\csname pgf@anchor@starburst@border\endcsname{\pgfqpoint{\externalradius}{\externalradius}}%
	}
	\anchor{south east}{%
		\calculatestarburstpoints%
		\csname pgf@anchor@starburst@border\endcsname{\pgfqpoint{\externalradius}{-\externalradius}}%
	}
	\backgroundpath{%	
		\calculatestarburstpoints%
		\pgfmathloop%
			\ifnum\pgfmathcounter>\totalpoints%
			\else%
				\ifnum\pgfmathcounter=1\relax%
					\let\starburstaction\pgfpathmoveto%
				\else%
					\let\starburstaction\pgfpathlineto%
				\fi%
				\starburstaction{%
					%\pgfmathrotatepointaround{\csname point@\pgfmathcounter @\endcsname}{\centerpoint}{\rotate}}%
					\csname point@\pgfmathcounter @\endcsname}
			\repeatpgfmathloop%
		\pgfpathclose%		
	}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% Adjust the location of the external 
		% point relative to \centerpoint.
		%
		\centerpoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Get the starburst points.
		%
		\calculatestarburstpoints%
		%
		% Get the angle of the external point to the \centerpoint.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
		\pgfmathsubtract@{\pgfmathresult}{\rotate}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		\let\externalangle\pgfmathresult%
		%
		% Locate the appropriate sides on the starburst border...
		%
		\ifdim\externalangle pt<90pt\relax%
			\c@pgf@counta0\relax%
			\c@pgf@countb\totalpoints\relax%
			\pgfmathloop%
			\ifnum\c@pgf@counta>0\relax%
			\else%
				\ifdim\csname angletoborderpoint@\the\c@pgf@countb @\endcsname pt>90pt\relax%
					\c@pgf@counta\c@pgf@countb%
				\else%
					\ifdim\externalangle pt>\csname angletoborderpoint@\the\c@pgf@countb @\endcsname pt\relax%
						\c@pgf@counta\c@pgf@countb%
					\fi%
				\fi%
				\advance\c@pgf@countb-1\relax%
			\repeatpgfmathloop%
			\edef\first{\the\c@pgf@counta}%
			\advance\c@pgf@counta1\relax%
			\ifnum\c@pgf@counta>\totalpoints\relax%
				\c@pgf@counta1\relax%
			\fi%
			\edef\second{\the\c@pgf@counta}%
		\else%
			\c@pgf@counta0\relax%
			\pgfmathloop%
			\ifnum\c@pgf@counta>0\relax%
			\else%
				\ifdim\csname angletoborderpoint@\pgfmathcounter @\endcsname pt<90pt\relax%
					\c@pgf@counta\pgfmathcounter%
				\else%
					\ifdim\externalangle pt<\csname angletoborderpoint@\pgfmathcounter @\endcsname pt\relax%
						\c@pgf@counta\pgfmathcounter%	
					\fi%
				\fi%					
			\repeatpgfmathloop%
			\edef\first{\the\c@pgf@counta}%
			\advance\c@pgf@counta-1\relax%
			\ifnum\c@pgf@counta=0\relax%
				\c@pgf@counta\totalpoints\relax%
			\fi%
			\edef\second{\the\c@pgf@counta}%
		\fi%
		%
		% ...and thus, the point on the star border.
		%
		\pgfpointintersectionoflines{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
				{\csname borderpoint@\first @\endcsname}{\csname borderpoint@\second @\endcsname}%
	}%
}




% Keys for shape cloud.
%
% /pgf/cloud puffs    : the number of cloud puffs.
% /pgf/cloud aspect   : the recommended ratio between width and height.
% /pgf/cloud puff arc : the length of the cloud puff arc.

\pgfkeys{/pgf/cloud puffs/.code={%
	\pgfmathtruncatemacro\pgfmathresult{#1}%
	\pgfkeyslet{/pgf/cloud puffs}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/cloud puffs=10}%

\pgfkeys{/pgf/cloud aspect/.value required}%
\pgfkeys{/pgf/cloud aspect/.code={%
	\pgfmathparse{#1}%
	\pgfkeyslet{/pgf/cloud aspect}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/cloud aspect=2}%

\pgfkeys{/pgf/cloud puff arc/.value required}%
\pgfkeys{/pgf/cloud puff arc/.code={%
	\pgfmathparse{#1}%
	\pgfkeyslet{/pgf/cloud puff arc}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/cloud puff arc=150}%

\newif\ifpgfcloudanchorsuseellipse%
\pgfkeys{/pgf/cloud anchors use ellipse/.is if=pgfcloudanchorsuseellipse}%

% Shape cloud.
%
\pgfdeclareshape{cloud}{%
	\savedmacro\puffs{%
		\pgfkeysgetvalue{/pgf/cloud puffs}{\puffs}%
	}%
	\savedmacro\anglestep{%
		\pgfmathdivide@{360}{\pgfkeysvalueof{/pgf/cloud puffs}}%
		\let\anglestep\pgfmathresult%
	}%
	\savedmacro\arc{%
		\pgfkeysgetvalue{/pgf/cloud puff arc}{\arc}%
	}%
	\savedmacro\getradii{%
		%
		% x radius.
		%
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgf@x1.4142135\pgf@x%
		%
		% y radius.
		%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/inner ysep}}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		\pgf@y1.4142135\pgf@y%
		%
		% Apply aspect.
		%
		\pgfkeysgetvalue{/pgf/cloud aspect}{\aspect}%
		\pgfmathreciprocal@{\aspect}%
		\pgf@xa\aspect\pgf@y%
		\pgf@ya\pgfmathresult\pgf@x%
		\ifdim\pgf@xa<\pgf@x%
			\pgf@xa\aspect\pgf@ya%
		\fi%
		\ifdim\pgf@ya<\pgf@y%
			\pgf@ya\pgfmathresult\pgf@xa%
		\fi%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\edef\xinnerradius{\the\pgf@xa}%
		\edef\yinnerradius{\the\pgf@ya}%
		\edef\xdefaultinnerradius{\the\pgf@xa}%
		\edef\ydefaultinnerradius{\the\pgf@ya}%
		%
		% Get the larger of the outer sep.
		%	
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/outer xsep}}%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
		\ifdim\pgf@x<\pgf@y%
			\pgf@x\pgf@y%
		\fi%
		\edef\outersep{\the\pgf@x}%
		%
		% For a given cloud, with puff arc length a°, the quotient of the
		% distance between the start and end point of a puffs circular arc
		% and the radius of that arc, is constant:
		%
		% g = .5 * sec((180-a)/2)
		% 
		\pgfmathsubtract@{180}{\pgfkeysvalueof{/pgf/cloud puff arc}}%
		\pgfmathdivide@{\pgfmathresult}{2}%
		\let\arcangle\pgfmathresult%
		\pgfmathsec@{\pgfmathresult}%
		\pgfmathdivide@{\pgfmathresult}{2}%
		\let\arcradiusquotient\pgfmathresult%
		\addtosavedmacro{\arcradiusquotient}%
		%
		% In addition, the quotient of the distance between the start and
		% end point of a puffs circular arc and the height of that arc 
		% (ignoring rotation), is also constant:
		%
		% h = .5 * (1-sin((180-a)/2))/cos((180-a)/2)
		%   = g  * (1 - sin((180-a)/2))
		\pgfmathsin@{\arcangle}%
		\pgfmathsubtract@{1}{\pgfmathresult}%
		\pgfmathmultiply@{\pgfmathresult}{\arcradiusquotient}%
		\let\archeightquotient\pgfmathresult%
		\addtosavedmacro{\archeightquotient}%
		%
		% Adjust for minimum height.
		%
		\pgfmathdivide@{180}{\pgfkeysvalueof{/pgf/cloud puffs}}%
		\let\halfanglestep\pgfmathresult%
		\pgfmathsubtract@{90}{\pgfmathresult}%
		\let\startangle\pgfmathresult%
		\pgfsavepgf@process\arcstartpoint{%
			\pgfpointpolar{+\startangle}{+\xdefaultinnerradius and +\ydefaultinnerradius}%		
		}%
		\pgfmathadd@{90}{\halfanglestep}%
		\let\endangle\pgfmathresult%
		\pgfsavepgf@process\arcendpoint{%
			\pgfpointpolar{+\endangle}{+\xdefaultinnerradius and +\ydefaultinnerradius}%		
		}%
		\pgfsavepgf@process\arcbetweenpoint{%
			\pgfpointdiff{\arcendpoint}{\arcstartpoint}%
		}%
		%
		\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@y}}
		\pgf@ya\pgfmathresult pt\relax%
		\pgf@ya\archeightquotient\pgf@ya%
		\pgfextracty\pgf@yb{%
			\pgfpointadd{\arcstartpoint}{\arcbetweenpoint}%
		}%
		\advance\pgf@ya\pgf@yb%
		\edef\youterradius{\the\pgf@ya}%
		\pgfmathsetlength\pgf@yb{+\pgfkeysvalueof{/pgf/minimum height}}%
		\pgf@yb.5\pgf@yb%
		\pgf@y\yinnerradius\relax%
		\ifdim\pgf@ya<\pgf@yb%
			\pgfmathdivide@{\pgfmath@tonumber{\pgf@y}}{\pgfmath@tonumber{\pgf@ya}}%
			\pgf@ya\pgf@yb%
			\edef\youterradius{\the\pgf@ya}%
			\pgf@y\pgfmathresult\pgf@ya%
			\edef\yinnerradius{\the\pgf@y}%
		\fi%
		%
		% Adjust for minimum width.
		%
		\pgfsavepgf@process\arcstartpoint{%
			\pgfpointpolar{+\halfanglestep}{+\xdefaultinnerradius and +\ydefaultinnerradius}%		
		}%
		\pgfsavepgf@process\arcendpoint{%
			\pgfpointpolar{+-\halfanglestep}{+\xdefaultinnerradius and +\ydefaultinnerradius}%		
		}%
		\pgfsavepgf@process\arcbetweenpoint{%
			\pgfpointdiff{\arcendpoint}{\arcstartpoint}%
		}%
		%
		\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@y}}
		\pgf@xa\pgfmathresult pt\relax%
		\pgf@xa\archeightquotient\pgf@xa%
		\pgfextractx\pgf@xb{%
			\pgfpointadd{\arcstartpoint}{\arcbetweenpoint}%
		}%
		\advance\pgf@xa\pgf@xb%
		\edef\xouterradius{\the\pgf@xa}%
		\pgfmathsetlength\pgf@xb{+\pgfkeysvalueof{/pgf/minimum width}}%
		\pgf@xb.5\pgf@xb%
		\pgf@x\xinnerradius\relax%
		\ifdim\pgf@xa<\pgf@xb%
			\pgfmathdivide@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@xa}}%
			\pgf@xa\pgf@xb%
			\edef\xouterradius{\the\pgf@xa}%
			\pgf@x\pgfmathresult\pgf@xa%
			\edef\xinnerradius{\the\pgf@x}%
		\fi%
		%
		\addtosavedmacro{\xinnerradius}%
		\addtosavedmacro{\yinnerradius}%
		%
		\pgf@x\xouterradius\relax%
		\advance\pgf@x\outersep\relax%
		\edef\xouterradius{\the\pgf@x}%
		\addtosavedmacro{\xouterradius}%
		%
		\pgf@y\youterradius\relax%
		\advance\pgf@y\outersep\relax%
		\edef\youterradius{\the\pgf@y}%
		\addtosavedmacro{\youterradius}%
	}
	\saveddimen\outersep{%
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/outer xsep}}%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
		\ifdim\pgf@x<\pgf@y%
			\pgf@x\pgf@y%
		\fi%
	}
	\savedmacro\gettrigconstants{%
		%
		% Get some trig. constants.
		%
		\pgfkeysgetvalue{/pgf/cloud puff arc}{\arc}%
		\pgfmathdivide@{\arc}{4}%
		\let\quarterarc\pgfmathresult%
		\pgfmathsubtract@{180}{\arc}%
		\pgfmathdivide@{\pgfmathresult}{2}%
		\let\halfcomplementarc\pgfmathresult%
		%
		\addtosavedmacro{\arc}%
		\addtosavedmacro{\quarterarc}%
		\addtosavedmacro{\halfcomplementarc}%
		%
		\pgfmathsec@{\halfcomplementarc}% 1/cos((180-a)/2)
		\let\sechalfcomplementarc\pgfmathresult%
		\pgfmathsin@{\halfcomplementarc}% sin((180-a)/2)
		\let\sinhalfcomplementarc\pgfmathresult%
		%
		\addtosavedmacro{\sechalfcomplementarc}%
		\addtosavedmacro{\sinhalfcomplementarc}%
		%
		\pgfmathsin@{\quarterarc}% sin(a/4)
		\let\sinquarterarc\pgfmathresult%
		\pgfmathcos@{\quarterarc}% cos(a/4)
		\let\cosquarterarc\pgfmathresult%
		\pgfmathreciprocal@{\cosquarterarc}%
		\pgfmathmultiply@{\pgfmathresult}{\sinquarterarc}% tan(a/4)
		\let\tanquarterarc\pgfmathresult%
		%
		\addtosavedmacro{\sinquarterarc}%
		\addtosavedmacro{\cosquarterarc}%
		\addtosavedmacro{\tanquarterarc}%
	}
	\savedanchor\centerpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
	}
	\savedanchor\midpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}
	\savedanchor\basepoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+0pt}%
	}
	\anchor{center}{\centerpoint}
	\anchor{mid}{\midpoint}
	\anchor{base}{\basepoint}
	\anchor{north}{%
		\getradii%
		\csname pgf@anchor@cloud@border\endcsname{\pgfqpoint{0pt}{\youterradius}}%
	}%
	\anchor{south}{%
		\getradii%
		\csname pgf@anchor@cloud@border\endcsname{\pgfqpoint{0pt}{-\youterradius}}%
	}%
	\anchor{east}{%
		\getradii%
		\csname pgf@anchor@cloud@border\endcsname{\pgfqpoint{\xouterradius}{0pt}}%
	}%
	\anchor{west}{%
		\getradii%
		\csname pgf@anchor@cloud@border\endcsname{\pgfqpoint{-\xouterradius}{0pt}}%
	}%
	\anchor{north west}{%
		\getradii%
		\pgfsavepgf@process\pgf@sh{%
			\pgf@x\xouterradius\relax%
			\pgf@x-0.707106\pgf@x%
			\pgf@y\youterradius\relax%
			\pgf@y0.707106\pgf@y%
		}%
		\csname pgf@anchor@cloud@border\endcsname{\pgf@sh}%
	}%
	\anchor{north east}{%
		\getradii%
		\pgfsavepgf@process\pgf@sh{%
			\pgf@x\xouterradius\relax%
			\pgf@x0.707106\pgf@x%
			\pgf@y\youterradius\relax%
			\pgf@y0.707106\pgf@y%
		}%
		\csname pgf@anchor@cloud@border\endcsname{\pgf@sh}%
	}%
	\anchor{south west}{%
		\getradii%
		\pgfsavepgf@process\pgf@sh{%
			\pgf@x\xouterradius\relax%
			\pgf@x-0.707106\pgf@x%
			\pgf@y\youterradius\relax%
			\pgf@y-0.707106\pgf@y%
		}%
		\csname pgf@anchor@cloud@border\endcsname{\pgf@sh}%
	}%
	\anchor{south east}{%
		\getradii%
		\pgfsavepgf@process\pgf@sh{%
			\pgf@x\xouterradius\relax%
			\pgf@x0.707106\pgf@x%
			\pgf@y\youterradius\relax%
			\pgf@y-0.707106\pgf@y%
		}%
		\csname pgf@anchor@cloud@border\endcsname{\pgf@sh}%
	}%
	%
	% Each `puff' is a circular arc of length a, drawn using two a/2 
	% arcs (a < 180), approximated by Bezier curves. Cannot use \pgfpatharc, 
	% because due to accuracy errors (from various sources), it is sometimes
	% necessary to `force' the arc to end at a specific point. So...
	%
	% @article{riskus2006,
	%   author  = {Aleskus Ri\v{s}kus},
	% 	title   = {Approximation of a cubic Bezier curve by circular arcs and vice versa},
	%   journal = {Information Technology and Control},
	%   year    = {2006},
	%   volume  = {35},
	%   number  = {4}
	% }
	%
	\backgroundpath{%
		\getradii%
		%
		% Get the start angle.
		%
		\pgfmathdivide@{\anglestep}{2}%
		\pgfmathsubtract@{90}{\pgfmathresult}%
		\let\angle\pgfmathresult%
		%
		% Calculate the first arc point.
		%
		\pgfsavepgf@process\arcfirstpoint{%
			\pgfpointadd{\centerpoint}{%
				\pgfpointpolar{+\angle}{+\xinnerradius and \yinnerradius}%
			}%
		}%
		\pgfpathmoveto{\arcfirstpoint}%
		\let\arcendpoint\arcfirstpoint%
		%
		\gettrigconstants%
		%
		\pgfmathloop%
		\ifnum\pgfmathcounter>\puffs\relax%
		\else
			\let\arcstartpoint\arcendpoint%
			%
			% Make sure beginning and end of path are exactly the same.
			%
			\ifnum\pgfmathcounter=\puffs\relax%
				\let\arcendpoint\arcfirstpoint%
			\else%
				\pgfmathadd@{\angle}{\anglestep}%
				\let\angle\pgfmathresult%
				\pgfsavepgf@process\arcendpoint{%
					\pgfpointadd{\centerpoint}{%
						\pgfpointpolar{+\angle}{+\xinnerradius and +\yinnerradius}%
					}%
				}%	
			\fi%
			%
			% Get some useful cloud parameters from \arcstartpoint and \arcendpoint.
			%
			\pgf@sh@getcloudpuffparameters%
			%
			% Get the rotation for the Bezier curve.
			%
			\pgfmathsubtract@{90}{\quarterarc}%
			\pgfmathadd@{\pgfmathresult}{\arcslope}%
			\let\arcrotate\pgfmathresult%
			\pgfmathsin@{\arcrotate}%
			\let\sinarcrotate\pgfmathresult%
			\pgfmathcos@{\arcrotate}%
			\let\cosarcrotate\pgfmathresult%
			%
			% Calculate the amount by which to scale the control 
			% points, in order to approximate an a/2 arc with radius x.
			%
			\pgf@x\arcradius\relax%
			\pgf@x\tanquarterarc\pgf@x% tan(a/4)
			\edef\controlscale{\pgfmath@tonumber{\pgf@x}}%
			%
			% Get the first control point for the first arc (length a/2)...
			%
			\pgfsavepgf@process\controlone{%
				%
				% k = 0.552284745 (a `magic' number)...
				%
				\pgf@x0.55228475pt\relax%
				\pgf@x\sinquarterarc\pgf@x% k * sin(a/2)
				\pgf@y0.55228475pt\relax%
				\pgf@y\cosquarterarc\pgf@y% k * cos(a/2)
				%
				% ...scale the control points up...
				%
				\pgf@x\controlscale\pgf@x%
				\pgf@y\controlscale\pgf@y%
				%
				% ...rotate...
				%
				\pgf@xa\cosarcrotate\pgf@x%
				\advance\pgf@xa-\sinarcrotate\pgf@y%
				\pgf@ya\cosarcrotate\pgf@y%
				\advance\pgf@ya\sinarcrotate\pgf@x%
				%
				% ...and shift.
				%
				\arcstartpoint%
				\advance\pgf@x\pgf@xa%
				\advance\pgf@y\pgf@ya%
			}%
			%
			% Get the midpoint of the 150° arc.
			%
			\pgfsavepgf@process\arcmidpoint{%
				\pgfsavepgf@process\arcmidpoint{%
					\pgf@x-\halfchordlength\relax%
					\pgf@y\segmentheight\relax%
				}%
				\pgfpointadd{\arcstartpoint}{%
					\pgfmathrotatepointaround{\arcmidpoint}{\pgfpointorigin}{\arcslope}%
				}%
			}%
			%
			% Get the second control point for the first arc (length a/2)...
			%
			\pgfsavepgf@process\controltwo{%		
				\pgf@x0.55228475pt\relax%
				\pgf@x\sinquarterarc\pgf@x%  k * sin(a/2)
				\pgf@y-0.55228475pt\relax%
				\pgf@y\cosquarterarc\pgf@y% -k * cos(a/2)		
				%
				% ...scale, rotate and shift.
				%
				\pgf@x\controlscale\pgf@x%
				\pgf@y\controlscale\pgf@y%
				%
				\pgf@xa\cosarcrotate\pgf@x%
				\advance\pgf@xa-\sinarcrotate\pgf@y%
				\pgf@ya\cosarcrotate\pgf@y%
				\advance\pgf@ya\sinarcrotate\pgf@x%
				%
				\arcmidpoint%
				\advance\pgf@x\pgf@xa%
				\advance\pgf@y\pgf@ya%
			}%
			{%
				\pgfsetcornersarced{\pgfpointorigin}%
				\pgfpathcurveto{\controlone}{\controltwo}{\arcmidpoint}%
			}%
			%
			% Do the same for the second arc...
			%
			\pgfmathadd@{\quarterarc}{90}%
			\pgfmathadd@{\pgfmathresult}{\arcslope}%
			\let\arcrotate\pgfmathresult%
			\pgfmathsin@{\arcrotate}%
			\let\sinarcrotate\pgfmathresult%
			\pgfmathcos@{\arcrotate}%
			\let\cosarcrotate\pgfmathresult%
			%
			% First control point for the second arc...
			%
			\pgfsavepgf@process\controlone{%				
				\pgf@x0.55228475pt\relax%
				\pgf@x\sinquarterarc\pgf@x% k * sin(a/2)
				\pgf@y0.55228475pt\relax%
				\pgf@y\cosquarterarc\pgf@y% k * cos(a/2)
				%
				% ...scale, rotate and shift.
				%
				\pgf@x\controlscale\pgf@x%
				\pgf@y\controlscale\pgf@y%
				%
				\pgf@xa\cosarcrotate\pgf@x%
				\advance\pgf@xa-\sinarcrotate\pgf@y%
				\pgf@ya\cosarcrotate\pgf@y%
				\advance\pgf@ya\sinarcrotate\pgf@x%
				%
				\arcmidpoint%
				\advance\pgf@x\pgf@xa%
				\advance\pgf@y\pgf@ya%
			}%
			%
			% Second control point for the second arc.
			%
			\pgfsavepgf@process\controltwo{%				
				\pgf@x0.55228475pt\relax%
				\pgf@x\sinquarterarc\pgf@x%  k * sin(a/2)
				\pgf@y-0.55228475pt\relax%
				\pgf@y\cosquarterarc\pgf@y% -k * cos(a/2)		
				%
				% ...scale, rotate and shift.
				%
				\pgf@x\controlscale\pgf@x%
				\pgf@y\controlscale\pgf@y%
				%
				\pgf@xa\cosarcrotate\pgf@x%
				\advance\pgf@xa-\sinarcrotate\pgf@y%
				\pgf@ya\cosarcrotate\pgf@y%
				\advance\pgf@ya\sinarcrotate\pgf@x%
				%
				\arcendpoint%
				\advance\pgf@x\pgf@xa%
				\advance\pgf@y\pgf@ya%
			}%
			\pgfpathcurveto{\controlone}{\controltwo}{\arcendpoint}%
			\repeatpgfmathloop%
		\pgfpathclose% Phew!
	}%
	%
	% Calculate a point on the border of the cloud. This is a two-stage process:
	%
	% 1. Locate the correct puff.
	% 2. Locate the angle on the circular arc which forms the puff.
	%
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
	 	%
		% Get the inner radii and trig. constants.
		%
		\getradii%		
		\gettrigconstants%
		%
		%
		%
		\ifpgfcloudanchorsuseellipse%
			\pgfpointadd{\centerpoint}{%
				\pgfpointborderellipse{%
					\pgfpoint{\externalx}{\externaly}
					}{%
						\pgfpoint{\xouterradius}{\youterradius}
					}%
			}%
		\else%
			\pgfsavepgf@process\externalpoint{%
				\centerpoint%
				\advance\pgf@x\externalx\relax%
				\advance\pgf@y\externaly\relax%
			}%
			\pgfmathanglebetweenpoints{\centerpoint}{\externalpoint}%
			\let\externalangle\pgfmathresult%
			%
			% 1. Locate the correct puff: 
			%
			% Get end angle of the relavent puff arc.
			%
			\pgfmathdivide@{\anglestep}{2}%
			\let\halfanglestep\pgfmathresult%
			\pgfmathsubtract@{90}{\halfanglestep}%
			\let\endangle\pgfmathresult%
			\pgfmathloop%
				\pgfmathsubtract@{\endangle}{\anglestep}%
				\ifdim\pgfmathresult pt<-\anglestep pt\relax%
				\else%
					\let\endangle\pgfmathresult%
			\repeatpgfmathloop%
			\def\angle{0}%
			\let\lastangle\angle%
			\pgfmathloop%
				\pgfmathadd@{\endangle}{\anglestep}%
				\let\endangle\pgfmathresult%
				%
				% Calculate the `miter point'. This is the point between 
				% each puff, and takes into account the outer sep.
				%
				\pgfsavepgf@process\miterpoint{%
					%
					\pgfsavepgf@process\secondpoint{%
						\pgfpointpolar{+\endangle}{+\xinnerradius and +\yinnerradius}%
					}%
					%
					\pgfmathadd@{\endangle}{\anglestep}%
					\let\angletemp\pgfmathresult%
					\pgfsavepgf@process\thirdpoint{%
						\pgfpointpolar{+\angletemp}{+\xinnerradius and +\yinnerradius}%
					}%
					%
					\pgfmathsubtract@{\endangle}{\anglestep}%
					\let\angletemp\pgfmathresult%
					\pgfsavepgf@process\firstpoint{%
						\pgfpointpolar{+\angletemp}{+\xinnerradius and +\yinnerradius}%
					}%
					%
					\pgfmathanglebetweenpoints{\firstpoint}{\secondpoint}%
					\let\anglealpha\pgfmathresult%
					\pgfmathanglebetweenpoints{\secondpoint}{\thirdpoint}%
					\let\anglebeta\pgfmathresult%
					%
					\pgfmathsubtract@{\anglebeta}{\anglealpha}%
					\pgfmathdivide@{\pgfmathresult}{2}%
					\pgfmathadd@{\pgfmathresult}{\halfcomplementarc}%
					\pgfmathcosec@{\pgfmathresult}%
					\pgf@x\outersep\relax%
					\pgf@x\pgfmathresult\pgf@x%
					\edef\miterradius{\the\pgf@x}%
					%
					\pgfmathadd@{\anglealpha}{\anglebeta}%
					\pgfmathsubtract@{\pgfmathresult}{180}%
					\pgfmathdivide@{\pgfmathresult}{2}%
					\let\miterangle\pgfmathresult%
					\pgfpointadd{\secondpoint}{%
						\pgfqpointpolar{\miterangle}{\miterradius}%
					}%
				}%
				%
				% Get the angle of the miter point...
				%
				\pgfmathanglebetweenpoints{\pgfpointorigin}{\miterpoint}%
				\let\angle\pgfmathresult%
				\ifdim\angle pt<\lastangle pt\relax% Guard against 360° = 0°
					\pgfmathadd@{\angle}{360}%
					\let\angle\pgfmathresult%
				\fi%
				\let\lastangle\angle%
				%
				% ...and see if it is greater than the external point.
				%
			\ifdim\externalangle pt>\angle pt\relax%
			\repeatpgfmathloop%
			%
			% Get the start angle of the relevant arc and ensure angles are in the range.
			%
			\pgfmathmod@{\endangle}{360}%
			\let\endangle\pgfmathresult%
			\pgfmathsubtract@{\endangle}{\anglestep}%
			\ifdim\pgfmathresult pt<0pt\relax%
				\pgfmathadd@{\pgfmathresult}{360}%
			\fi%
			\let\startangle\pgfmathresult%
			%
			% Now, get the start and end points of the arc.
			%
			\pgfsavepgf@process\arcstartpoint{%
				\pgfpointadd{\centerpoint}{%
					\pgfpointpolar{+\startangle}{+\xinnerradius and +\yinnerradius}%
				}%
			}%	
			\pgfsavepgf@process\arcendpoint{%
				\pgfpointadd{\centerpoint}{%
					\pgfpointpolar{+\endangle}{+\xinnerradius and +\yinnerradius}%
				}%
			}%	
			%
			% Get some useful cloud parameters from \arcstartpoint and \arcendpoint.
			%
			\pgf@sh@getcloudpuffparameters%
			%
			% Hackery, for when an arc straddles 0°.
			%
			\ifdim\endangle pt<\startangle pt\relax%
				\pgfmathadd@{\externalangle}{180}%
				\pgfmathmod@{\pgfmathresult}{360}%
				\let\x\pgfmathresult%
			\else%
				\let\x\externalangle%
			\fi%
			%
			% 2. Locate the angle on the circular arc which forms the puff.
			% 
			% Essentially a binary search to find the angle on the circular  
			% arc, which provides the nearset estimate to the border point.
			%
			\let\s\halfcomplementarc% The start of the arc.
			\pgfmathadd@{\s}{\arc}%
			\let\e\pgfmathresult% The end of the arc.
			\pgfmathadd@{\e}{\s}%
			\pgfmathdivide@{\pgfmathresult}{2}%
			\let\n\pgfmathresult% The nearest estimate (default to middle of arc).
			\def\m{360}% Measure of `nearness'.
			\pgfmathloop%
				\pgfmathadd@{\e}{\s}%
				\pgfmathdivide@{\pgfmathresult}{2}%
				\let\p\pgfmathresult% The point halfway between \s and \e.
				\ifdim\p pt=\s pt\relax% 
				\else%
					%
					% Get the point on the circular arc.
					%
					\pgfmathadd@{\p}{\arcslope}%
					\let\a\pgfmathresult%
					\pgfsavepgf@process\arcpoint{%
						\pgfpointadd{\circlecenterpoint}{%
							\pgfqpointpolar{\a}{\outerarcradius}%
						}%
					}%
					%
					% Find the angle between the node centre and the point on the arc.
					%
					\pgfmathanglebetweenpoints{\centerpoint}{\arcpoint}%
					%
					% Hackery, for when an arc straddles 0°.
					%
					\ifdim\endangle pt<\startangle pt\relax%
						\pgfmathadd@{\pgfmathresult}{180}%
						\pgfmathmod@{\pgfmathresult}{360}%
					\fi%
					\let\q\pgfmathresult%
					\ifdim\x pt=\q pt% Found it!
						\pgfmathbreakloop% Breaks after current iteration is complete.
					\else
						\ifdim\x pt<\q pt\relax%
							\let\e\p%
						\else%
							\let\s\p%
						\fi%
					\fi%
					\pgfmathsubtract@{\x}{\q}%
					\pgfmathabs@{\pgfmathresult}%
					%
					% Save the estimate if it is better than any previous estimate.
					%
					\ifdim\pgfmathresult pt<\m pt\relax%
						\let\m\pgfmathresult%
						\let\n\p%
					\fi%				
			\repeatpgfmathloop%
			%
			% Use the nearest estimate as the anchor angle.
			%
			\pgfmathadd@{\n}{\arcslope}%
			\let\anchorangle\pgfmathresult%
			%
			% Finally, the required point.
			%
			\pgfpointadd{\circlecenterpoint}{%
				\pgfqpointpolar{\anchorangle}{\outerarcradius}%
			}%
		\fi%
	}% Again, Phew!
	%
	% Now, a sneaky hack. This means an arbitrary `puff' anchors 
	% can be used for positiong the cloud shape. This is needed
	% if a cloud is positioned using the `puff <n+1>' anchor, where
	% n is the number of puffs of any previously drawn cloud.
	%
	\pgfutil@g@addto@macro\pgf@sh@s@cloud{%
		\c@pgf@counta\puffs\relax%
		\pgfmathloop%
			\ifnum\c@pgf@counta>0\relax%
				\pgfutil@ifundefined{pgf@anchor@cloud@puff\space\the\c@pgf@counta}{%
				\expandafter\xdef\csname pgf@anchor@cloud@puff\space\the\c@pgf@counta\endcsname{%
					\noexpand\pgf@sh@@cloudpuffanchor{\the\c@pgf@counta}%
				}%
			}{\c@pgf@counta0\relax}%
			\advance\c@pgf@counta-1\relax%
		\repeatpgfmathloop%	
	}%
}

% \pgf@sh@@cloudpuffanchor
% 
% Internal macro for calculating the anchors puff 1, puff 2, ... etc.
%
\def\pgf@sh@@cloudpuffanchor#1{%
		\pgfmathdivide@{\anglestep}{2}%
		\let\halfanglestep\pgfmathresult%
		\c@pgf@counta#1\relax%
		\advance\c@pgf@counta-1\relax%
		\pgfmathmultiply@{\anglestep}{\the\c@pgf@counta}%
		\pgfmathadd@{\pgfmathresult}{90}%
		\pgfmathsubtract@{\pgfmathresult}{\halfanglestep}%
		\let\angle\pgfmathresult%
		\getradii%
		%
		% Calculate the first arc point.
		%
		\pgfsavepgf@process\arcstartpoint{%
			\pgfpointadd{\centerpoint}{%
				\pgfpointpolar{+\angle}{+\xinnerradius and +\yinnerradius}%
			}%
		}%
		%
		\gettrigconstants%
		\pgfmathadd@{\angle}{\anglestep}%
		\let\angle\pgfmathresult%
		\pgfsavepgf@process\arcendpoint{%
			\pgfpointadd{\centerpoint}{%
				\pgfpointpolar{+\angle}{+\xinnerradius and +\yinnerradius}%
			}%
		}%	
		%
		% Get some useful cloud parameters from \arcstartpoint and \arcendpoint.
		%
		\pgf@sh@getcloudpuffparameters%
		%
		% Calculate the point.
		%
		\pgfmathadd@{\arcslope}{90}%
		\let\anchorangle\pgfmathresult%
		\pgfpointadd{\circlecenterpoint}{%
			\pgfqpointpolar{\anchorangle}{\outerarcradius}%
		}%
}  

% \pgf@sh@cloudpuffparameters
%
% Internal macro to calculate some common arc parameters which 
% are required when calculating radii, drawing the background
% path and calculating border anchors.
%
\def\pgf@sh@getcloudpuffparameters{%
  %
	% Calculate the angle to which the entire arc is sloped.
	%
	\pgfmathanglebetweenpoints{\arcendpoint}{\arcstartpoint}%
	\let\arcslope\pgfmathresult%
	%
  % Calculate the chord length and arc radius.
  %
  \pgfpointdiff{\arcendpoint}{\arcstartpoint}%
  \pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@y}}
  \pgf@x\pgfmathresult pt\relax%
  \pgf@xa.5\pgf@x%
  \edef\halfchordlength{\the\pgf@xa}%
	\pgf@x\arcradiusquotient\pgf@x%
  \edef\arcradius{\the\pgf@x}%
  \pgf@xa\outersep\relax%
  \advance\pgf@xa\pgf@x%
  \edef\outerarcradius{\the\pgf@xa}%
  %
  % Calculate the height of the resulting segment.
  %
  \pgf@y-\sinhalfcomplementarc\pgf@x% sin((180-a)/2)
  \advance\pgf@y\pgf@x%
  \edef\segmentheight{\the\pgf@y}%
  %
  % Calculate the center of the circle of which the arc is a part.
  %
  \pgfsavepgf@process\circlecenterpoint{%
    \pgfsavepgf@process\circlecenterpoint{%
      \pgf@x-\halfchordlength\relax%
      \pgf@y\segmentheight\relax%
      \advance\pgf@y-\arcradius
    }%
    \pgfpointadd{\arcstartpoint}{%
      \pgfmathrotatepointaround{\circlecenterpoint}{\pgfpointorigin}{\arcslope}%
    }%
  }%
}





% Keys for signal shape:
%
% /pgf/signal pointer angle
% /pgf/signal from
% /pgf/signal to
%
\pgfkeys{/pgf/signal pointer angle/.code={%
		\pgfmathparse{#1}%
		\pgfmathmod@{\pgfmathresult}{360}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		\pgfkeyslet{/pgf/signal pointer angle}{\pgfmathresult}%
	}%
}		
\pgfkeys{/pgf/signal pointer angle=90}

\pgfkeys{/pgf/signal direction/north/.code={%
		\pgfkeyssetvalue{/pgf/signal direction/north}{#1}%
		\ifnum#1=0\relax%
		\else%
			\pgfkeyssetvalue{/pgf/signal direction/east}{0}% I am not keen on numerical constants,
			\pgfkeyssetvalue{/pgf/signal direction/west}{0}% Oh well...
		\fi%
	}%
}

\pgfkeys{/pgf/signal direction/south/.code={%
		\pgfkeyssetvalue{/pgf/signal direction/south}{#1}%
		\ifnum#1=0\relax%
		\else%
			\pgfkeyssetvalue{/pgf/signal direction/east}{0}%
			\pgfkeyssetvalue{/pgf/signal direction/west}{0}%
		\fi%
	}%
}

\pgfkeys{/pgf/signal direction/east/.code={%
		\pgfkeyssetvalue{/pgf/signal direction/east}{#1}%
		\ifnum#1=0\relax%
		\else%
			\pgfkeyssetvalue{/pgf/signal direction/south}{0}%
			\pgfkeyssetvalue{/pgf/signal direction/north}{0}%
		\fi%
	}%
}

\pgfkeys{/pgf/signal direction/west/.code={%
		\pgfkeyssetvalue{/pgf/signal direction/west}{#1}%
		\ifnum#1=0\relax%
		\else%
			\pgfkeyssetvalue{/pgf/signal direction/north}{0}%
			\pgfkeyssetvalue{/pgf/signal direction/south}{0}%
		\fi%
	}%
}
\pgfkeys{/pgf/signal direction/.cd, north=0, south=0, east=0, west=0}

\pgfkeys{/pgf/signal from/.cd,
		.code={%
			\pgfutil@in@{and}{#1}%
			\ifpgfutil@in@
				\def\pgf@marshall##1 and##2\@@{%
					\pgfkeys{/pgf/signal from/.cd,##1,##2}%
				}%
				\pgf@marshall#1\@@%
			\else%
				\pgfkeys{/pgf/signal from/#1}
			\fi%
		},
		north/.style={/pgf/signal direction/north=-1},
		south/.style={/pgf/signal direction/south=-1},
		east/.style={/pgf/signal direction/east=-1},
		west/.style={/pgf/signal direction/west=-1},
		above/.style={/pgf/signal direction/north=-1},
		below/.style={/pgf/signal direction/south=-1},
		left/.style={/pgf/signal direction/east=-1},
		right/.style={/pgf/signal direction/west=-1},
		nowhere/.code={%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/north}<0\relax%
				\pgfkeys{/pgf/signal direction/north=0}%
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/south}<0\relax%
				\pgfkeys{/pgf/signal direction/south=0}%
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/east}<0\relax%
				\pgfkeys{/pgf/signal direction/east=0}%
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/west}<0\relax%
				\pgfkeys{/pgf/signal direction/west=0}%
			\fi%
		}%		
}%

\pgfkeys{/pgf/signal to/.cd,
		.code={%
			\pgfutil@in@{and}{#1}%
			\ifpgfutil@in@
				\def\pgf@marshall##1 and##2\@@{%
					\pgfkeys{/pgf/signal to/.cd,##1,##2}%
				}%
				\pgf@marshall#1\@@%
			\else%
				\pgfkeys{/pgf/signal to/#1}
			\fi%
		},
		north/.style={/pgf/signal direction/north=1},
		south/.style={/pgf/signal direction/south=1},
		east/.style={/pgf/signal direction/east=1},
		west/.style={/pgf/signal direction/west=1},
		above/.style={/pgf/signal direction/north=1},
		below/.style={/pgf/signal direction/south=1},
		left/.style={/pgf/signal direction/east=1},
		right/.style={/pgf/signal direction/west=1},
		nowhere/.code={%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/north}>0\relax%
				\pgfkeys{/pgf/signal direction/north=0}%
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/south}>0\relax%
				\pgfkeys{/pgf/signal direction/south=0}%
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/east}>0\relax%
				\pgfkeys{/pgf/signal direction/east=0}%
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/west}>0\relax%
				\pgfkeys{/pgf/signal direction/west=0}%
			\fi%
		}%			
}%

\pgfkeys{/pgf/signal from=nowhere, /pgf/signal to=left}

	
% Shape signal
%
%
\pgfdeclareshape{signal}{%
	\savedmacro\installsignalparameters{%
		%
		% Define a centerpoint.
		%
		\pgfsavepgf@process\centerpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
			\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
		}%
		%
		% Get some useful trig. stuff
		%
		\pgfkeysgetvalue{/pgf/signal pointer angle}{\pointerangle}%
		\pgfmathdivide@{\pointerangle}{2}%
		\let\halfpointerangle\pgfmathresult%
		\pgfmathcosec@{\halfpointerangle}%
		\let\cosechalfpointerangle\pgfmathresult%
		\pgfmathdivide@{\halfpointerangle}{2}%
		\let\quarterpointerangle\pgfmathresult%
		\pgfmathcosec@{\quarterpointerangle}%
		\let\cosecquarterpointerangle\pgfmathresult%
		\pgfmathsec@{\quarterpointerangle}%
		\let\secquarterpointerangle\pgfmathresult%
		\pgfmathsubtract@{90}{\quarterpointerangle}%
		\let\complementquarterpointerangle\pgfmathresult%
		%
		% Get the larger of the outer sep.
		%
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/outer xsep}}%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
		\ifdim\pgf@x>\pgf@y%
			\pgf@y\pgf@x%
		\fi%
		\pgf@yc\pgf@y%
		%
		% Calculate the miter due to the line width, at the pointer apex... 
		%
		\pgf@x\cosechalfpointerangle\pgf@y%
		\edef\pointerapexmiter{\the\pgf@x}%
		%
		% ...at a corner by a `to' pointer (i.e. sticks out)...
		%
		\pgf@x\secquarterpointerangle\pgf@y%
		\edef\tocornermiter{\the\pgf@x}%
		%
		% ...at a corner by a `from' pointer (i.e. sticks in).
		%
		\pgf@x\cosecquarterpointerangle\pgf@y
		\edef\fromcornermiter{\the\pgf@x}%
		%
		% Get the (half) dimensions of the node.
		%
		\pgfmathsetlength\pgf@xa{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\pgfmathaddtolength\pgf@xa{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@ya{+\pgfkeysvalueof{/pgf/inner ysep}}%
		\pgfmathaddtolength\pgf@ya{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@ya{+.5\dp\pgfnodeparttextbox}%
		%
		% Get the distance a pointer sticks out to the side...
		%
		\pgfmathsubtract@{90}{\halfpointerangle}%
		\pgfmathtan@{\pgfmathresult}%
		\pgf@xb\pgfmathresult\pgf@ya%
		% 
		% ...and up.
		%
		\pgf@yb\pgfmathresult\pgf@xa%
		%
		% Adjust for minimum height.
		%
		\pgfutil@tempdima2.0\pgf@ya%
		\ifnum\pgfkeysvalueof{/pgf/signal direction/north}=0\relax%
		\else%
			\advance\pgfutil@tempdima\pgf@yb%
		\fi%
		\ifnum\pgfkeysvalueof{/pgf/signal direction/south}=0\relax%
		\else%
			\advance\pgfutil@tempdima\pgf@yb%
		\fi%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/minimum height}}%
		\ifdim\pgfutil@tempdima<\pgf@y%
			\pgfmathreciprocal@{\pgfmath@tonumber{\pgfutil@tempdima}}%
			\pgfutil@tempdima\pgfmathresult\pgf@y%
			\pgf@xa\pgfmath@tonumber{\pgfutil@tempdima}\pgf@xa%
			\pgf@ya\pgfmath@tonumber{\pgfutil@tempdima}\pgf@ya%
			\pgf@xb\pgfmath@tonumber{\pgfutil@tempdima}\pgf@xb%
			\pgf@yb\pgfmath@tonumber{\pgfutil@tempdima}\pgf@yb%
		\fi%
		%
		% Adjust for minimum width.
		%
		\pgfutil@tempdima2.0\pgf@xa%
		\ifnum\pgfkeysvalueof{/pgf/signal direction/east}=0\relax%
		\else%
			\advance\pgfutil@tempdima\pgf@xb%
		\fi%
		\ifnum\pgfkeysvalueof{/pgf/signal direction/west}=0\relax%
		\else%
			\advance\pgfutil@tempdima\pgf@xb%
		\fi%
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/minimum width}}%
		\ifdim\pgfutil@tempdima<\pgf@x%
			\pgfmathreciprocal@{\pgfmath@tonumber{\pgfutil@tempdima}}%
			\pgfutil@tempdima\pgfmathresult\pgf@x%
			\pgf@xa\pgfmath@tonumber{\pgfutil@tempdima}\pgf@xa%
			\pgf@ya\pgfmath@tonumber{\pgfutil@tempdima}\pgf@ya%
			\pgf@xb\pgfmath@tonumber{\pgfutil@tempdima}\pgf@xb%
			\pgf@yb\pgfmath@tonumber{\pgfutil@tempdima}\pgf@yb%
		\fi%
		%
		% So, define the points for the background path.
		%
		\pgfsavepgf@process\north{%
			\centerpoint%
			\advance\pgf@y\pgf@ya%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/north}>0\relax%
				\advance\pgf@y\pgf@yb%
			\fi%
		}%
		\pgfsavepgf@process\south{%
			\centerpoint%
			\advance\pgf@y-\pgf@ya%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/south}>0\relax%
				\advance\pgf@y-\pgf@yb%
			\fi%
		}%
		\pgfsavepgf@process\east{%
			\centerpoint%
			\advance\pgf@x\pgf@xa%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/east}>0\relax%
				\advance\pgf@x\pgf@xb%
			\fi%
		}%
		\pgfsavepgf@process\west{%
			\centerpoint%
			\advance\pgf@x-\pgf@xa%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/west}>0\relax%
				\advance\pgf@x-\pgf@xb%
			\fi%
		}%
		\pgfsavepgf@process\northeast{%
			\centerpoint%
			\advance\pgf@y\pgf@ya%
			\advance\pgf@x\pgf@xa%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/north}<0\relax%
				\advance\pgf@y\pgf@yb%
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/east}<0\relax%
				\advance\pgf@x\pgf@xb%
			\fi%
		}%
		\pgfsavepgf@process\southeast{%
			\centerpoint%
			\advance\pgf@y-\pgf@ya%
			\advance\pgf@x\pgf@xa%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/south}<0\relax%
				\advance\pgf@y-\pgf@yb%
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/east}<0\relax%
				\advance\pgf@x\pgf@xb%
			\fi%
		}%
		\pgfsavepgf@process\southwest{%
			\centerpoint%
			\advance\pgf@y-\pgf@ya%
			\advance\pgf@x-\pgf@xa%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/south}<0\relax%
				\advance\pgf@y-\pgf@yb%
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/west}<0\relax%
				\advance\pgf@x-\pgf@xb%
			\fi%
		}%
		\pgfsavepgf@process\northwest{%
			\centerpoint%
			\advance\pgf@y\pgf@ya%
			\advance\pgf@x-\pgf@xa%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/north}<0\relax%
				\advance\pgf@y\pgf@yb%
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/west}<0\relax%
				\advance\pgf@x-\pgf@xb%
			\fi%
		}%
		\addtosavedmacro{\north}%
		\addtosavedmacro{\south}%
		\addtosavedmacro{\east}%
		\addtosavedmacro{\west}%
		\addtosavedmacro{\northeast}%
		\addtosavedmacro{\southwest}%
		\addtosavedmacro{\southeast}%
		\addtosavedmacro{\northwest}%
		%
		% Calculate the `miter vectors' (i.e. +outer sep). 
		%
		\pgfsavepgf@process\northmiter{%
			\pgf@x0pt%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/north}=0\relax%
				\pgf@y\pgf@yc%
			\else%
				\pgf@y\pointerapexmiter\relax%
			\fi%
		}%
		\pgfsavepgf@process\southmiter{%
			\pgf@x0pt%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/north}=0\relax%
				\pgf@y-\pgf@yc%
			\else%
				\pgf@y-\pointerapexmiter\relax%
			\fi%
		}%
		\pgfsavepgf@process\eastmiter{%
			\pgf@y0pt%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/east}=0\relax%
				\pgf@x\pgf@yc%
			\else%
				\pgf@x\pointerapexmiter\relax%
			\fi%
		}%
		\pgfsavepgf@process\westmiter{%
			\pgf@y0pt%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/west}=0\relax%
				\pgf@x-\pgf@yc%
			\else%
				\pgf@x-\pointerapexmiter\relax%
			\fi%
		}%
		\pgfsavepgf@process\northeastmiter{%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/east}=0\relax%
				\pgf@x\pgf@yc
				\pgf@y\pgf@yc%
			\else
				\ifnum\pgfkeysvalueof{/pgf/signal direction/east}<0\relax%
					\pgfqpointpolar{\quarterpointerangle}{\fromcornermiter}
				\else%
					\ifnum\pgfkeysvalueof{/pgf/signal direction/east}>0\relax%
						\pgfqpointpolar{\complementquarterpointerangle}{\tocornermiter}%
					\fi%
				\fi%	
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/north}<0\relax%
				\pgfqpointpolar{\complementquarterpointerangle}{\fromcornermiter}
			\else%
				\ifnum\pgfkeysvalueof{/pgf/signal direction/north}>0\relax%
					\pgfqpointpolar{\quarterpointerangle}{\tocornermiter}%
				\fi%
			\fi%	
		}%
		\pgfsavepgf@process\southeastmiter{%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/east}=0\relax%
				\pgf@x\pgf@yc%
				\pgf@y\pgf@yc%
			\else
				\ifnum\pgfkeysvalueof{/pgf/signal direction/east}<0\relax%
					\pgfqpointpolar{-\quarterpointerangle}{\fromcornermiter}
				\else%
					\ifnum\pgfkeysvalueof{/pgf/signal direction/east}>0\relax%
						\pgfqpointpolar{-\complementquarterpointerangle}{\tocornermiter}%
					\fi%
				\fi%	
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/south}<0\relax%
				\pgfqpointpolar{-\complementquarterpointerangle}{\fromcornermiter}
			\else%
				\ifnum\pgfkeysvalueof{/pgf/signal direction/south}>0\relax%
					\pgfqpointpolar{-\quarterpointerangle}{\tocornermiter}%
				\fi%
			\fi%	
		}%
		\pgfsavepgf@process\southwestmiter{%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/west}=0\relax%
				\pgf@x-\pgf@yc
				\pgf@y-\pgf@yc%
			\else
				\ifnum\pgfkeysvalueof{/pgf/signal direction/west}<0\relax%
					\pgfmathadd@{\quarterpointerangle}{180}%
					\expandafter\pgfqpointpolar\expandafter{\pgfmathresult}{\fromcornermiter}
				\else%
					\ifnum\pgfkeysvalueof{/pgf/signal direction/west}>0\relax%
						\pgfmathadd@{\complementquarterpointerangle}{180}%
						\expandafter\pgfqpointpolar\expandafter{\pgfmathresult}{\tocornermiter}%
					\fi%
				\fi%	
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/south}<0\relax%
				\pgfmathadd@{\complementquarterpointerangle}{180}%
				\expandafter\pgfqpointpolar\expandafter{\pgfmathresult}{\fromcornermiter}%
			\else%
				\ifnum\pgfkeysvalueof{/pgf/signal direction/south}>0\relax%
					\pgfmathadd@{\quarterpointerangle}{180}%
					\expandafter\pgfqpointpolar\expandafter{\pgfmathresult}{\tocornermiter}%
				\fi%
			\fi%	
		}%
		\pgfsavepgf@process\northwestmiter{%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/west}=0\relax%
				\pgf@x-\pgf@yc%
				\pgf@y\pgf@yc%
			\else
				\ifnum\pgfkeysvalueof{/pgf/signal direction/west}<0\relax%
					\pgfmathsubtract@{180}{\quarterpointerangle}%
					\expandafter\pgfqpointpolar\expandafter{\pgfmathresult}{\fromcornermiter}
				\else%
					\ifnum\pgfkeysvalueof{/pgf/signal direction/west}>0\relax%
						\pgfmathsubtract@{180}{\complementquarterpointerangle}%
						\expandafter\pgfqpointpolar\expandafter{\pgfmathresult}{\tocornermiter}%
					\fi%
				\fi%	
			\fi%
			\ifnum\pgfkeysvalueof{/pgf/signal direction/north}<0\relax%
				\pgfmathsubtract@{180}{\complementquarterpointerangle}%
				\expandafter\pgfqpointpolar\expandafter{\pgfmathresult}{\fromcornermiter}%
			\else%
				\ifnum\pgfkeysvalueof{/pgf/signal direction/north}>0\relax%
					\pgfmathsubtract@{180}{\quarterpointerangle}%
					\expandafter\pgfqpointpolar\expandafter{\pgfmathresult}{\tocornermiter}%
				\fi%
			\fi%	
		}%
		\addtosavedmacro{\northmiter}%
		\addtosavedmacro{\southmiter}%
		\addtosavedmacro{\eastmiter}%
		\addtosavedmacro{\westmiter}%
		\addtosavedmacro{\northeastmiter}%
		\addtosavedmacro{\southeastmiter}%
		\addtosavedmacro{\southwestmiter}%
		\addtosavedmacro{\northwestmiter}%
		%
		% Now calculate the anchor points
		%
		\pgfsavepgf@process\anchornorth{%
			\pgfpointadd{\north}{\northmiter}%
		}%
		\pgfsavepgf@process\anchorsouth{%
			\pgfpointadd{\south}{\southmiter}%
		}%
		\pgfsavepgf@process\anchoreast{%
			\pgfpointadd{\east}{\eastmiter}%
		}%
		\pgfsavepgf@process\anchorwest{%
			\pgfpointadd{\west}{\westmiter}%
		}%
		\pgfsavepgf@process\anchornortheast{%
			\pgfpointadd{\northeast}{\northeastmiter}%
		}%
		\pgfsavepgf@process\anchorsoutheast{%
			\pgfpointadd{\southeast}{\southeastmiter}%
		}%
		\pgfsavepgf@process\anchorsouthwest{%
			\pgfpointadd{\southwest}{\southwestmiter}%
		}%
		\pgfsavepgf@process\anchornorthwest{%
			\pgfpointadd{\northwest}{\northwestmiter}%
		}%
		\addtosavedmacro{\anchornorth}%
		\addtosavedmacro{\anchorsouth}%
		\addtosavedmacro{\anchoreast}%
		\addtosavedmacro{\anchorwest}%
		\addtosavedmacro{\anchornortheast}%
		\addtosavedmacro{\anchorsouthwest}%
		\addtosavedmacro{\anchorsoutheast}%
		\addtosavedmacro{\anchornorthwest}%		
	}%
	\savedanchor\centerpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
	}%
	\savedanchor\basepoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgf@y0pt%
	}%
	\savedanchor\midpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}%
	\anchor{center}{\centerpoint}%
	\anchor{base}{\basepoint}%
	\anchor{base east}{%
		\installsignalparameters%
		\anchoreast%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\anchorsoutheast%
		\ifdim\pgf@xa>\pgf@x%
			\pgfutil@tempdima\pgf@xa%
		\else%
			\pgfutil@tempdima\pgf@x%
		\fi%
		\pgfsavepgf@process\externalpoint{%
			\basepoint%
			\pgf@x\pgfutil@tempdima%
		}
		\basepoint%
		\let\firstpoint\anchoreast%
		\ifdim\pgf@y<\pgf@ya%
			\let\secondpoint\anchorsoutheast%
		\else%
			\let\secondpoint\anchornortheast%
		\fi%
		\pgfpointintersectionoflines{\basepoint}{\externalpoint}%
			{\firstpoint}{\secondpoint}%		
	}%
	\anchor{base west}{%
		\installsignalparameters%
		\anchorwest%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\anchorsouthwest%
		\ifdim\pgf@xa<\pgf@x%
			\pgfutil@tempdima\pgf@xa%
		\else%
			\pgfutil@tempdima\pgf@x%
		\fi%
		\pgfsavepgf@process\externalpoint{%
			\basepoint%
			\pgf@x\pgfutil@tempdima%
		}
		\basepoint%
		\let\firstpoint\anchorwest%
		\ifdim\pgf@y<\pgf@ya%
			\let\secondpoint\anchorsouthwest%
		\else%
			\let\secondpoint\anchornorthwest%
		\fi%
		\pgfpointintersectionoflines{\basepoint}{\externalpoint}%
			{\firstpoint}{\secondpoint}%		
	}%
	\anchor{mid}{\midpoint}%
	\anchor{mid east}{%
		\installsignalparameters%
		\anchoreast%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\anchorsoutheast%
		\ifdim\pgf@xa>\pgf@x%
			\pgfutil@tempdima\pgf@xa%
		\else%
			\pgfutil@tempdima\pgf@x%
		\fi%
		\pgfsavepgf@process\externalpoint{%
			\midpoint%
			\pgf@x\pgfutil@tempdima%
		}
		\midpoint%
		\let\firstpoint\anchoreast%
		\ifdim\pgf@y<\pgf@ya%
			\let\secondpoint\anchorsoutheast%
		\else%
			\let\secondpoint\anchornortheast%
		\fi%
		\pgfpointintersectionoflines{\midpoint}{\externalpoint}%
			{\firstpoint}{\secondpoint}%		
	}%
	\anchor{mid west}{%
		\installsignalparameters%
		\anchorwest%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\anchorsouthwest%
		\ifdim\pgf@xa<\pgf@x%
			\pgfutil@tempdima\pgf@xa%
		\else%
			\pgfutil@tempdima\pgf@x%
		\fi%
		\pgfsavepgf@process\externalpoint{%
			\midpoint%
			\pgf@x\pgfutil@tempdima%
		}
		\midpoint%
		\let\firstpoint\anchorwest%
		\ifdim\pgf@y<\pgf@ya%
			\let\secondpoint\anchorsouthwest%
		\else%
			\let\secondpoint\anchornorthwest%
		\fi%
		\pgfpointintersectionoflines{\midpoint}{\externalpoint}%
			{\firstpoint}{\secondpoint}%		
	}%
	\anchor{north}{\installsignalparameters\anchornorth}%
	\anchor{south}{\installsignalparameters\anchorsouth}%
	\anchor{east}{\installsignalparameters\anchoreast}%
	\anchor{west}{\installsignalparameters\anchorwest}%
	\anchor{north east}{\installsignalparameters\anchornortheast}%
	\anchor{south east}{\installsignalparameters\anchorsoutheast}%
	\anchor{south west}{\installsignalparameters\anchorsouthwest}%
	\anchor{north west}{\installsignalparameters\anchornorthwest}%
	\backgroundpath{%
		\installsignalparameters%
		\pgfpathmoveto{\north}%
		\pgfpathlineto{\northeast}%
		\pgfpathlineto{\east}%
		\pgfpathlineto{\southeast}%
		\pgfpathlineto{\south}%
		\pgfpathlineto{\southwest}%
		\pgfpathlineto{\west}%
		\pgfpathlineto{\northwest}%
		\pgfpathclose%
	}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% Adjust the location of the external 
		% point relative to \centerpoint.
		%
		\centerpoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Get the shape parameters.
		%
		\installsignalparameters%
		%
		% Get the angle of the external point to the \centerpoint.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
		\let\externalangle\pgfmathresult%
		%
		%
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\anchorwest}%
		\ifdim\externalangle pt<\pgfmathresult pt\relax%
			\pgfmathanglebetweenpoints{\centerpoint}{\anchornorth}%
			\ifdim\externalangle pt<\pgfmathresult pt\relax%
				\pgfmathanglebetweenpoints{\centerpoint}{\anchornortheast}%
				\ifdim\externalangle pt<\pgfmathresult pt\relax%
					\let\firstpoint\anchoreast%
					\let\secondpoint\anchornortheast%
				\else%
					\let\secondpoint\anchornortheast%
					\let\firstpoint\anchornorth%
				\fi%
			\else%
				\pgfmathanglebetweenpoints{\centerpoint}{\anchornorthwest}%
				\ifdim\externalangle pt<\pgfmathresult pt\relax%
					\let\firstpoint\anchornorth%
					\let\secondpoint\anchornorthwest%
				\else%
					\let\secondpoint\anchornorthwest%
					\let\firstpoint\anchorwest%
				\fi%
			\fi%
		\else%
			\pgfmathanglebetweenpoints{\centerpoint}{\anchorsouth}%
			\ifdim\externalangle pt<\pgfmathresult pt\relax%
				\pgfmathanglebetweenpoints{\centerpoint}{\anchorsouthwest}%
				\ifdim\externalangle pt<\pgfmathresult pt\relax%
					\let\firstpoint\anchorwest%
					\let\secondpoint\anchorsouthwest%
				\else%
					\let\secondpoint\anchorsouthwest%
					\let\firstpoint\anchorsouth%
				\fi%
			\else%
				\pgfmathanglebetweenpoints{\centerpoint}{\anchorsoutheast}%
				\ifdim\externalangle pt<\pgfmathresult pt\relax%
					\let\firstpoint\anchorsouth%
					\let\secondpoint\anchorsoutheast%
				\else%
					\let\secondpoint\anchorsoutheast%
					\let\firstpoint\anchoreast%
				\fi%
			\fi%
		\fi%
		%
		% Now locate the point.
		%
		\pgfpointintersectionoflines{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
			{\firstpoint}{\secondpoint}%
	}%
}%






% Keys for shape tape
%
% /pgf/tape bend top : Type of bend for north side.
% /pgf/tape bend bottom : Type of bend for south side.

% /pgf/tape bend height : The height of the bends.


% *hidden keys*
% These values are unimportant but *must* be different.
%
\pgfkeyssetvalue{/pgf/@tape bend/out and in}{1}
\pgfkeyssetvalue{/pgf/@tape bend/in and out}{2}
\pgfkeyssetvalue{/pgf/@tape bend/none}{0}

\pgfkeys{/pgf/tape bend top/.code={%
		\edef\pgf@temp{\pgfkeysvalueof{/pgf/@tape bend/#1}}%
		\pgfkeyslet{/pgf/tape bend top}{\pgf@temp}%
	}%
}

\pgfkeys{/pgf/tape bend bottom/.code={%
		\edef\pgf@temp{\pgfkeysvalueof{/pgf/@tape bend/#1}}%
		\pgfkeyslet{/pgf/tape bend bottom}{\pgf@temp}%
	}%
}



\pgfkeys{/pgf/tape bend height/.code={%
		\pgfmathparse{#1}%
		\edef\pgfmathresult{\pgfmathresult pt}%
		\pgfkeyslet{/pgf/tape bend height}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/tape bend height=5pt}

\pgfkeys{/pgf/tape bend top=in and out}
\pgfkeys{/pgf/tape bend bottom=in and out}


% Shape tape.
%
%
\pgfdeclareshape{tape}{%
	\savedmacro\gettapepoints{%
		%
		% Get the larger of the outer sep.
		%
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/outer xsep}}%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
		\ifdim\pgf@x>\pgf@y%
			\edef\outersep{\the\pgf@x}%
		\else%
			\edef\outersep{\the\pgf@y}%
		\fi%
		\addtosavedmacro\outersep%
		%
		% Get the side parameters.
		%
		\pgfkeysgetvalue{/pgf/tape bend top}{\north}%
		\pgfkeysgetvalue{/pgf/tape bend bottom}{\south}%
		\addtosavedmacro\north%
		\addtosavedmacro\south%
		%
		% Get the node dimensions (plus half the line width}
		%
		\pgfmathsetlength\pgf@xa{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\advance\pgf@xa.5\wd\pgfnodeparttextbox%
		\advance\pgf@xa.5\pgflinewidth\relax%
		\pgfmathsetlength\pgf@ya{+\pgfkeysvalueof{/pgf/inner ysep}}%
		\advance\pgf@ya.5\ht\pgfnodeparttextbox%
		\advance\pgf@ya.5\dp\pgfnodeparttextbox%
		\advance\pgf@ya.5\pgflinewidth\relax%
		%
		% Get half the bend height
		%
		\pgfmathsetlength\pgf@yb{+\pgfkeysvalueof{/pgf/tape bend height}}%
		\pgf@yb.5\pgf@yb%
		\edef\chordheight{\the\pgf@yb}%
		\addtosavedmacro\chordheight%
		%
		% Adjust for minimum height and width
		%
		\pgfmathsetlength\pgf@xc{+\pgfkeysvalueof{/pgf/minimum width}}%
		\ifdim\pgf@xa<.5\pgf@xc%
			\pgf@xa.5\pgf@xc%
		\fi%
		%
		\c@pgf@countb0\relax%
		\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/none}\relax%
		\else%
			\advance\c@pgf@countb1\relax%
		\fi%
		\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/none}\relax%
		\else%
			\advance\c@pgf@countb1\relax%
		\fi%
		\pgf@y\pgf@ya%
		\advance\pgf@y\c@pgf@countb\pgf@yb%
		\pgfmathsetlength\pgf@yc{+\pgfkeysvalueof{/pgf/minimum height}}%
		\ifdim\pgf@y<.5\pgf@yc%
			\pgf@ya.5\pgf@yc%
			\advance\pgf@ya-\c@pgf@countb\pgf@yb%
		\fi%
		%
		% Each bend is an elliptical arc of length 90 degrees. An `in' arc
		% starts at 45 degrees and finishes at 135 degrees, and an 'out'
		% arc starts at 225 degrees and finishes at 315 degrees. By fixing
		% the arc length some slow trig. computations can hard coded as
		% constants and there is generally less fussing around. The arc has
		% a height determined by the key /pgf/tape bend height.
		% 	
		\edef\chordlength{\the\pgf@xa}% 
		\pgf@x.5\pgf@xa%
		\edef\halfchordlength{\the\pgf@x}%
		\pgf@x\chordlength\relax%
		\pgf@x.7070106\pgf@x% 
		\edef\xradius{\the\pgf@x}%
		\pgf@y3.414213\pgf@yb% 
		\edef\yradius{\the\pgf@y}%		
		\addtosavedmacro\halfchordlength%
		\addtosavedmacro\chordlength%
		\addtosavedmacro\xradius%
		\addtosavedmacro\yradius%
		%
		\pgf@xc\xradius\relax%
		\advance\pgf@xc\outersep\relax%
		\edef\bigxradius{\the\pgf@xc}%
		\pgf@xc\xradius\relax%
		\advance\pgf@xc-\outersep\relax%
		\edef\smallxradius{\the\pgf@xc}%
		%
		\pgf@yc\yradius\relax%
		\advance\pgf@yc\outersep\relax%
		\edef\bigyradius{\the\pgf@yc}%
		\pgf@yc\yradius\relax%
		\advance\pgf@yc-\outersep\relax%
		\edef\smallyradius{\the\pgf@yc}%
		%
		\addtosavedmacro\bigxradius%
		\addtosavedmacro\bigyradius%
		\addtosavedmacro\smallxradius%
		\addtosavedmacro\smallyradius%
		%
		%
		% The gradient of the tangent on an elliptical arc with radii
		% $x$ and $y$ at angle $t$, is given by:
		%
		% $g = -\frac{y}{x}\times\cot(t)$
		%
		% As the arc has a fixed length, $\cot(t)$ is either -1 or 1. 
		% Here, we calculate the angle of the gradient at 135 degrees
		% (some fooling around is done later for the other angles).
		%
		\pgf@x\xradius\relax%
		\pgf@y\yradius\relax%
		\pgfmathdivide@{\pgfmath@tonumber{\pgf@y}}{\pgfmath@tonumber{\pgf@x}}%
		\pgfmathatan@{\pgfmathresult}%
		\let\gradientangle\pgfmathresult%
		\pgfmathdivide@{\pgfmathresult}{2}%
		\let\halfgradientangle\pgfmathresult%
		\pgfmathsec@{\gradientangle}%
		\let\secgradientangle\pgfmathresult%
		\pgfmathcosec@{\gradientangle}%
		\let\cosecgradientangle\pgfmathresult%
		%
		% Where an 'in' arc meets a corner point we calculate the 
		% `miter length' at the corner, to position the anchors.	
		%
		\pgfmathsubtract@{45}{\halfgradientangle}%
		\pgfmathcosec@{\pgfmathresult}%
		\pgf@x\outersep\relax%
		\pgf@x\pgfmathresult\pgf@x%
		\edef\inmiterlength{\the\pgf@x}%
		%
		% Do the same for an 'out' arc.
		%
		\pgfmathadd@{45}{\halfgradientangle}%
		\pgfmathcosec@{\pgfmathresult}%
		\pgf@x\outersep\relax%
		\pgf@x\pgfmathresult\pgf@x%
		\edef\outmiterlength{\the\pgf@x}%
		%
		% Calculate the background path points.
		%
		\pgfsavepgf@process\centerpoint{%
			\pgf@x.5\wd\pgfnodeparttextbox%
			\pgf@y.5\ht\pgfnodeparttextbox%
			\advance\pgf@y-.5\dp\pgfnodeparttextbox%
		}%
		\pgfsavepgf@process\northeast{%
			\centerpoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya%
			\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/none}\relax%
			\else%
				\advance\pgf@y\pgf@yb%
			\fi%
		}%	
		\pgfsavepgf@process\northwest{%
			\centerpoint%
			\advance\pgf@x-\pgf@xa%
			\advance\pgf@y\pgf@ya%
			\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/none}\relax%
			\else%
				\advance\pgf@y\pgf@yb%
			\fi%
		}%	
		\pgfsavepgf@process\southwest{%
			\centerpoint%
			\advance\pgf@x-\pgf@xa%
			\advance\pgf@y-\pgf@ya%
			\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/none}\relax%
			\else%
				\advance\pgf@y-\pgf@yb%
			\fi%
		}%
		\pgfsavepgf@process\southeast{%
			\centerpoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y-\pgf@ya%
			\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/none}\relax%
			\else%
				\advance\pgf@y-\pgf@yb%
			\fi%
		}%
		\addtosavedmacro{\northeast}%
		\addtosavedmacro{\northwest}%
		\addtosavedmacro{\southeast}%
		\addtosavedmacro{\southwest}%
		%
		% Define the anchor points.
		%	
		\pgfsavepgf@process\northeastanchor{%
			\pgfpointadd{\northeast}{%
				\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/out and in}\relax%
					\pgfmathadd@{45}{\halfgradientangle}%
					\let\miterangle\pgfmathresult%
					\pgfqpointpolar{\miterangle}{\inmiterlength}%
				\else%
					\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/in and out}\relax%
						\pgfmathsubtract@{45}{\halfgradientangle}%
						\let\miterangle\pgfmathresult%
						\pgfqpointpolar{\miterangle}{\outmiterlength}%
					\else%					
						\pgfqpoint{\outersep}{\outersep}%
					\fi%
				\fi%
			}%
		}%
		\pgfsavepgf@process\northwestanchor{%
			\pgfpointadd{\northwest}{%
				\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/out and in}\relax%
					\pgfmathadd@{135}{\halfgradientangle}%
					\let\miterangle\pgfmathresult%
					\pgfqpointpolar{\miterangle}{\outmiterlength}%
				\else%
					\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/in and out}\relax%
						\pgfmathsubtract@{135}{\halfgradientangle}%
						\let\miterangle\pgfmathresult%
						\pgfqpointpolar{\miterangle}{\inmiterlength}%
					\else%
						\pgfqpoint{-\outersep}{\outersep}%
					\fi%
				\fi%
			}%
		}%
		\pgfsavepgf@process\southwestanchor{%
			\pgfpointadd{\southwest}{%
				\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/out and in}\relax%
					\pgfmathadd@{225}{\halfgradientangle}%
					\let\miterangle\pgfmathresult%
					\pgfqpointpolar{\miterangle}{\inmiterlength}%
				\else%
					\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/in and out}\relax%
						\pgfmathsubtract@{225}{\halfgradientangle}%
						\let\miterangle\pgfmathresult%
						\pgfqpointpolar{\miterangle}{\outmiterlength}%
					\else%					
						\pgfqpoint{-\outersep}{-\outersep}%
					\fi%
				\fi%
			}%
		}%
		\pgfsavepgf@process\southeastanchor{%
			\pgfpointadd{\southeast}{%
				\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/in and out}\relax%
					\pgfmathsubtract@{315}{\halfgradientangle}%
					\let\miterangle\pgfmathresult%
					\pgfqpointpolar{\miterangle}{\inmiterlength}%
				\else%
					\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/out and in}\relax%
						\pgfmathadd@{315}{\halfgradientangle}%
						\let\miterangle\pgfmathresult%
						\pgfqpointpolar{\miterangle}{\outmiterlength}%
					\else%
						\pgfqpoint{\outersep}{-\outersep}%
					\fi%
				\fi%
			}%
		}%
		\pgfsavepgf@process\northanchor{%
			\pgfpointadd{\centerpoint\pgf@xa\pgf@x\northeast\pgf@x\pgf@xa}{%
				\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/none}\relax%
					\pgfqpoint{0pt}{\outersep}%
				\else%
					\pgfutil@tempdima\outersep\relax%
					\pgfutil@tempdima\secgradientangle\pgfutil@tempdima%
					\pgfqpoint{0pt}{\the\pgfutil@tempdima}%
				\fi%
			}%
		}%
		\pgfsavepgf@process\southanchor{%
			\pgfpointadd{\centerpoint\pgf@xa\pgf@x\southwest\pgf@x\pgf@xa}{%
				\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/none}\relax%
					\pgfqpoint{0pt}{-\outersep}%
				\else%
					\pgfutil@tempdima\outersep\relax%
					\pgfutil@tempdima\secgradientangle\pgfutil@tempdima%
					\pgfqpoint{0pt}{-\the\pgfutil@tempdima}%
				\fi%
			}%
		}%
		\pgfsavepgf@process\eastanchor{\centerpoint\pgf@ya\pgf@y\northeastanchor\pgf@y\pgf@ya}%
		\pgfsavepgf@process\westanchor{\centerpoint\pgf@ya\pgf@y\southwestanchor\pgf@y\pgf@ya}%
		\addtosavedmacro{\northanchor}%
		\addtosavedmacro{\southanchor}%
		\addtosavedmacro{\eastanchor}%
		\addtosavedmacro{\westanchor}%
		\addtosavedmacro{\northeastanchor}%
		\addtosavedmacro{\northwestanchor}%
		\addtosavedmacro{\southwestanchor}%
		\addtosavedmacro{\southeastanchor}%
		%
		% Calculate the anchor angles.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\northanchor}
		\let\northanchorangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\southanchor}
		\let\southanchorangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\eastanchor}
		\let\eastanchorangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\westanchor}
		\let\westanchorangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\northeastanchor}
		\let\northeastanchorangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\southwestanchor}
		\let\southwestanchorangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\southeastanchor}
		\let\southeastanchorangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\northwestanchor}
		\let\northwestanchorangle\pgfmathresult%
		\addtosavedmacro{\northanchorangle}%
		\addtosavedmacro{\southanchorangle}%
		\addtosavedmacro{\eastanchorangle}%
		\addtosavedmacro{\westanchorangle}%
		\addtosavedmacro{\northeastanchorangle}%
		\addtosavedmacro{\northwestanchorangle}%
		\addtosavedmacro{\southwestanchorangle}%
		\addtosavedmacro{\southeastanchorangle}%
	}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}%
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt\relax%
	}%
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}%
	\anchor{center}{\centerpoint}%
	\anchor{base}{\basepoint}%
	\anchor{base east}{\gettapepoints\southeastanchor\pgf@xa\pgf@x\basepoint\pgf@x\pgf@xa}%
	\anchor{base west}{\gettapepoints\southwestanchor\pgf@xa\pgf@x\basepoint\pgf@x\pgf@xa}%
	\anchor{mid}{\midpoint}%
	\anchor{mid east}{\gettapepoints\southeastanchor\pgf@xa\pgf@x\midpoint\pgf@x\pgf@xa}%
	\anchor{mid west}{\gettapepoints\southwestanchor\pgf@xa\pgf@x\midpoint\pgf@x\pgf@xa}%
	\anchor{north}{\gettapepoints\northanchor}%
	\anchor{south}{\gettapepoints\southanchor}%
	\anchor{east}{\gettapepoints\eastanchor}%
	\anchor{west}{\gettapepoints\westanchor}%
	\anchor{north east}{\gettapepoints\northeastanchor}%
	\anchor{north west}{\gettapepoints\northwestanchor}%
	\anchor{south west}{\gettapepoints\southwestanchor}%
	\anchor{south east}{\gettapepoints\southeastanchor}%
	\backgroundpath{%
		\gettapepoints%
		%
		% Need to start in the middle of a straight line in order
		% to get a `clean' corner join at the end of the path.
		%
		\pgfpathmoveto{\centerpoint\pgf@ya\pgf@y\northeast\pgf@y\pgf@ya}%
		\pgfpathlineto{\southeast}%
		\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/out and in}\relax%
			\pgfpatharc{315}{225}{\xradius and \yradius}%
			\pgfpatharc{45}{135}{\xradius and \yradius}%				
		\else%
			\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/in and out}\relax%
				\pgfpatharc{45}{135}{\xradius and \yradius}%
				\pgfpatharc{315}{225}{\xradius and \yradius}%
			\else%
				\pgfpathlineto{\southwest}%
			\fi%
		\fi
		\pgfpathlineto{\northwest}%
		\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/out and in}\relax%
			\pgfpatharc{135}{45}{\xradius and \yradius}%
			\pgfpatharc{225}{315}{\xradius and \yradius}%
		\else%
			\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/in and out}\relax%
				\pgfpatharc{225}{315}{\xradius and \yradius}%
				\pgfpatharc{135}{45}{\xradius and \yradius}%
			\else%
				\pgfpathlineto{\northeast}%
			\fi%
		\fi
		\pgfpathclose%
	}%
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
	 	\pgfsavepgf@process\externalpoint{%
			\centerpoint%
			\advance\pgf@x\externalx\relax%
			\advance\pgf@y\externaly\relax%
		}%
		\pgfmathanglebetweenpoints{\centerpoint}{\externalpoint}%
		\let\externalangle\pgfmathresult%
		%
		\gettapepoints%
		%
		% Find the border point. If only it were easier...
		%
		\ifdim\externalangle pt<\westanchorangle pt\relax%
			\ifdim\externalangle pt<\northanchorangle pt\relax%
				\ifdim\externalangle pt<\northeastanchorangle pt\relax%
					\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\northeastanchor}{\southeastanchor}%
				\else%
					\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/none}%
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\northeastanchor}{\northwestanchor}%
					\else%
						\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/in and out}%
							\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
								{%
									\northeast%
									\advance\pgf@x-\halfchordlength\relax%
									\advance\pgf@y\chordheight\relax%
									\advance\pgf@y-\yradius\relax%
								}%
								{45}{135}{\bigxradius and \bigyradius}%
						\else%
							\pgfmathpointintersectionoflineandarc{\centerpoint}{\externalpoint}%
								{%
									\northeast%
									\advance\pgf@x-\halfchordlength\relax%
									\advance\pgf@y-\chordheight\relax%
									\advance\pgf@y\yradius\relax%
								}%
								{225}{315}{\smallxradius and \smallyradius}%
						\fi%
					\fi%
				\fi%
			\else%
				\ifdim\externalangle pt<\northwestanchorangle pt\relax%
					\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/none}%
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\northeastanchor}{\northwestanchor}%
					\else%
						\ifdim\externalangle pt=90pt\relax%
							\northanchor%
						\else%
							\ifnum\north=\pgfkeysvalueof{/pgf/@tape bend/in and out}%
								\pgfmathpointintersectionoflineandarc{\centerpoint}{\externalpoint}%
									{%
										\northwest%
										\advance\pgf@x\halfchordlength\relax%
										\advance\pgf@y-\chordheight\relax%
										\advance\pgf@y\yradius\relax%
									}%
									{225}{315}{\smallxradius and \smallyradius}%
							\else%
								\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
									{%
										\northwest%
										\advance\pgf@x\halfchordlength\relax%
										\advance\pgf@y\chordheight\relax%
										\advance\pgf@y-\yradius\relax%
									}%
									{45}{135}{\bigxradius and \bigyradius}%
							\fi%
						\fi%
					\fi%
				\else%
					\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\northwestanchor}{\southwestanchor}%
				\fi%
			\fi%
		\else%
			\ifdim\externalangle pt<\southanchorangle pt\relax%
				\ifdim\externalangle pt<\southwestanchorangle pt\relax%
					\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
						{\northwestanchor}{\southwestanchor}%
				\else%
					\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/none}%
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\southeastanchor}{\southwestanchor}%
					\else%
						\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/in and out}%
							\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
								{%
									\southwest%
									\advance\pgf@x\halfchordlength\relax%
									\advance\pgf@y-\chordheight\relax%
									\advance\pgf@y\yradius\relax%
								}%
								{225}{315}{\bigxradius and \bigyradius}%
						\else%
							\pgfmathpointintersectionoflineandarc{\centerpoint}{\externalpoint}%
								{%
									\southwest%
									\advance\pgf@x\halfchordlength\relax%
									\advance\pgf@y\chordheight\relax%
									\advance\pgf@y-\yradius\relax%
								}%
								{45}{135}{\smallxradius and \smallyradius}%
						\fi%
					\fi%
				\fi%
			\else%
				\ifdim\externalangle pt<\southeastanchorangle pt\relax%
					\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/none}%
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\southeastanchor}{\southwestanchor}%
					\else%
						\ifdim\externalangle pt=270pt\relax%
							\southanchor%
						\else%
							\ifnum\south=\pgfkeysvalueof{/pgf/@tape bend/in and out}%
								\pgfmathpointintersectionoflineandarc{\centerpoint}{\externalpoint}%
									{%
										\southeast%
										\advance\pgf@x-\halfchordlength\relax%
										\advance\pgf@y\chordheight\relax%
										\advance\pgf@y-\yradius\relax%
									}%
									{45}{135}{\smallxradius and \smallyradius}%
							\else%
								\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
									{%
										\southeast%
										\advance\pgf@x-\halfchordlength\relax%
										\advance\pgf@y-\chordheight\relax%
										\advance\pgf@y\yradius\relax%
									}%
									{225}{315}{\bigxradius and \bigyradius}%
							\fi%
						\fi%
					\fi%
				\else%
					\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
						{\northeastanchor}{\southeastanchor}%
				\fi%
			\fi%
		\fi% Hurrah!			
	}%
}	





% keys for shape single arrow
%
% /pgf/single arrow tip angle
% /pgf/single arrow head sep

\pgfkeys{/pgf/single arrow tip angle/.code={%
		\pgfmathparse{#1}%
		\pgfkeyslet{/pgf/single arrow tip angle}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/single arrow tip angle=90}

\pgfkeys{/pgf/single arrow head extend/.code={%
		\pgfmathparse{#1}%
		\edef\pgfmathresult{\pgfmathresult pt}%
		\pgfkeyslet{/pgf/single arrow head extend}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/single arrow head extend=1.5ex}

\pgfkeys{/pgf/single arrow head indent/.code={%
		\pgfmathparse{#1}%
		\edef\pgfmathresult{\pgfmathresult pt}%
		\pgfkeyslet{/pgf/single arrow head indent}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/single arrow head indent=0pt}

% Shape single arrow
%
%
\pgfdeclareshape{single arrow}{%
	\savedmacro\getsinglearrowpoints{%
		%
		% Get the outer sep.
		% 
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/outer xsep}}%
		\edef\xoutersep{\the\pgf@x}%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
		\edef\youtersep{\the\pgf@y}%
		%
		% Get the node dimensions.
		%
		\pgfmathsetlength\pgf@xa{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\advance\pgf@xa.5\wd\pgfnodeparttextbox%
		\advance\pgf@xa.5\pgflinewidth%
		\pgfmathsetlength\pgf@ya{+\pgfkeysvalueof{/pgf/inner ysep}}%
		\advance\pgf@ya.5\ht\pgfnodeparttextbox%
		\advance\pgf@ya.5\dp\pgfnodeparttextbox%
		\advance\pgf@ya.5\pgflinewidth%
		\ifpgfshapeborderusesincircle%
			\ifdim\pgf@xa<\pgf@ya%
				\pgf@xa\pgf@ya%
			\fi%			
			\pgf@xa1.41421\pgf@xa%
			\pgf@ya\pgf@xa%
			\pgfkeysgetvalue{/pgf/shape border rotate}{\rotate}%
			\ifdim\xoutersep>\youtersep\relax%
				\let\youtersep\xoutersep%
			\else%
				\let\xoutersep\youtersep%
			\fi%
		\else%
			%
			% Round the rotation.
			%
			\pgfmathmod@{+\pgfkeysvalueof{/pgf/shape border rotate}}{360}%
			\afterassignment\pgfmath@gobbletilpgfmath@%
			\expandafter\c@pgf@counta\pgfmathresult\relax\pgfmath@%
			\advance\c@pgf@counta45\relax%
			\divide\c@pgf@counta90\relax%
			\multiply\c@pgf@counta90\relax%
			\ifnum\c@pgf@counta<0\relax%
				\advance\c@pgf@counta360\relax%
			\fi%
			\edef\rotate{\the\c@pgf@counta}%
			%
			% Calculate the width and height of the node
			% contents, according to any border rotation.
			%
			\ifnum\c@pgf@counta=90\relax%
				\pgf@x\pgf@xa%
				\pgf@xa\pgf@ya%
				\pgf@ya\pgf@x%
				\let\pgfmathresult\xoutersep%
				\let\xoutersep\youtersep%
				\let\youtersep\pgfmathresult%
			\else%
				\ifnum\c@pgf@counta=270\relax%
					\pgf@x\pgf@xa%
					\pgf@xa\pgf@ya%
					\pgf@ya\pgf@x%
					\let\pgfmathresult\xoutersep%
					\let\xoutersep\youtersep%
					\let\youtersep\pgfmathresult%
				\fi%
			\fi%
		\fi%
		\addtosavedmacro\rotate%
		%
		% Get some useful trig stuff.
		%
		\pgfmathdivide@{\pgfkeysvalueof{/pgf/single arrow tip angle}}{2}%
		\let\halftipangle\pgfmathresult%
		\pgfmathcosec@{\halftipangle}%
		\let\cosechalftipangle\pgfmathresult%
		\pgfmathcos@{\halftipangle}%
		\pgfutil@tempdima\pgfmathresult pt\relax%
		\pgfutil@tempdima\cosechalftipangle\pgfutil@tempdima%
		\edef\cothalftipangle{\pgfmath@tonumber{\pgfutil@tempdima}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\let\sechalftipangle\pgfmathresult%
		\pgfmathsin@{\halftipangle}%
		\pgfutil@tempdima\pgfmathresult pt\relax%
		\pgfutil@tempdima\sechalftipangle\pgfutil@tempdima%
		\edef\tanhalftipangle{\pgfmath@tonumber{\pgfutil@tempdima}}%
		%
		% Get the single arrow head extend, and adjust for minimum width.
		%
		\pgf@xb\pgf@ya%
		\pgf@xb\cothalftipangle\pgf@xb%
		\pgfmathsetlength\pgf@xc{+\pgfkeysvalueof{/pgf/single arrow head extend}}%
		\pgf@yc\pgf@xc%
		\advance\pgf@xc\pgf@ya%
		\pgfmathsetlength\pgfutil@tempdimb{+\pgfkeysvalueof{/pgf/minimum width}}%
		\ifdim\pgf@xc<.5\pgfutil@tempdimb%
			\pgfutil@tempdimb.5\pgfutil@tempdimb%
			\pgfmathdivide@{\pgfmath@tonumber{\pgfutil@tempdimb}}{\pgfmath@tonumber{\pgf@xc}}%
			\pgf@ya\pgfmathresult\pgf@ya%
			\pgf@xc\pgfmathresult\pgf@xc%
			\pgf@yc\pgfmathresult\pgf@yc%
			\pgf@xb\pgfmathresult\pgf@xb%
		\fi%
		%
		% Now calculate the height of the arrow and adjust for minimum height.
		%
		\advance\pgf@xc-\pgf@ya%
		\pgf@xc\cothalftipangle\pgf@xc%
		\pgf@xa2.0\pgf@xa%
		\advance\pgf@xa\pgf@xb%
		\pgfmathsetlength\pgfutil@tempdimb{+\pgfkeysvalueof{/pgf/minimum height}}%
		\ifdim\pgf@xa<\pgfutil@tempdimb%
			\pgf@xa\pgfutil@tempdimb%
		\fi%
		\advance\pgf@xa-\pgf@xb%
		\pgf@xa.5\pgf@xa%		
		\pgfmathsetlength\pgfutil@tempdima{+\pgfkeysvalueof{/pgf/single arrow head indent}}%
		%
		% Now:
		%
		% xa - .5 * width of the node minus xb.
		% ya - .5 * height of the node contents.
		% xb - distance from the end of the node contents to the arrow tip.
		% xc - distance from the end of the node contents to the back end of the arrow head.
		% yc - distance from the top of the node contents to the top end of the arrow head.
		%
		\pgfsavepgf@process\centerpoint{%
			\pgf@x.5\wd\pgfnodeparttextbox%
			\pgf@y.5\ht\pgfnodeparttextbox%
			\advance\pgf@y-.5\dp\pgfnodeparttextbox%
		}%
		\pgfsavepgf@process\basepoint{%
			\pgf@x.5\wd\pgfnodeparttextbox%
			\pgf@y0pt%
		}%
		\pgfsavepgf@process\midpoint{%
			\pgf@x.5\wd\pgfnodeparttextbox%
			\pgfmathsetlength\pgf@y{+.5ex}%
		}%
		%
		% As the arrow is symmetrical it can be described by only four points:
		%
		\pgfsavepgf@process\arrowtip{%
			\pgf@x\pgf@xa%
			\advance\pgf@x\pgf@xb%
			\pgf@y0pt\relax%
		}%
		\pgfsavepgf@process\beforearrowtip{%
			\pgf@x\pgf@xa%
			\advance\pgf@x-\pgf@xc%
			\pgf@y\pgf@ya%
			\advance\pgf@y\pgf@yc%
		}%
		\pgfsavepgf@process\beforearrowhead{%
			\pgf@x\pgf@xa%
			\advance\pgf@x-\pgf@xc%
			\advance\pgf@x\pgfutil@tempdima%
			\pgf@y\pgf@ya%
		}%
		\pgfsavepgf@process\afterarrowtail{%
			\pgf@x-\pgf@xa%
			\pgf@y\pgf@ya%
		}%
		%
		% Calculate the anchor point at the arrow tip...
		%
		\pgfsavepgf@process\arrowtipanchor{%
			\pgfpointadd{\centerpoint}{\arrowtip}%
			\pgf@xa\xoutersep\relax%
			\advance\pgf@x\cosechalftipangle\pgf@xa%
		}%
		\advance\pgf@x.5\wd\pgfnodeparttextbox%
		\edef\externalradius{\the\pgf@x}%
		\addtosavedmacro\externalradius%
		%
		% ...and the rest of the points.
		%
		\pgfmathanglebetweenlines{\beforearrowtip}{\beforearrowhead}{\beforearrowtip}{\arrowtip}%
		\pgf@xa\xoutersep\relax%
		\pgfutil@tempdima\pgfmathresult pt\relax%
		\pgfutil@tempdima.5\pgfutil@tempdima%
		\pgfmathcosec@{\pgfmath@tonumber{\pgfutil@tempdima}}%
		\pgf@xa\pgfmathresult\pgf@xa%
		\pgfutil@tempdima-\pgfutil@tempdima%
		\advance\pgfutil@tempdima180pt\relax%
		\advance\pgfutil@tempdima-\halftipangle pt\relax%
		%
		\pgfsavepgf@process\beforearrowtipanchor{%
			\pgfqpointpolar{\pgfmath@tonumber{\pgfutil@tempdima}}{\the\pgf@xa}%
			\pgf@xb\pgf@x%
			\pgf@yb\pgf@y%
			\pgf@process{\pgfpointadd{\centerpoint}{\beforearrowtip}}%
			\advance\pgf@x\pgf@xb%
			\advance\pgf@y\pgf@yb%
		}%
		\pgfmathanglebetweenpoints{\beforearrowhead}{\beforearrowtip}%
		\pgfutil@tempdima-\pgfmathresult pt\relax%
		\advance\pgfutil@tempdima180pt\relax%
		\pgfutil@tempdima.5\pgfutil@tempdima%
		\pgfmathcosec@{\pgfmath@tonumber{\pgfutil@tempdima}}%
		\pgf@xa\xoutersep\relax%
		\pgf@xa\pgfmathresult\pgf@xa%
		\pgfutil@tempdima-\pgfutil@tempdima%
		\advance\pgfutil@tempdima180pt\relax%
		\pgfsavepgf@process\beforearrowheadanchor{%
			\pgfqpointpolar{\pgfmath@tonumber{\pgfutil@tempdima}}{\the\pgf@xa}%
			\pgf@xb\pgf@x%
			\pgf@yb\pgf@y%
			\pgf@process{\pgfpointadd{\centerpoint}{\beforearrowhead}}%
			\advance\pgf@x\pgf@xb%
			\advance\pgf@y\pgf@yb%
		}%
		\pgfsavepgf@process\afterarrowtailanchor{%
			\pgfpointadd{\centerpoint}{\afterarrowtail}%
			\advance\pgf@x-\xoutersep\relax%
			\advance\pgf@y\youtersep\relax%
		}%
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\beforearrowtipanchor}%
		\let\center@angle@beforearrowtip\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\afterarrowtailanchor}%
		\let\center@angle@afterarrowtail\pgfmathresult%
		\addtosavedmacro\center@angle@beforearrowtip%
		\addtosavedmacro\center@angle@afterarrowtail%
		%
		\pgfmathanglebetweenpoints{\midpoint}{\beforearrowtipanchor}%
		\let\mid@angle@beforearrowtip\pgfmathresult%
		\pgfmathanglebetweenpoints{\midpoint}{\afterarrowtailanchor}%
		\let\mid@angle@afterarrowtail\pgfmathresult%
		\addtosavedmacro\mid@angle@beforearrowtip%
		\addtosavedmacro\mid@angle@afterarrowtail%
		%
		\pgfmathanglebetweenpoints{\basepoint}{\beforearrowtipanchor}%
		\let\base@angle@beforearrowtip\pgfmathresult%
		\pgfmathanglebetweenpoints{\basepoint}{\afterarrowtailanchor}%
		\let\base@angle@afterarrowtail\pgfmathresult%
		\addtosavedmacro\base@angle@beforearrowtip%
		\addtosavedmacro\base@angle@afterarrowtail%
		%
		\addtosavedmacro\arrowtipanchor%
		\addtosavedmacro\beforearrowtipanchor%
		\addtosavedmacro\beforearrowheadanchor%
		\addtosavedmacro\afterarrowtailanchor%
	}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}%
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+0.5ex}%
	}%
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt%
	}%
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\midpoint}%
	\anchor{mid east}{%
		\getsinglearrowpoints%
		\let\pgf@singlearrow@referencepoint\midpoint%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}	
	\anchor{mid west}{%
		\getsinglearrowpoints%
		\let\pgf@singlearrow@referencepoint\midpoint%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}	
	\anchor{base}{\basepoint}%
	\anchor{base east}{%
		\getsinglearrowpoints%
		\let\pgf@singlearrow@referencepoint\basepoint%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}	
	\anchor{base west}{%
		\getsinglearrowpoints%
		\let\pgf@singlearrow@referencepoint\basepoint%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}	
	\anchor{north}{%
		\getsinglearrowpoints%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{0pt}{\externalradius}}%
	}
	\anchor{south}{%
		\getsinglearrowpoints%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{0pt}{-\externalradius}}%
	}
	\anchor{east}{%
		\getsinglearrowpoints%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}
	\anchor{west}{%
		\getsinglearrowpoints%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}
	\anchor{north east}{%
		\getsinglearrowpoints%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{\externalradius}{\externalradius}}%
	}
	\anchor{south east}{%
		\getsinglearrowpoints%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{\externalradius}{-\externalradius}}%
	}
	\anchor{south west}{%
		\getsinglearrowpoints%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{-\externalradius}{-\externalradius}}%
	}
	\anchor{north west}{%
		\getsinglearrowpoints%
		\csname pgf@anchor@single arrow@border\endcsname{\pgfqpoint{-\externalradius}{\externalradius}}%
	}
	\anchor{before head}{%
		\getsinglearrowpoints%
		\pgfmathrotatepointaround{\beforearrowheadanchor}{\centerpoint}{\rotate}%
	}%
	\anchor{before tip}{%
		\getsinglearrowpoints%
		\pgfmathrotatepointaround{\beforearrowtipanchor}{\centerpoint}{\rotate}%
	}%
	\anchor{tip}{%
		\getsinglearrowpoints%
		\pgfmathrotatepointaround{\arrowtipanchor}{\centerpoint}{\rotate}%
	}%
	\anchor{after tip}{%
		\getsinglearrowpoints%
		\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\beforearrowtipanchor}%
				\pgf@y-\pgf@y%
			}{\centerpoint}}%
		{\centerpoint}{\rotate}%
	}
	\anchor{after head}{%
		\getsinglearrowpoints%
		\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\beforearrowheadanchor}%
				\pgf@y-\pgf@y%
			}{\centerpoint}}%
		{\centerpoint}{\rotate}%
	}
	\anchor{before tail}{%
		\getsinglearrowpoints%
		\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\afterarrowtailanchor}%
				\pgf@y-\pgf@y%
			}{\centerpoint}}%
		{\centerpoint}{\rotate}%
	}
	\anchor{after tail}{%
		\getsinglearrowpoints%
		\pgfmathrotatepointaround{\afterarrowtailanchor}{\centerpoint}{\rotate}%
	}
	\anchor{tail}{%
		\getsinglearrowpoints%
		\pgfpointlineattime{0.5}{%
			\pgfmathrotatepointaround{\afterarrowtailanchor}{\centerpoint}{\rotate}%
		}%
		{%
			\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\afterarrowtailanchor}%
				\pgf@y-\pgf@y%
			}{\centerpoint}}%
			{\centerpoint}{\rotate}%
		}%	
	}%
	\backgroundpath{%
		{%
			\pgftransformshift{\centerpoint}%
			\pgftransformrotate{\rotate}%
			\pgfpathmoveto{\arrowtip}%
			\pgfpathlineto{\beforearrowtip}%
			\pgfpathlineto{\beforearrowhead}%
			\pgfpathlineto{\afterarrowtail}%
			\pgfpathlineto{\afterarrowtail\pgf@y-\pgf@y}%
			\pgfpathlineto{\beforearrowhead\pgf@y-\pgf@y}%
			\pgfpathlineto{\beforearrowtip\pgf@y-\pgf@y}%			
		}%
		\pgfpathclose%
	}%
	\anchorborder{%
		\pgfsavepgf@process\externalpoint{}%			
		\getsinglearrowpoints%
		\pgfutil@ifundefined{pgf@singlearrow@referencepoint}{\let\referencepoint\centerpoint}%
			{\let\referencepoint\pgf@singlearrow@referencepoint}%
		\pgfsavepgf@process\externalpoint{%
			\externalpoint%
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\referencepoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya}% 
		\pgfmathanglebetweenpoints{\centerpoint}{\externalpoint}%
		\pgfmathsubtract@{\pgfmathresult}{\rotate}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		\let\externalangle\pgfmathresult%
		\pgf@x\externalangle pt\relax%
		\ifx\referencepoint\midpoint%
			\pgf@xa\mid@angle@beforearrowtip pt\relax%
			\pgf@xb\mid@angle@afterarrowtail pt\relax%
		\else%
			\ifx\referencepoint\basepoint%
				\pgf@xa\base@angle@beforearrowtip pt\relax%
				\pgf@xb\base@angle@afterarrowtail pt\relax%
			\else%
				\pgf@xa\center@angle@beforearrowtip pt\relax%
				\pgf@xb\center@angle@afterarrowtail pt\relax%
			\fi%
		\fi%
		\ifdim\pgf@x<\pgf@xa%
			\let\firstpoint\arrowtipanchor%
			\let\secondpoint\beforearrowtipanchor%
		\else%
			\ifdim\pgf@x<\pgf@xb%
				\let\firstpoint\beforearrowheadanchor%
				\let\secondpoint\afterarrowtailanchor%
			\else%
				\pgf@xb-\pgf@xb%
				\advance\pgf@xb360pt\relax%
				\ifdim\pgf@x<\pgf@xb%
					\let\firstpoint\afterarrowtailanchor%
					\pgfsavepgf@process\secondpoint{%
						\pgfmathrotatepointaround{%
							\pgfpointadd{%
								\pgfpointdiff{\centerpoint}{\afterarrowtailanchor}%
								\pgf@y-\pgf@y%
							}{\centerpoint}
						}%
						{\centerpoint}{\rotate}%
					}%
				\else%
					\pgf@xa-\pgf@xa%
					\advance\pgf@xa360pt\relax%
					\ifdim\pgf@x<\pgf@xa%
						\pgfsavepgf@process\firstpoint{%
							\pgfmathrotatepointaround{%
								\pgfpointadd{%
									\pgfpointdiff{\centerpoint}{\afterarrowtailanchor}%
									\pgf@y-\pgf@y%
								}{\centerpoint}
							}%
							{\centerpoint}{\rotate}%
						}%
						\pgfsavepgf@process\secondpoint{%
							\pgfmathrotatepointaround{%
								\pgfpointadd{%
									\pgfpointdiff{\centerpoint}{\beforearrowheadanchor}%
									\pgf@y-\pgf@y%
								}{\centerpoint}
							}%
							{\centerpoint}{\rotate}%
						}%
					\else%
						\pgfsavepgf@process\firstpoint{%
							\pgfmathrotatepointaround{%
								\pgfpointadd{%
									\pgfpointdiff{\centerpoint}{\beforearrowtipanchor}%
									\pgf@y-\pgf@y%
								}{\centerpoint}
							}%
							{\centerpoint}{\rotate}%
						}%
						\let\secondpoint\arrowtipanchor%
					\fi%
				\fi%
			\fi%
		\fi%
		\pgfpointintersectionoflines{\referencepoint}{\externalpoint}%
			{\firstpoint}{\secondpoint}%			
	}%
}







% keys for shape double arrow
%
% /pgf/double arrow tip angle
% /pgf/double arrow head sep

\pgfkeys{/pgf/double arrow tip angle/.code={%
		\pgfmathparse{#1}%
		\pgfkeyslet{/pgf/double arrow tip angle}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/double arrow tip angle=90}

\pgfkeys{/pgf/double arrow head extend/.code={%
		\pgfmathparse{#1}%
		\edef\pgfmathresult{\pgfmathresult pt}%
		\pgfkeyslet{/pgf/double arrow head extend}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/double arrow head extend=1.5ex}

\pgfkeys{/pgf/double arrow head indent/.code={%
		\pgfmathparse{#1}%
		\edef\pgfmathresult{\pgfmathresult pt}%
		\pgfkeyslet{/pgf/double arrow head indent}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/double arrow head indent=0ex}

% Shape double arrow
%
%
\pgfdeclareshape{double arrow}{%
	\savedmacro\getdoublearrowpoints{%
		%
		% Get the outer sep.
		% 
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/outer xsep}}%
		\edef\xoutersep{\the\pgf@x}%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
		\edef\youtersep{\the\pgf@y}%
		%
		% Get the node dimensions.
		%
		\pgfmathsetlength\pgf@xa{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\advance\pgf@xa.5\wd\pgfnodeparttextbox%
		\advance\pgf@xa.5\pgflinewidth%
		\pgfmathsetlength\pgf@ya{+\pgfkeysvalueof{/pgf/inner ysep}}%
		\advance\pgf@ya.5\ht\pgfnodeparttextbox%
		\advance\pgf@ya.5\dp\pgfnodeparttextbox%
		\advance\pgf@ya.5\pgflinewidth%
		\ifpgfshapeborderusesincircle%
			\ifdim\pgf@xa<\pgf@ya%
				\pgf@xa\pgf@ya%
			\fi%			
			\pgf@xa1.41421\pgf@xa%
			\pgf@ya\pgf@xa%
			\pgfkeysgetvalue{/pgf/shape border rotate}{\rotate}%
			\ifdim\xoutersep>\youtersep\relax%
				\let\youtersep\xoutersep%
			\else%
				\let\xoutersep\youtersep%
			\fi%
		\else%
			%
			% Round the rotation.
			%
			\pgfmathmod@{+\pgfkeysvalueof{/pgf/shape border rotate}}{360}%
			\afterassignment\pgfmath@gobbletilpgfmath@%
			\expandafter\c@pgf@counta\pgfmathresult\relax\pgfmath@%
			\advance\c@pgf@counta45\relax%
			\divide\c@pgf@counta90\relax%
			\multiply\c@pgf@counta90\relax%
			\ifnum\c@pgf@counta<0\relax%
				\advance\c@pgf@counta360\relax%
			\fi%
			\edef\rotate{\the\c@pgf@counta}%
			%
			% Calculate the width and height of the node
			% contents, according to any border rotation.
			%
			\ifnum\c@pgf@counta=90\relax%
				\pgf@x\pgf@xa%
				\pgf@xa\pgf@ya%
				\pgf@ya\pgf@x%
				\let\pgfmathresult\xoutersep%
				\let\xoutersep\youtersep%
				\let\youtersep\pgfmathresult%
			\else%
				\ifnum\c@pgf@counta=270\relax%
					\pgf@x\pgf@xa%
					\pgf@xa\pgf@ya%
					\pgf@ya\pgf@x%
					\let\pgfmathresult\xoutersep%
					\let\xoutersep\youtersep%
					\let\youtersep\pgfmathresult%
				\fi%
			\fi%
		\fi%
		\addtosavedmacro\rotate%
		%
		% Get some useful trig stuff.
		%
		\pgfmathdivide@{\pgfkeysvalueof{/pgf/double arrow tip angle}}{2}%
		\let\halftipangle\pgfmathresult%
		\pgfmathcosec@{\halftipangle}%
		\let\cosechalftipangle\pgfmathresult%
		\pgfmathcos@{\halftipangle}%
		\pgfutil@tempdima\pgfmathresult pt\relax%
		\pgfutil@tempdima\cosechalftipangle\pgfutil@tempdima%
		\edef\cothalftipangle{\pgfmath@tonumber{\pgfutil@tempdima}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\let\sechalftipangle\pgfmathresult%
		\pgfmathsin@{\halftipangle}%
		\pgfutil@tempdima\pgfmathresult pt\relax%
		\pgfutil@tempdima\sechalftipangle\pgfutil@tempdima%
		\edef\tanhalftipangle{\pgfmath@tonumber{\pgfutil@tempdima}}%
		%
		% Get the double arrow head extend, and adjust for minimum width.
		%
		\pgf@xb\pgf@ya%
		\pgf@xb\cothalftipangle\pgf@xb%
		\pgfmathsetlength\pgf@xc{+\pgfkeysvalueof{/pgf/double arrow head extend}}%
		\pgf@yc\pgf@xc%
		\advance\pgf@xc\pgf@ya%
		\pgfmathsetlength\pgfutil@tempdimb{+\pgfkeysvalueof{/pgf/minimum width}}%
		\ifdim\pgf@xc<.5\pgfutil@tempdimb%
			\pgfutil@tempdimb.5\pgfutil@tempdimb%
			\pgfmathdivide@{\pgfmath@tonumber{\pgfutil@tempdimb}}{\pgfmath@tonumber{\pgf@xc}}%
			\pgf@ya\pgfmathresult\pgf@ya%
			\pgf@xc\pgfmathresult\pgf@xc%
			\pgf@yc\pgfmathresult\pgf@yc%
			\pgf@xb\pgfmathresult\pgf@xb%
		\fi%
		%
		% Now calculate the height of the arrow and adjust for minimum height.
		%
		\advance\pgf@xc-\pgf@ya%
		\pgf@xc\cothalftipangle\pgf@xc%
		\advance\pgf@xa\pgf@xb%
		\pgf@xa2.0\pgf@xa%
		\pgfmathsetlength\pgfutil@tempdimb{+\pgfkeysvalueof{/pgf/minimum height}}%
		\ifdim\pgf@xa<\pgfutil@tempdimb%
			\pgf@xa\pgfutil@tempdimb%
		\fi%
		\pgf@xa.5\pgf@xa%	
		\advance\pgf@xa-\pgf@xb%
		\pgfmathsetlength\pgfutil@tempdima{+\pgfkeysvalueof{/pgf/double arrow head indent}}%
		%
		% Now:
		%
		% xa - .5 * width of the node minus xb.
		% ya - .5 * height of the node contents.
		% xb - distance from the end of the node contents to the arrow tip.
		% xc - distance from the end of the node contents to the back end of the arrow head.
		% yc - distance from the top of the node contents to the top end of the arrow head.
		%
		\pgfsavepgf@process\centerpoint{%
			\pgf@x.5\wd\pgfnodeparttextbox%
			\pgf@y.5\ht\pgfnodeparttextbox%
			\advance\pgf@y-.5\dp\pgfnodeparttextbox%
		}%
		\pgfsavepgf@process\basepoint{%
			\pgf@x.5\wd\pgfnodeparttextbox%
			\pgf@y0pt%
		}%
		\pgfsavepgf@process\midpoint{%
			\pgf@x.5\wd\pgfnodeparttextbox%
			\pgfmathsetlength\pgf@y{+.5ex}%
		}%
		%
		% As the arrow is symmetrical it can be described by only 3 points:
		%
		\pgfsavepgf@process\arrowtip{%
			\pgf@x\pgf@xa%
			\advance\pgf@x\pgf@xb%
			\pgf@y0pt\relax%
		}%
		\pgfsavepgf@process\beforearrowtip{%
			\pgf@x\pgf@xa%
			\advance\pgf@x-\pgf@xc%
			\pgf@y\pgf@ya%
			\advance\pgf@y\pgf@yc%
		}%
		\pgfsavepgf@process\beforearrowhead{%
			\pgf@x\pgf@xa%
			\advance\pgf@x-\pgf@xc%
			\advance\pgf@x\pgfutil@tempdima%
			\pgf@y\pgf@ya%
		}%
		%
		% Calculate the anchor point at the arrow tip.
		%
		\pgfsavepgf@process\arrowtipanchor{%
			\pgfpointadd{\centerpoint}{\arrowtip}%
			\pgf@xa\xoutersep\relax%
			\advance\pgf@x\cosechalftipangle\pgf@xa%
		}%
		\advance\pgf@x.5\wd\pgfnodeparttextbox%
		\edef\externalradius{\the\pgf@x}%
		\addtosavedmacro\externalradius%
		%
		%
		\pgfmathanglebetweenlines{\beforearrowtip}{\beforearrowhead}{\beforearrowtip}{\arrowtip}%
		\pgf@xa\xoutersep\relax%
		\pgfutil@tempdima\pgfmathresult pt\relax%
		\pgfutil@tempdima.5\pgfutil@tempdima%
		\pgfmathcosec@{\pgfmath@tonumber{\pgfutil@tempdima}}%
		\pgf@xa\pgfmathresult\pgf@xa%
		\pgfutil@tempdima-\pgfutil@tempdima%
		\advance\pgfutil@tempdima180pt\relax%
		\advance\pgfutil@tempdima-\halftipangle pt\relax%
		\pgfsavepgf@process\beforearrowtipanchor{%
			\pgfqpointpolar{\pgfmath@tonumber{\pgfutil@tempdima}}{\the\pgf@xa}%
			\pgf@xb\pgf@x%
			\pgf@yb\pgf@y%
			\pgf@process{\pgfpointadd{\centerpoint}{\beforearrowtip}}%
			\advance\pgf@x\pgf@xb%
			\advance\pgf@y\pgf@yb%
		}%
		\pgfmathanglebetweenpoints{\beforearrowhead}{\beforearrowtip}%
		\pgfutil@tempdima-\pgfmathresult pt\relax%
		\advance\pgfutil@tempdima180pt\relax%
		\pgfutil@tempdima.5\pgfutil@tempdima%
		\pgfmathcosec@{\pgfmath@tonumber{\pgfutil@tempdima}}%
		\pgf@xa\xoutersep\relax%
		\pgf@xa\pgfmathresult\pgf@xa%
		\pgfutil@tempdima-\pgfutil@tempdima%
		\advance\pgfutil@tempdima180pt\relax%
		\pgfsavepgf@process\beforearrowheadanchor{%
			\pgfqpointpolar{\pgfmath@tonumber{\pgfutil@tempdima}}{\the\pgf@xa}%
			\pgf@xb\pgf@x%
			\pgf@yb\pgf@y%
			\pgf@process{\pgfpointadd{\centerpoint}{\beforearrowhead}}%
			\advance\pgf@x\pgf@xb%
			\advance\pgf@y\pgf@yb%
		}%
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\beforearrowtipanchor}%
		\let\center@angle@beforearrowtip\pgfmathresult%
		\addtosavedmacro\center@angle@beforearrowtip%
		%
		\pgfmathanglebetweenpoints{\midpoint}{\beforearrowtipanchor}%
		\let\mid@angle@beforearrowtip\pgfmathresult%
		\addtosavedmacro\mid@angle@beforearrowtip%
		%
		\pgfmathanglebetweenpoints{\basepoint}{\beforearrowtipanchor}%
		\let\base@angle@beforearrowtip\pgfmathresult%
		\addtosavedmacro\base@angle@beforearrowtip%
		%
		\addtosavedmacro\arrowtipanchor%
		\addtosavedmacro\beforearrowtipanchor%
		\addtosavedmacro\beforearrowheadanchor%
	}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}%
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+0.5ex}%
	}%
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt%
	}%
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\midpoint}%
	\anchor{mid east}{%
		\getdoublearrowpoints%
		\let\pgf@singlearrow@referencepoint\midpoint%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}	
	\anchor{mid west}{%
		\getdoublearrowpoints%
		\let\pgf@singlearrow@referencepoint\midpoint%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}	
	\anchor{base}{\basepoint}%
	\anchor{base east}{%
		\getdoublearrowpoints%
		\let\pgf@singlearrow@referencepoint\basepoint%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}	
	\anchor{base west}{%
		\getdoublearrowpoints%
		\let\pgf@singlearrow@referencepoint\basepoint%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}	
	\anchor{north}{%
		\getdoublearrowpoints%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{0pt}{\externalradius}}%
	}
	\anchor{south}{%
		\getdoublearrowpoints%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{0pt}{-\externalradius}}%
	}
	\anchor{east}{%
		\getdoublearrowpoints%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}
	\anchor{west}{%
		\getdoublearrowpoints%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}
	\anchor{north east}{%
		\getdoublearrowpoints%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{\externalradius}{\externalradius}}%
	}
	\anchor{south east}{%
		\getdoublearrowpoints%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{\externalradius}{-\externalradius}}%
	}
	\anchor{south west}{%
		\getdoublearrowpoints%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{-\externalradius}{-\externalradius}}%
	}
	\anchor{north west}{%
		\getdoublearrowpoints%
		\csname pgf@anchor@double arrow@border\endcsname{\pgfqpoint{-\externalradius}{\externalradius}}%
	}
	\anchor{before head 1}{%
		\getdoublearrowpoints%
		\pgfmathrotatepointaround{\beforearrowheadanchor}{\centerpoint}{\rotate}%
	}%
	\anchor{before tip 1}{%
		\getdoublearrowpoints%
		\pgfmathrotatepointaround{\beforearrowtipanchor}{\centerpoint}{\rotate}%
	}%
	\anchor{tip 1}{%
		\getdoublearrowpoints%
		\pgfmathrotatepointaround{\arrowtipanchor}{\centerpoint}{\rotate}%
	}%
	\anchor{after tip 1}{%
		\getdoublearrowpoints%
		\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\beforearrowtipanchor}%
				\pgf@y-\pgf@y%
			}{\centerpoint}}%
		{\centerpoint}{\rotate}%
	}
	\anchor{after head 1}{%
		\getdoublearrowpoints%
		\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\beforearrowheadanchor}%
				\pgf@y-\pgf@y%
			}{\centerpoint}}%
		{\centerpoint}{\rotate}%
	}
	\anchor{before head 2}{%
		\getdoublearrowpoints%
		\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\beforearrowheadanchor}%
				\pgf@x-\pgf@x%
				\pgf@y-\pgf@y%
			}{\centerpoint}}%
		{\centerpoint}{\rotate}%
	}%
	\anchor{before tip 2}{%
		\getdoublearrowpoints%
		\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\beforearrowtipanchor}%
				\pgf@x-\pgf@x%
				\pgf@y-\pgf@y%
			}{\centerpoint}}%
		{\centerpoint}{\rotate}%
	}%
	\anchor{tip 2}{%
		\getdoublearrowpoints%
		\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\arrowtipanchor}%
				\pgf@x-\pgf@x%
			}{\centerpoint}}%
		{\centerpoint}{\rotate}%
	}%
	\anchor{after tip 2}{%
		\getdoublearrowpoints%
		\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\beforearrowtipanchor}%
				\pgf@x-\pgf@x%
			}{\centerpoint}}%
		{\centerpoint}{\rotate}%
	}
	\anchor{after head 2}{%
		\getdoublearrowpoints%
		\pgfmathrotatepointaround{%
			\pgfpointadd{%
				\pgfpointdiff{\centerpoint}{\beforearrowheadanchor}%
				\pgf@x-\pgf@x%
			}{\centerpoint}}%
		{\centerpoint}{\rotate}%
	}
	\backgroundpath{%
		{%
			\pgftransformshift{\centerpoint}%
			\pgftransformrotate{\rotate}%
			\pgfpathmoveto{\arrowtip}%
			\pgfpathlineto{\beforearrowtip}%
			\pgfpathlineto{\beforearrowhead}%
			\pgfpathlineto{\beforearrowhead\pgf@x-\pgf@x}%
			\pgfpathlineto{\beforearrowtip\pgf@x-\pgf@x}%
			\pgfpathlineto{\arrowtip\pgf@x-\pgf@x}%
			\pgfpathlineto{\beforearrowtip\pgf@x-\pgf@x\pgf@y-\pgf@y}%
			\pgfpathlineto{\beforearrowhead\pgf@x-\pgf@x\pgf@y-\pgf@y}%
			\pgfpathlineto{\beforearrowhead\pgf@y-\pgf@y}%
			\pgfpathlineto{\beforearrowtip\pgf@y-\pgf@y}%			
		}%
		\pgfpathclose%
	}%
	\anchorborder{%
		\pgfsavepgf@process\externalpoint{}%			
		\getdoublearrowpoints%
		\pgfutil@ifundefined{pgf@singlearrow@referencepoint}{\let\referencepoint\centerpoint}%
			{\let\referencepoint\pgf@singlearrow@referencepoint}%
		\pgfsavepgf@process\externalpoint{%
			\externalpoint%
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\referencepoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya}% 
		\pgfmathanglebetweenpoints{\centerpoint}{\externalpoint}%
		\pgfmathsubtract@{\pgfmathresult}{\rotate}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		\let\externalangle\pgfmathresult%
		\pgf@x\externalangle pt\relax%
		\ifx\referencepoint\midpoint%
			\pgf@xa\mid@angle@beforearrowtip pt\relax%
		\else%
			\ifx\referencepoint\basepoint%
				\pgf@xa\base@angle@beforearrowtip pt\relax%
			\else%
				\pgf@xa\center@angle@beforearrowtip pt\relax%
			\fi%
		\fi%
		\ifdim\pgf@x<180pt\relax%
			\ifdim\pgf@x<\pgf@xa%
				\let\firstpoint\arrowtipanchor%
				\let\secondpoint\beforearrowtipanchor%
			\else%
				\pgf@xa-\pgf@xa%
				\advance\pgf@xa180pt\relax%
				\ifdim\pgf@x<\pgf@xa%
					\let\firstpoint\beforearrowheadanchor%
					\pgfsavepgf@process\secondpoint{%
						\pgfpointadd{%
							\pgfpointdiff{\centerpoint}{\beforearrowheadanchor}%
							\pgf@x-\pgf@x
							}{\centerpoint}}%
				\else%
					\pgfsavepgf@process\firstpoint{%
						\pgfpointadd{%
							\pgfpointdiff{\centerpoint}{\beforearrowtipanchor}%
							\pgf@x-\pgf@x
							}{\centerpoint}}%
					\pgfsavepgf@process\secondpoint{%
						\pgfpointadd{%
							\pgfpointdiff{\centerpoint}{\arrowtipanchor}%
							\pgf@x-\pgf@x%
							\pgf@y-\pgf@y%
						}{\centerpoint}}%
				\fi%
			\fi%
		\else%
			\pgf@xa-\pgf@xa%
			\advance\pgf@xa360pt\relax%
			\ifdim\pgf@x<\pgf@xa%
				\pgf@xa-\pgf@xa%
				\advance\pgf@xa540pt\relax%
				\ifdim\pgf@x<\pgf@xa%
					\pgfsavepgf@process\firstpoint{%
						\pgfpointadd{%
							\pgfpointdiff{\centerpoint}{\arrowtipanchor}%
							\pgf@x-\pgf@x%
						}{\centerpoint}}%
					\pgfsavepgf@process\secondpoint{%
						\pgfpointadd{%
							\pgfpointdiff{\centerpoint}{\beforearrowtipanchor}%
							\pgf@x-\pgf@x%
							\pgf@y-\pgf@y%
						}{\centerpoint}}%
				\else%
					\pgfsavepgf@process\firstpoint{%
						\pgfpointadd{%
							\pgfpointdiff{\centerpoint}{\beforearrowheadanchor}%
							\pgf@x-\pgf@x%
							\pgf@y-\pgf@y%
						}{\centerpoint}}%
					\pgfsavepgf@process\secondpoint{%
						\pgfpointadd{%
							\pgfpointdiff{\centerpoint}{\beforearrowheadanchor}%
							\pgf@y-\pgf@y%
						}{\centerpoint}}%
				\fi%
			\else%
				\pgfsavepgf@process\firstpoint{%
						\pgfpointadd{%
							\pgfpointdiff{\beforearrowtipanchor}{\centerpoint}%
							\pgf@x-\pgf@x%
						}{\centerpoint}}%
				\let\secondpoint\arrowtipanchor%
			\fi%
		\fi%
		\pgfsavepgf@process\firstpoint{%
			\pgfmathrotatepointaround{\firstpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\secondpoint{%
			\pgfmathrotatepointaround{\secondpoint}{\centerpoint}{\rotate}%
		}%
		\pgfpointintersectionoflines{\referencepoint}{\externalpoint}%
			{\firstpoint}{\secondpoint}%			
	}%
}


\endinput
