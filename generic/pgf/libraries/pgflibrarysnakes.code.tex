% Copyright 2006 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header$

\usepgfmodule{snakes}

\newdimen\pgfsnakesegmentamplitude
\newdimen\pgfsnakesegmentlength
\def\pgfsnakesegmentangle{45}
\def\pgfsnakesegmentobjectlength{\pgfsnakesegmentamplitude}
\def\pgfsnakesegmentaspect{0.5}

\pgfsnakesegmentlength=10pt
\pgfsnakesegmentamplitude=2.5pt


\pgfkeys{%
  /pgf/segment amplitude/.code={\pgfmathsetlength{\pgfsnakesegmentamplitude}{#1}},
  /pgf/segment length/.code={\pgfmathsetlength{\pgfsnakesegmentlength}{#1}},
  /pgf/segment angle/.code={\pgfmathparse{#1}\let\pgfsnakesegmentangle=\pgfmathresult},
  /pgf/segment aspect/.code={\pgfmathparse{#1}\let\pgfsnakesegmentaspect=\pgfmathresult},
  /pgf/segment object length/.code={\pgfmathparse{#1}\edef\pgfsnakesegmentobjectlength{\pgfmathresult pt}}}


% snake snake
%
% This snake produces a hopefully optically pleasing squiggly snake. 
%
% Parameters: \pgfsnakesegmentamplitude, \pgfsnakesegmentlength

\pgfdeclaresnake{snake}{initial}
{
  \state{initial}[switch if less than=+.625\pgfsnakesegmentlength to final,
                  width=+.3125\pgfsnakesegmentlength,
                  next state=down]
  { 
    \pgfpathcurveto
    {\pgfqpoint{.125\pgfsnakesegmentlength}{0pt}}
    {\pgfqpoint{.1875\pgfsnakesegmentlength}{\pgfsnakesegmentamplitude}}
    {\pgfqpoint{.3125\pgfsnakesegmentlength}{\pgfsnakesegmentamplitude}}
  }
  \state{down}[switch if less than=+.8125\pgfsnakesegmentlength to end down,
               width=+.5\pgfsnakesegmentlength,
               next state=up]
  {
    \pgfpathcosine{\pgfqpoint{.25\pgfsnakesegmentlength}{-1\pgfsnakesegmentamplitude}}
    \pgfpathsine{\pgfqpoint{.25\pgfsnakesegmentlength}{-1\pgfsnakesegmentamplitude}}
  }               
  \state{up}[switch if less than=+.8125\pgfsnakesegmentlength to end up,
             width=+.5\pgfsnakesegmentlength,
             next state=down]
  {
    \pgfpathcosine{\pgfqpoint{.25\pgfsnakesegmentlength}{\pgfsnakesegmentamplitude}}
    \pgfpathsine{\pgfqpoint{.25\pgfsnakesegmentlength}{\pgfsnakesegmentamplitude}}
  }               
  \state{end down}[width=+.3125\pgfsnakesegmentlength,
                   next state=final]
  {
    \pgfpathcurveto
    {\pgfqpoint{.125\pgfsnakesegmentlength}{\pgfsnakesegmentamplitude}}
    {\pgfqpoint{.1875\pgfsnakesegmentlength}{0pt}}
    {\pgfqpoint{.3125\pgfsnakesegmentlength}{0pt}}
  }  
  \state{end up}[width=+.3125\pgfsnakesegmentlength,
                 next state=final]
  {
    \pgfpathcurveto
    {\pgfqpoint{.125\pgfsnakesegmentlength}{-\pgfsnakesegmentamplitude}}
    {\pgfqpoint{.1875\pgfsnakesegmentlength}{0pt}}
    {\pgfqpoint{.3125\pgfsnakesegmentlength}{0pt}}
  }  
  \state{final}
  { \pgfpathlineto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}} }
}




% zigzag snake
%
% Parameters: \pgfsnakesegmentamplitude, \pgfsnakesegmentlength

\pgfdeclaresnake{zigzag}{up}
{
  \state{up}[width=+.5\pgfsnakesegmentlength,%
             next state=down]
  {
    \pgfpathlineto{\pgfqpoint{.25\pgfsnakesegmentlength}{\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{.5\pgfsnakesegmentlength}{0pt}}
  }
  \state{down}[width=+.5\pgfsnakesegmentlength,%
               next state=up]
  {
    \pgfpathlineto{\pgfqpoint{.25\pgfsnakesegmentlength}{-\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{.5\pgfsnakesegmentlength}{0pt}}
  }
  \state{final}
  { \pgfpathlineto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}} }
}



% saw snake
%
% Parameters: \pgfsnakesegmentamplitude, \pgfsnakesegmentlength

\pgfdeclaresnake{saw}{initial}
{
  \state{initial}[width=+\pgfsnakesegmentlength]
  {
    \pgfpathlineto{\pgfqpoint{\pgfsnakesegmentlength}{\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfsnakesegmentlength}{0pt}}
  }
  \state{final}
  {
    \pgfpathlineto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
  }
}


% coil snake
%
% Parameters: \pgfsnakesegmentamplitude, \pgfsnakesegmentlength,

\pgfdeclaresnake{coil}{coil}
{
  \state{coil}[switch if less than=%
    1.5\pgfsnakesegmentlength+%
    \pgfsnakesegmentaspect\pgfsnakesegmentamplitude+%
    \pgfsnakesegmentaspect\pgfsnakesegmentamplitude to last,
               width=+\pgfsnakesegmentlength]
  {
    \pgfpathcurveto
    {\pgfpoint@oncoil{0    }{ 0.555}{1}}
    {\pgfpoint@oncoil{0.445}{ 1    }{2}}
    {\pgfpoint@oncoil{1    }{ 1    }{3}}
    \pgfpathcurveto
    {\pgfpoint@oncoil{1.555}{ 1    }{4}}
    {\pgfpoint@oncoil{2    }{ 0.555}{5}}
    {\pgfpoint@oncoil{2    }{ 0    }{6}}
    \pgfpathcurveto
    {\pgfpoint@oncoil{2    }{-0.555}{7}}
    {\pgfpoint@oncoil{1.555}{-1    }{8}}
    {\pgfpoint@oncoil{1    }{-1    }{9}}
    \pgfpathcurveto
    {\pgfpoint@oncoil{0.445}{-1    }{10}}
    {\pgfpoint@oncoil{0    }{-0.555}{11}}
    {\pgfpoint@oncoil{0    }{ 0    }{12}}
  }
  \state{last}[width=.5\pgfsnakesegmentlength+%
    \pgfsnakesegmentaspect\pgfsnakesegmentamplitude+%
    \pgfsnakesegmentaspect\pgfsnakesegmentamplitude,next state=final]
  {
    \pgfpathcurveto
    {\pgfpoint@oncoil{0    }{ 0.555}{1}}
    {\pgfpoint@oncoil{0.445}{ 1    }{2}}
    {\pgfpoint@oncoil{1    }{ 1    }{3}}
    \pgfpathcurveto
    {\pgfpoint@oncoil{1.555}{ 1    }{4}}
    {\pgfpoint@oncoil{2    }{ 0.555}{5}}
    {\pgfpoint@oncoil{2    }{ 0    }{6}}
  }
  \state{final}
  {
    \pgfpathlineto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
  }
}

\def\pgfpoint@oncoil#1#2#3{%
  \pgf@x=#1\pgfsnakesegmentamplitude%
  \pgf@x=\pgfsnakesegmentaspect\pgf@x%
  \pgf@y=#2\pgfsnakesegmentamplitude%
  \pgf@xa=0.083333333333\pgfsnakesegmentlength%
  \advance\pgf@x by#3\pgf@xa%
}


% bumps snake
%
% Parameters: \pgfsnakesegmentamplitude, \pgfsnakesegmentlength

\pgfdeclaresnake{bumps}{initial}
{
  \state{initial}[width=+.5\pgfsnakesegmentlength]
  {
    \pgfpathcurveto
    {\pgfqpoint{0pt}{.555\pgfsnakesegmentamplitude}}
    {\pgfqpoint{0.11125\pgfsnakesegmentlength}{\pgfsnakesegmentamplitude}}
    {\pgfqpoint{.25\pgfsnakesegmentlength}{\pgfsnakesegmentamplitude}}
    \pgfpathcurveto
    {\pgfqpoint{.38875\pgfsnakesegmentlength}{\pgfsnakesegmentamplitude}}
    {\pgfqpoint{.5\pgfsnakesegmentlength}{.5\pgfsnakesegmentamplitude}}
    {\pgfqpoint{.5\pgfsnakesegmentlength}{0\pgfsnakesegmentamplitude}}
  }
  \state{final}
  {
    \pgfpathlineto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
  }
}



% expanding waves snake
%
% Parameters: \pgfsnakesegmentangle, \pgfsnakesegmentlength

\pgfdeclaresnake{expanding waves}{initial}
{
  \state{initial}[width=+\pgfsnakesegmentlength,next state=wave]
  {}

  \state{wave}[switch if less than=+\pgfsnakesegmentlength to last,
               width=+\pgfsnakesegmentlength]
  {
    \pgfpathmoveto{
      \pgfpointadd
      {\pgfqpoint{-\pgfsnakecompleteddistance}{0pt}}%
      {\pgfpointpolar{\pgfsnakesegmentangle}{+\pgfsnakecompleteddistance}}}%
    \pgfpatharc{\pgfsnakesegmentangle}{-\pgfsnakesegmentangle}{+\pgfsnakecompleteddistance}%
  }
  \state{last}[width=+0pt,next state=final]
  {
    \pgfpathmoveto{
      \pgfpointadd
      {\pgfqpoint{-\pgfsnakecompleteddistance}{0pt}}%
      {\pgfpointpolar{\pgfsnakesegmentangle}{+\pgfsnakecompleteddistance}}}%
    \pgfpatharc{\pgfsnakesegmentangle}{-\pgfsnakesegmentangle}{+\pgfsnakecompleteddistance}%
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
  }
}



% waves snake
%
% Parameters: \pgfsnakesegmentangle, \pgfsnakesegmentlength

\pgfdeclaresnake{waves}{wave}
{
  \state{wave}[width=\pgfsnakesegmentlength]
  {
    \pgftransformxshift{+\pgfsnakesegmentlength}
    \pgfpathmoveto{
      \pgfpointadd
      {\pgfqpoint{-\pgfsnakesegmentobjectlength}{0pt}}%
      {\pgfpointpolar{\pgfsnakesegmentangle}{+\pgfsnakesegmentobjectlength}}}%
    \pgfpatharc{\pgfsnakesegmentangle}{-\pgfsnakesegmentangle}{+\pgfsnakesegmentobjectlength}%
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
  }
}


% triangle snakes
%
% Parameters: \pgfsnakesegmentlength, \pgfsnakeobjectsize, \pgfsnakesegmentamplitude

\pgfdeclaresnake{triangles}{triangle}
{
  \state{triangle}[switch if less than=+\pgfsnakesegmentlength to last,
                   width=+\pgfsnakesegmentlength]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfsnakesegmentobjectlength}{0pt}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfsnakesegmentamplitude}}
    \pgfpathclose
  }
  \state{last}[width=+\pgfsnakesegmentobjectlength,next state=final]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfsnakesegmentobjectlength}{0pt}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfsnakesegmentamplitude}}
    \pgfpathclose
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
  }
}



% crosses snakes
%
% Parameters: \pgfsnakesegmentlength, \pgfsnakeobjectsize, \pgfsnakesegmentamplitude

\pgfdeclaresnake{crosses}{crosses}
{
  \state{crosses}[switch if less than=+\pgfsnakesegmentlength to last,
                   width=+\pgfsnakesegmentlength]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfsnakesegmentobjectlength}{-\pgfsnakesegmentamplitude}}
    \pgfpathmoveto{\pgfqpoint{0pt}{-\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfsnakesegmentobjectlength}{\pgfsnakesegmentamplitude}}
  }
  \state{last}[width=\pgfsnakesegmentobjectlength,next state=final]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfsnakesegmentobjectlength}{-1\pgfsnakesegmentamplitude}}
    \pgfpathmoveto{\pgfqpoint{0pt}{-\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfsnakesegmentobjectlength}{\pgfsnakesegmentamplitude}}
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
  }
}



% ticks snakes
%
% Parameters: \pgfsnakesegmentlength, \pgfsnakesegmentamplitude

\pgfdeclaresnake{ticks}{ticks}
{
  \state{ticks}[width=+\pgfsnakesegmentlength]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfsnakesegmentamplitude}}
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfsnakesegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfsnakesegmentamplitude}}
    \pgfpathmoveto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
  }
}


% border snake
%
% Parameters: \pgfsnakesegmentlength, \pgfsnakesegmentamplitude, \pgfsnakesegmentangle

\pgfdeclaresnake{border}{tick}
{
  \state{tick}[switch if less than=+\pgfsnakesegmentlength to last,
               width=+\pgfsnakesegmentlength]
  {
    \pgfpathmoveto{\pgfpointorigin}
    \pgfpathlineto{\pgfpointpolar{\pgfsnakesegmentangle}{+\pgfsnakesegmentamplitude}}
  }
  \state{last}[width=+\pgfsnakesegmentamplitude,next state=final]
  {
    \pgfpathmoveto{\pgfpointorigin}
    \pgfpathlineto{\pgfpointpolar{\pgfsnakesegmentangle}{+\pgfsnakesegmentamplitude}}
  }  
  \state{final}
  {
    \pgfpathmoveto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
  }
}




% brace snakes
%
% Parameters: \pgfsnakesegmentamplitude

\pgfdeclaresnake{brace}{brace}
{
  \state{brace}[width=+\pgfsnakeremainingdistance,next state=final]
  {
    \pgfpathmoveto{\pgfpointorigin}
    \pgfpathcurveto
    {\pgfqpoint{.15\pgfsnakesegmentamplitude}{.3\pgfsnakesegmentamplitude}}
    {\pgfqpoint{.5\pgfsnakesegmentamplitude}{.5\pgfsnakesegmentamplitude}}
    {\pgfqpoint{\pgfsnakesegmentamplitude}{.5\pgfsnakesegmentamplitude}}
    {
      \pgftransformxshift{+\pgfsnakesegmentaspect\pgfsnakeremainingdistance}
      \pgfpathlineto{\pgfqpoint{-\pgfsnakesegmentamplitude}{.5\pgfsnakesegmentamplitude}}
      \pgfpathcurveto
      {\pgfqpoint{-.5\pgfsnakesegmentamplitude}{.5\pgfsnakesegmentamplitude}}
      {\pgfqpoint{-.15\pgfsnakesegmentamplitude}{.7\pgfsnakesegmentamplitude}}
      {\pgfqpoint{0\pgfsnakesegmentamplitude}{1\pgfsnakesegmentamplitude}}
      \pgfpathcurveto
      {\pgfqpoint{.15\pgfsnakesegmentamplitude}{.7\pgfsnakesegmentamplitude}}
      {\pgfqpoint{.5\pgfsnakesegmentamplitude}{.5\pgfsnakesegmentamplitude}}
      {\pgfqpoint{\pgfsnakesegmentamplitude}{.5\pgfsnakesegmentamplitude}}
    }
    {
      \pgftransformxshift{+\pgfsnakeremainingdistance}
      \pgfpathlineto{\pgfqpoint{-\pgfsnakesegmentamplitude}{.5\pgfsnakesegmentamplitude}}
      \pgfpathcurveto
      {\pgfqpoint{-.5\pgfsnakesegmentamplitude}{.5\pgfsnakesegmentamplitude}}
      {\pgfqpoint{-.15\pgfsnakesegmentamplitude}{.3\pgfsnakesegmentamplitude}}
      {\pgfqpoint{0pt}{0pt}}
    }
  }
  \state{final}
  {}
}



% bent snake
%
% A snake that looks like someone bent the line a bit.
%
% Parameters: \pgfsnakesegmentamplitude, \pgfsnakesegmentaspect

\pgfdeclaresnake{bent}{bent}
{
  \state{bent}[width=+\pgfsnakeremainingdistance,next state=final]
  {
    \pgfpathcurveto
    {\pgfqpoint{\pgfsnakesegmentaspect\pgfsnakeremainingdistance}{\pgfsnakesegmentamplitude}}
    {\pgfpointadd{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
       {\pgfqpoint{-\pgfsnakesegmentaspect\pgfsnakeremainingdistance}{\pgfsnakesegmentamplitude}}}
    {\pgfqpoint{\pgfsnakeremainingdistance}{0pt}}
  }
  \state{final}
  {}
}



% random steps snake
%
% A snake that consists of random steps heading towards the target
%
% Parameters: \pgfsnakesegmentamplitude, \pgfsnakesegmentlength

\pgfdeclaresnake{random steps}{step}
{
  \state{step}[width=+\pgfsnakesegmentlength,next state=step]
  {
    \pgfpathlineto{
      \pgfpointadd
      {\pgfqpoint{\pgfsnakesegmentlength}{0pt}}
      {\pgfpoint{rand*\pgfsnakesegmentamplitude}{rand*\pgfsnakesegmentamplitude}}
    }
  }

  \state{final}
  { \pgfpathlineto{\pgfqpoint{\pgfsnakeremainingdistance}{0pt}} }
}



%	The Shape Snake
%	
%	The shape snake is snake that consists of repeated instances of 
%	the path of a specified shape. The shape must have been declared 
%	by \pgfdeclareshape. If a shape has specialized keys (e.g. the
%	number of points on a star, or the apex angle the isosceles
%	triangle), these can be specified in the usual manner. 
%	
%	The sepatation between shapes in the path can be specified and can 
%	be between the center of the shape or the border of the shape. 
%	
%	The height and width of the shape can be independently or
%	simultaneously scaled (linearly) along the path. It is also
% possible to prevent the shapes being sloped parallel to the
% path.

% Keys for snake: shape snake
%
% /pgf/shape snake shape        : the shape used in the snake.
% /pgf/shape snake sep          : the distance between shape borders.
% /pgf/shape snake scaled       : scale the shapes in the snake along the path.
% /pgf/shape snake start width  : recommended starting width.
% /pgf/shape snake start height : recommended starting height.
% /pgf/shape snake start size
% /pgf/shape snake end width    : recommended ending width.
% /pgf/shape snake end height   : recommended ending height.
% /pgf/shape snake end size
% /pgf/shape snake sloped       : make the shapes slope parallel to the path.

\pgfkeys{/pgf/.cd,
	shape snake shape/.initial=circle,
	shape snake sep/.initial={.25cm, between centers},
	%
	shape snake start width/.initial=.25cm,
	shape snake start height/.initial=.25cm,
	shape snake start size/.style={%
		/pgf/shape snake start width=#1,
		/pgf/shape snake start height=#1%
	},%
	shape snake end width/.initial=.125cm,
	shape snake end height/.initial=.125cm,
	shape snake end size/.style={%
		/pgf/shape snake end width=#1,
		/pgf/shape snake end height=#1%
	},%
	shape snake sep/.store in=\pgf@lib@shapesnake@sep
}%

\def\pgf@lib@shapesnake@sep{.25cm, between centers}

\newif\ifpgfshapesnakesloped
\pgfshapesnakeslopedtrue
\newif\ifpgfshapesnakescaled

\pgfkeys{/pgf/.cd,
	shape snake sloped/.is if=pgfshapesnakesloped,
	shape snake scaled/.is if=pgfshapesnakescaled,
	shape snake evenly spread/.store in=\pgf@lib@shapesnake@spread}

\let\pgf@lib@shapesnake@spread\pgfutil@empty%

% internal if
\newif\ifpgf@lib@shapesnake@betweenborders

\edef\pgf@lib@shapesnake@initialise{0pt}%

\pgfdeclaresnake{shape snake}{initialise}
{
	\state{initialise}[width=+\pgf@lib@shapesnake@initialise,next state=shape]
	{
		%
		% \egroup ends the group started by the automaton before executing
		% a snake state. This prevents the need for (most) \global variables. 
		%
		\egroup% 
			%
			% Check the shape exists.
			%
			\pgfutil@ifundefined{pgf@sh@bg@\pgfkeysvalueof{/pgf/shape snake shape}}{%
				\PackageError{PGF}{I do not know the shape `\pgfkeysvalueof{/pgf/shape snake shape}',
				so I cannot use it in a snake. Check if its library been loaded or if you 
				simply mistyped the name}{}}{}%
			%
		  % Calculate a `default' path size.
		  %
		  \pgfinterruptpath%
				\pgfinterruptboundingbox%
					\pgftransformreset%
					\pgf@relevantforpicturesizetrue%
					%
					% This size of this shape is unimportant, but it should
					% be just large/small enough to avoid huge errors when
					% calculting the scaling factors later on.
					%			
					\pgfkeys{/pgf/inner sep=50pt, /pgf/minimum size=1pt}% Arbitrary lengths.
					\setbox\pgfnodeparttextbox\hbox{}% Assume shape does nothing special if box is empty.
					\let\pgf@sh@savedmacros\pgfutil@empty% 
				  \let\pgf@sh@savedpoints\pgfutil@empty%
				  \csname pgf@sh@s@\pgfkeysvalueof{/pgf/shape snake shape}\endcsname%
				  \pgf@sh@savedpoints%
				  \pgf@sh@savedmacros%
				  %
				  % Save the macros and pionts.
				  %
				  \expandafter\gdef\expandafter\pgf@lib@shapesnake@points\expandafter{\pgf@sh@savedpoints}%
				  \expandafter\gdef\expandafter\pgf@lib@shapesnake@macros\expandafter{\pgf@sh@savedmacros}%
					\csname pgf@sh@bg@\pgfkeysvalueof{/pgf/shape snake shape}\endcsname% 
					%
					% Save the dimensions of the shape path.
					%
					\pgf@x\pgf@picmaxx%
					\pgf@y\pgf@picmaxy%
					\advance\pgf@x-\pgf@picminx%
					\advance\pgf@y-\pgf@picminy%
					\xdef\pgf@lib@shapesnake@shapepathsize{%
						\noexpand\pgf@x\the\pgf@x%
						\noexpand\pgf@y\the\pgf@y%
					}%
				\endpgfinterruptboundingbox%
			\endpgfinterruptpath%
			%
			\edef\pgf@lib@shapesnake@beforeshape{0pt}%
			\edef\pgf@lib@shapesnake@aftershape{0pt}%
			%
			\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/shape snake start width}}%
			\edef\pgf@lib@shapesnake@startwidth{\the\pgf@x}%
			\edef\pgf@lib@shapesnake@width{\the\pgf@x}%
			\pgf@x-\pgf@x%
			\pgfmathaddtolength\pgf@x{\pgfkeysvalueof{/pgf/shape snake end width}}%
			\edef\pgf@lib@shapesnake@widthchange{\the\pgf@x}%
			%
			\pgfmathsetlength\pgf@y{\pgfkeysvalueof{/pgf/shape snake start height}}%
			\edef\pgf@lib@shapesnake@initialheight{\the\pgf@y}%
			\edef\pgf@lib@shapesnake@height{\the\pgf@y}%
			\pgf@y-\pgf@y%
			\pgfmathaddtolength\pgf@y{\pgfkeysvalueof{/pgf/shape snake end height}}%
			\edef\pgf@lib@shapesnake@heightchange{\the\pgf@y}%		
			%
			% Calculate the sep.
			%
			\ifx\pgf@lib@shapesnake@spread\pgfutil@empty%
				% 
				% Not spreading, so easy:
				%
				\def\pgf@lib@shapesnake@borderstext{between borders}%
				\afterassignment\pgf@lib@shapesnake@setkeyword%
				\expandafter\pgf@x\pgf@lib@shapesnake@sep,\pgf@stop%
				\edef\pgf@lib@shapesnake@sep{\the\pgf@x}%
			\else%
				%
				% Spreading (a bit of a nuiscence actually).
				%
				\def\pgf@lib@shapesnake@borderstext{by borders}%
				\afterassignment\pgf@lib@shapesnake@setkeyword%
				\expandafter\c@pgf@counta\pgf@lib@shapesnake@spread,\pgf@stop%
				\ifpgf@lib@shapesnake@betweenborders%
					%
					% Ok. The required sep between borders is:
					% 
					% (r -(n-1)((a+b)/2))/(n-1)
					%
					% r = snake length (here, the remaining distance)
					% a = initial width
					% b = end width
					% n = the number of shapes
					%
					\ifnum\c@pgf@counta>1\relax%
						\advance\c@pgf@counta-1\relax%
						\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/shape snake start width}}%
						\ifpgfshapesnakescaled%
							\pgfmathaddtolength\pgf@x{\pgfkeysvalueof{/pgf/shape snake end width}}%
						\else%
							\advance\pgf@x\pgf@x%
						\fi%
						\pgf@x.5\pgf@x% (a+b)/2
						\multiply\pgf@x-\c@pgf@counta% -(n-1)((a+b)/2)
						\advance\pgf@x\pgfsnakeremainingdistance%
						\divide\pgf@x\c@pgf@counta%
						\pgf@x.9999\pgf@x% Hackery to control some native TeX inaccuracies.
						%
						% Unfortunately if the shape is scaled, and evenly spread by borders,
						% it is necessary to do something a bit different to control for 
						% (most) inaccuracies.
						% 
						\ifpgfshapesnakescaled%
							\pgf@xa\pgf@lib@shapesnake@widthchange\relax%
							\divide\pgf@xa\c@pgf@counta%
							\edef\pgf@lib@shapesnake@specialwidth{\the\pgf@xa}%		
						\fi%
					\else%
						\pgf@lib@shapesnake@betweenbordersfalse%
						\pgf@x\pgfsnakeremainingdistance%
						\ifnum\c@pgf@counta=1\relax%
							\pgf@y.5\pgf@x%
							\edef\pgf@lib@shapesnake@initialise{\the\pgf@y}%
						\else%
							\advance\pgf@x5pt\relax% An arbitrary value >0pt.
							\edef\pgf@lib@shapesnake@initialise{\the\pgf@x}%
						\fi%
					\fi%	
				\else%
					%
					% Between centers.
					%
					\pgf@x\pgfsnakeremainingdistance%
					\ifnum\c@pgf@counta>1\relax%
						\advance\c@pgf@counta-1\relax%
						\divide\pgf@x\c@pgf@counta\relax%
					\else%
						\ifnum\c@pgf@counta=1\relax%
							\pgf@y.5\pgf@x%
							\edef\pgf@lib@shapesnake@initialise{\the\pgf@y}%
						\else%
							\advance\pgf@x5pt\relax% An arbitrary value >0pt.
							\edef\pgf@lib@shapesnake@initialise{\the\pgf@x}%
						\fi%
					\fi%
				\fi%
				\edef\pgf@lib@shapesnake@sep{\the\pgf@x}%
			\fi%
		%
		% \bgroup starts the group ended at the beginning of the state.
		%
		\bgroup%
	}
	\state{before shape}[width=+\pgf@lib@shapesnake@beforeshape,next state=shape]
	{
		\egroup%
			\ifpgfshapesnakescaled%
				\ifpgf@lib@shapesnake@betweenborders%
					\ifx\pgf@lib@shapesnake@spread\pgfutil@empty%
						%
						% Not so straightforward. The required ratio is given by
						%
						% R = (c+W/2)/(c+r-.5*w)
						%
						% c = completed distance
						% r = remaining distance
						% W = initial width
						% w = the change in width (i.e., end - start)
						%
						\pgf@x\pgfsnakecompleteddistance%
						\advance\pgf@x\pgfsnakeremainingdistance%
						\pgf@xa\pgf@lib@shapesnake@startwidth\relax%
						\pgf@xa.5\pgf@xa%
						\advance\pgf@xa\pgfsnakecompleteddistance% c+W/2
						%
						\pgf@xb\pgf@lib@shapesnake@widthchange\relax%
						\pgf@xb-.5\pgf@xb%
						\advance\pgf@xb\pgf@x% c+r-.5*w
						%
						\pgfmathdivide@{\pgfmath@tonumber{\pgf@xa}}{\pgfmath@tonumber{\pgf@xb}}%
					\fi%
				\else%
					%
					% Easy peasy. The required ratio is 
					%
					% R = c / (c+r)
					%
					\pgf@x\pgfsnakecompleteddistance%
					\advance\pgf@x\pgfsnakeremainingdistance%
					\pgfmathdivide@{\pgfmath@tonumber{\pgfsnakecompleteddistance}}{\pgfmath@tonumber{\pgf@x}}%			
				\fi%
				%
				% Get the new width.
				%
				\ifx\pgf@lib@shapesnake@spread\pgfutil@empty%
					\pgf@x\pgf@lib@shapesnake@widthchange\relax%
					\pgf@x\pgfmathresult\pgf@x%
					\advance\pgf@x\pgf@lib@shapesnake@startwidth\relax%
				\else%
					\ifpgf@lib@shapesnake@betweenborders%
						%
						% Specical case when snake is scaled, and evenly spread by borders.
						%
						\pgf@x\pgf@lib@shapesnake@width\relax%
						\advance\pgf@x\pgf@lib@shapesnake@specialwidth\relax%
						\pgf@xa\pgf@x%
						\advance\pgf@xa-\pgf@lib@shapesnake@startwidth\relax%
						\pgf@xb\pgf@lib@shapesnake@widthchange\relax%
						\pgfmathdivide@{\pgfmath@tonumber{\pgf@xa}}{\pgfmath@tonumber{\pgf@xb}}%
					\else%
						\pgf@x\pgf@lib@shapesnake@widthchange\relax%
						\pgf@x\pgfmathresult\pgf@x%
						\advance\pgf@x\pgf@lib@shapesnake@startwidth\relax%
					\fi%
				\fi%		
				\edef\pgf@lib@shapesnake@width{\the\pgf@x}%		
				%
				% New height = R*h + H
				%
				\pgf@y\pgf@lib@shapesnake@heightchange\relax%
				\pgf@y\pgfmathresult\pgf@y%
				\advance\pgf@y\pgf@lib@shapesnake@initialheight\relax%
				\edef\pgf@lib@shapesnake@height{\the\pgf@y}%
			\fi%
			%
			\ifpgf@lib@shapesnake@betweenborders%
				\pgf@x\pgf@lib@shapesnake@width\relax%
				\pgf@x.5\pgf@x%
				\edef\pgf@lib@shapesnake@beforeshape{\the\pgf@x}%
			\else%
				\def\pgf@lib@shapesnake@beforeshape{0pt}%
			\fi%	
		\bgroup%
	}
	\state{shape}[width=+0pt,next state=after shape]
	{
		\ifpgfshapesnakesloped%
		\else%
			\pgftransformrotate{-\pgfsnakeangle}%
		\fi%
		%
	  % Scale the path when it is actually drawn.
	  %
	  \pgf@lib@shapesnake@shapepathsize%
	  \pgfutil@tempdima\pgf@x%
	  \pgfutil@tempdimb\pgf@y%
	  \pgf@xa\pgf@lib@shapesnake@width\relax%
	  \pgf@xb\pgfutil@tempdima%
	  \pgfmathdivide@{\pgfmath@tonumber{\pgf@xa}}{\pgfmath@tonumber{\pgf@xb}}%
	  \expandafter\pgftransformxscale\expandafter{\pgfmathresult}%
	  %
	  \pgf@ya\pgf@lib@shapesnake@height\relax%
	  \pgf@yb\pgfutil@tempdimb%
	  \pgfmathdivide@{\pgfmath@tonumber{\pgf@ya}}{\pgfmath@tonumber{\pgf@yb}}%
	  \expandafter\pgftransformyscale\expandafter{\pgfmathresult}%
	  %
	  % Move to the center anchor.
	  %
	  \pgf@lib@shapesnake@points%
	  \pgf@lib@shapesnake@macros%
	  \pgftransformshift{%
	  	\pgf@sh@reanchor{\pgfkeysvalueof{/pgf/shape snake shape}}{center}%
	  	\pgf@x-\pgf@x%
	   	\pgf@y-\pgf@y%
	  }%
	  %
	  % And draw the shape path.
	  %
	 	\csname pgf@sh@bg@\pgfkeysvalueof{/pgf/shape snake shape}\endcsname%	
	}
	\state{after shape}[width=+\pgf@lib@shapesnake@aftershape,next state=sep]
	{
		\egroup%
			\ifpgf@lib@shapesnake@betweenborders%
				\pgf@x\pgf@lib@shapesnake@width\relax%
				\pgf@x.5\pgf@x%
				\edef\pgf@lib@shapesnake@aftershape{\the\pgf@x}%
			\else%
				\edef\pgf@lib@shapesnake@aftershape{0pt}%
			\fi%	
		\bgroup%
	}
	\state{sep}[width=\pgf@lib@shapesnake@sep,next state=before shape]
	{
		\egroup%
			\def\pgf@lib@shapesnake@beforeshape{0pt}%
		\bgroup%
	}
	\state{final}
	{
		\pgfpathmoveto{\pgfpoint{+\pgfsnakeremainingdistance}{+0pt}}%
	}
}

\def\pgf@lib@shapesnake@setkeyword,{%
	\pgfutil@ifnextchar\pgf@stop{\def\pgf@temp{}\pgf@lib@@@shapesnake@setkeyword}{\pgf@lib@@shapesnake@setkeyword}%
}
\def\pgf@lib@@shapesnake@setkeyword#1,{\def\pgf@temp{#1}\pgf@lib@@@shapesnake@setkeyword}
\def\pgf@lib@@@shapesnake@setkeyword\pgf@stop{%
	\ifx\pgf@temp\pgf@lib@shapesnake@borderstext%
		\pgf@lib@shapesnake@betweenborderstrue%
	\else%
		\pgf@lib@shapesnake@betweenbordersfalse%
	\fi%
}


\endinput