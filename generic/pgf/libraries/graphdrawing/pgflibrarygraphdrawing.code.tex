% Copyright 2010 by RenÃ©e Ahrens, Olof Frahm, Jens Kluttig, Matthias Schulz, Stephan Schuster
% Copyright 2011 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header$


% check if luatex is running
\ifx\directlua\relax%
  \PackageError{pgf}{You need to run LuaTeX to use the graph drawing library}{}
  \expandafter\endinput
\fi
\ifx\directlua\undefined%
  \PackageError{pgf}{You need to run LuaTeX to use the graph drawing library}{}
  \expandafter\endinput
\fi




%
% Basic Interface to the Graph Drawing Engine
%

% 
% In order to use the graph drawing engine, inside a pgfpicture you
% need to create a graph drawing scope using the following commands: 
%



% Begins a new graph drawing scope
%
% Usage:
%
% \pgfgdbeginscope

\def\pgfgdbeginscope{%
  \begingroup
    % get options
    \pgfkeysgetvalue{/tikz/graphs/graph drawing/@options}\pgf@gd@graph@options%
    \pgfkeysgetvalue{/graph drawing/graph parameters}\pgf@gd@graph@parameters%
    \pgf@gd@logmessage{GD:SYS: group started with key options: \pgf@gd@graph@options\pgf@gd@graph@parameters}
    \directlua{
      pgf.graphdrawing.Interface:newGraph("\luaescapestring{\pgf@gd@graph@options\pgf@gd@graph@parameters}")
    }%
    \begingroup
      % Switch on late positioning
      \pgf@gd@positionnodelater
}


% Ends a graph drawing scope
% 
% Description:
%
% This macro invokes the selected graph drawing algorithm and
% ships out all nodes within this scope
%
% See \pgfgdbeginscope

\def\pgfgdendscope{%
      \endgroup
    % Late positioning has ended
    \directlua{
      pgf.graphdrawing.Interface:drawGraph()
      pgf.graphdrawing.Interface:finishGraph()
    }
  \endgroup
}



% 
% All graph drawing keys normally live in the following namespace:
% /graph drawing. 
%

\def\pgfgdset{\pgfqkeys{/graph drawing}}




% Passing options to the graph drawing engine.
% 
% #1 = option's name
% #2 = option's value
% 
% Description:
%
% When a graph drawing algorithm starts working, a set of options,
% called "graph drawing parameters" in the following, can influence the
% way the algorithm works. For instance, an graph drawing parameter
% might be the average distance between vertices which the algorithm
% should take into account. Another example might be the fact the
% certain nodes are special nodes and that a certain edge should have
% a large label.
%
% These graph drawing parameters are different from "usual" pgf
% options: An alogrithmic parameter influenced the way the algorithm
% works, while usual options normally only influence how the result
% looks like. For instance, the fact that a node is red is not an
% graph drawing parameter (usually, at least), while the shape of a node
% might be an graph drawing parameter.
%
% There are three kinds of graph drawing parameters:
%
% 1) graph drawing graph parameters 
%    These parameters influence "the whole graph". An example
%    is the distance between vertices on the same level of a tree. 
%
% 2) graph drawing node parameters
%    These parameters are "attached" to a single node. This includes
%    options that are only meaningful in the context of a graph
%    drawing algorithm (like, say, the "mass" of a node in a
%    force-base algorith), but also hybrid attributed like the shape
%    of a node. The shape is important for pgf when it typesets the
%    node, but it may also be important for the graph drawing
%    algorithm since it might position circles differently from, say,
%    rectangles.
%    
% 3) graph drawing edge parameters
%    Similarly to nodes, edges can also have graph drawing
%    parameters. Also similarly to nodes, there can be purely
%    graph drawing parameters and also options that are hybrid.
%    
% You have to "declare" an graph drawing parameter similarly to a normal
% key, but instead of using the /.code, you use /.graph drawing graph
% parameter, /.graph drawing node parameter, and /.graph drawing edge
% parameter. More details on how these handlers work is given below.
%
% Specifying the set of graph drawing parameters for a given graph or
% node or edge works as follows: When the graph drawing engine is
% started for a graph (using \pgfgdbeginscope), a snapshot is taken of
% all graph drawing graph parameters currently setup at this
% point. Similarly, when a node is created inside such a scope, a
% snapshot is taken of the set of all graph drawing node parameters in
% force at this point is taken and stored together with the
% node. Finally, when an edge is created, a snapshot of the setting of
% the graph drawing edge parameters is taken.
% 
% All of these option sets can easily be accessed inside the graph 
% drawing algorithms, see the documentation of the lua layer.

\def\pgfgdgraphparameter#1#2{%
  \pgfkeysaddvalue{/graph drawing/graph parameters}{}{{#1}{#2}}%
}
\def\pgfgdnodeparameter#1#2{%
  \pgfkeysaddvalue{/graph drawing/node parameters}{}{{#1}{#2}}%
}
\def\pgfgdedgeparameter#1#2{%
  \pgfkeysaddvalue{/graph drawing/edge parameters}{}{{#1}{#2}}%
}

\pgfgdset{
  graph parameters/.initial=,
  node parameters/.initial=,
  edge parameters/.initial=,
}  



% Key handler /.graph drawing graph parameter
% 
% Description:
%
% When this key hanlder is applied to a key, this key becomes a graph
% drawing graph parameter (as explained above). Subsequently, setting
% this key will cause special internals to be setup so that graph
% drawing algorithms can access the value of this key easily and
% directly inside the lua layer.
% 
% A typical usage would be
%
%   /some path/my key/.graph drawing graph parameter
%  
% Now, when people write /some path/my key=foo in their code, inside
% the algorithm the parameter "my key" would be set to "foo".
% 

\pgfkeys{
  /handlers/.graph drawing graph parameter/.code=\pgf@gd@parameter{#1}{\pgfgdgraphparameter},
  /handlers/.graph drawing node parameter/.code=\pgf@gd@parameter{#1}{\pgfgdnodeparameter},
  /handlers/.graph drawing edge parameter/.code=\pgf@gd@parameter{#1}{\pgfgdedgeparameter}
}
\def\pgf@gd@parameter#1#2{%
  \def\pgfgd@temp{#1}%
  \ifx\pgfgd@temp\pgfkeysnovalue@text\def\pgfgd@temp{no conversion}\fi%
  \edef\pgf@marshal{\noexpand\pgf@gd@@parameter{\pgfkeyscurrentpath}{\pgfgd@temp}{\noexpand#2}}
  \pgf@marshal%
}

\def\pgf@gd@@parameter#1#2#3{%
  \pgfkeysdef{#1}{
    \pgfkeys{/graph drawing/conversions/#2=##1}%
    #3{#1}{\pgfgdresult}%
  }%
}



% In many cases, when you specify a graph parameter, you will not wish
% the "actual" setting of the key to be passed to the algorithm. For
% instance, suppose we write 
% 
%   /some path/width/.graph drawing graph parameter
% 
% Now we could write /some path/width=20pt+2pt, and inside the
% algorithm the parameter "width" would equal the string
% "20pt+2pt". However, inside the algorithm, it would be somewhat
% preferable to have access to the value "22" rather than the string
% "20pt+2pt". Similary, when the width is "1in", the algorithm will
% prefer to get passed the number "72.27" instead of "1in".
% 
% For this reason, when you define a graph drawing parameter, you can
% optionally specify a conversion that will be applied to the
% key's value before it is passed to the algorithm. To do so, 
% write
% 
% /some path/my key/.graph drawing graph parameter=conversion key
% 
% The conversion key will be executed with path prefix /graph
% drawing/conversions/. It gets passed the value that was
% assigned to the parameter key. It should store the "result" of the
% conversion in the macro \pgfgdresult. The contents of this macro is
% the text that will actually be passed down to the algorithm.
% 
% As an example, let us start with the default conversion: It simply
% stores its parameter as the result:
% 
% /graph drawing/conversions/no conversion/.code=\def\pgfgdresult{#1}
% 
% A more complicated example is the math conversion:
% 
% /graph drawing/conversions/math/.code=
%    \pgfmathparse{#1}\let\pgfgdresult\pgfmathresult

\pgfgdset{
  conversions/no conversion/.code=\def\pgfgdresult{#1},
  conversions/evaluate math expression/.code=\pgfmathparse{#1}\let\pgfgdresult\pgfmathresult
}





%
% This file defines the basic interactions between LUA and PGF
%

%
% This box is used for passing pgf elements to lua and vice versa 
%
% After the invocation of \pgfpositionnodelater the caller should copy the contents of 
% \box\pgfpositionnodelaterbox to another box register (for this refer to the manual).
%
\newbox\pgf@gd@box

% 
% Initialize the lua graph drawing environment
%
\directlua{
  local file = 'pgflibrarygraphdrawing-loader.lua'
  local format = 'tex'
  % Use either resolvers or kpse to locate files.
  if resolvers then
    dofile(assert(resolvers.find_file(file, format), "couldn't find file " .. file))
  else
    dofile(assert(kpse.find_file(file, format), "couldn't find file " .. file))
  end
  % set the box number for saving nodes by pgf
  pgf.graphdrawing.Sys:setBoxNumber(\the\pgf@gd@box)
}


%
% Adds an edge to the graph
%
% #1 left anchor
% #2 right anchor
%
% Usage
%   \pgfgdaddedge{node1}{node2}{direction}
%  or
%   \pgfgdaddedge[options]{node1}{node2}{direction}
%
% where options can be a combination of every possible tikz options (deprecated,
% options should be stored using the TikZ key mechanism)
%
% Example
%
%   \pgfgdaddedge{NodeFrom}{NodeTo}{->}
%
\def\pgfgdaddedge{%
  \pgfutil@ifnextchar[%
    {\pgf@gd@addedge}
    {\pgf@gd@addedge[]}
}

%
% Begins the ship out of nodes
%
\def\pgfgdbeginshipout{%
  \pgfscope
}

%
% End the shop out of nodes
%
\def\pgfgdendshipout{%
  \endpgfscope
}


%
% Enables the verbose logging of the graph drawing library
%
\def\pgfgdenableverboselogging{
  \pgf@gd@set@verbose@mode1%
}

%
% Disables the verbose logging of the graph drawing library
\def\pgfgddisableverboselogging{
  \pgf@gd@set@verbose@mode0%
}

%
% Prints a given message to the TeX output
%
% Note: logging must be enabled by \pgfgdenableverboselogging
%
% Example:
%
%  \pgfgdenableverboselogging
%  \pgfgdlogmessage{Hello world}
%
\def\pgfgdlogmessage#1{
  \pgf@gd@logmessage#1%
}

%
% INTERNAL MACROS
%-------------------------------------------------------------------------------
%

%
% This macro delays the node placement on the pgf layer
%
\def\pgf@gd@positionnodelater{%
  \pgf@gd@logmessage{GD:SYS: positionnodelater invoked}
  \pgfpositionnodelater{\pgf@gd@positionnode@callback}}

%
% Callback method for \pgf@gd@positionnodelater
% 
% Pipes the box which contains the nodes to lua.
% The called lua method then saves the data.
%
\def\pgf@gd@positionnode@callback{%
  \pgf@gd@logmessage{GD:SYS: positionnode callback invoked for box \the\pgf@gd@box}
  {%
    % save options to macro \pgf@gd@node@options
    \pgfkeysgetvalue{/tikz/graphs/graph drawing/@node@options}\pgf@gd@node@options
    % save pgfpositionnodelaterbox (see manual)
    \setbox\pgf@gd@box=\box\pgfpositionnodelaterbox\relax
    % call lua system library to create a lua node object
    \directlua{
      %% NOTE: options parameter has to be the key=value string
      pgf.graphdrawing.Interface:addNode(
        "\luaescapestring{\pgfpositionnodelatername}",
        "\luaescapestring{\pgfpositionnodelaterminx}",
        "\luaescapestring{\pgfpositionnodelaterminy}",
        "\luaescapestring{\pgfpositionnodelatermaxx}",
        "\luaescapestring{\pgfpositionnodelatermaxy}",
        "\luaescapestring{\pgf@gd@node@options}") }
    % clear node options
    \pgfkeyslet{/tikz/graphs/graph drawing/@options}\pgfutil@empty
  }%
}

%
% Shipout a node
%
% #1 = name of the node
% #2 = x min of the bounding box
% #3 = x max of the bounding box
% #4 = y min of the bounding box
% #5 = y max of the bounding box
% #6 = desired x pos of the node
% #7 = desired y pos of the node
% #8 = box register number of the TeX node
%
% This is an internal function and will be called by the Sys-class of the Lua part
%
% Example
%
%  \pgfgdinternalshipoutnode{not yet positionedPGFGDINTERNALnodename}{10}{10}{20}{20}{10pt}{10pt}0
% 
\def\pgfgdinternalshipoutnode#1#2#3#4#5#6#7#8{%
  {%
    \pgf@gd@logmessage{GD:TEX: positioning node #1 (#2,#3,#4,#5) to #6,#7 from register #8}\relax
    \def\pgfpositionnodelatername{#1}
    \def\pgfpositionnodelaterminx{#2}
    \def\pgfpositionnodelatermaxx{#3}
    \def\pgfpositionnodelaterminy{#4}
    \def\pgfpositionnodelatermaxy{#5}
    \setbox\pgf@gd@box=\box\pgfutil@voidb@x
    \directlua{
      texnode = pgf.graphdrawing.TeXBoxRegister:getBox(#8)
      assert(texnode,"GD:SYS:TEX: tex node was nil")
      tex.box[\the\pgf@gd@box] = texnode
    }
    \setbox\pgfpositionnodelaterbox=\box\pgf@gd@box
    \pgfpositionnodenow{\pgfqpoint{#6pt}{#7pt}}
  }%
}


%
% Adds an edge to the lua graph object
%
% #1 edge options
% #2 first node
% #3 second node
% #4 edge nodes (label nodes)
% #5 edge direction
%
\def\pgf@gd@addedge[#1]#2#3#4#5{%
  % grab TikZ keys related to graph drawing
  \pgfkeys{/pgf/graph drawing/edge options/.initial={}}%
  \pgfkeys{/pgf/graph drawing/edge options/grab/.cd,#1}%
  \pgfkeysgetvalue{/pgf/graph drawing/edge options}\pgf@gd@edge@options%
  % create edge in Lua
  \directlua{
    pgf.graphdrawing.Interface:addEdge("\luaescapestring{#2}","\luaescapestring{#3}","\luaescapestring{#5}","\luaescapestring{#4}","\luaescapestring{\pgf@gd@edge@options}","\luaescapestring{#1}")
  }}

%
% Strip unknown edge options and start with an empty list of key/value
% pairs to hand over to Lua when creating an edge.
%
\pgfkeys{
  /pgf/graph drawing/edge options/grab/.unknown/.code={},
  /pgf/graph drawing/edge options/.initial={}
}

%
% LOGGING
% ------------------------------------------------------------------------------
%

%
% New if for debugging mode
%
\newif\ifpgf@gd@verbose

% 
% Set verbose debugging mode
%
% #1 should be zero (0) or one (1) for false and true
%
\def\pgf@gd@set@verbose@mode#1{
  \ifodd#1
    \directlua{ pgf.graphdrawing.Sys:setVerboseMode(true) }
    \pgf@gd@verbosetrue
  \else
    \directlua{ pgf.graphdrawing.Sys:setVerboseMode(false) }
    \pgf@gd@verbosefalse
  \fi
}

%
% Logs a message to the console (tex output, log file)
%
% #1 string to print out to console
%
\def\pgf@gd@logmessage#1{\ifpgf@gd@verbose\directlua{ texio.write_nl("\luaescapestring{#1}") }\fi}
